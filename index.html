

<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SEÃ‘OR AREPA</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/exceljs/dist/exceljs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
</head>

<body class="bg-yellow-50 font-sans">

  <!-- NavegaciÃ³n -->
  <nav class="bg-yellow-400 p-4 flex justify-between items-center text-white font-bold text-lg">
    <div class="flex items-center space-x-2">
      <img src="imagenes/seÃ±ora.png" alt="Logo SeÃ±or Arepa" class="w-20 h-20 rounded-full">
      <span class="text-xl">SEÃ‘OR AREPA</span>
    </div>
    <div class="flex items-center gap-3">
      <a href="finanzas1.html" class="bg-white text-yellow-700 font-semibold px-3 py-1 rounded-lg shadow hover:bg-yellow-100 transition" target="_blank">
        ğŸ“‹ Finanzas
      </a>
      <a href="inventario.html" class="bg-yellow-600 text-white font-semibold px-3 py-1 rounded-lg shadow hover:bg-yellow-700 transition" target="_blank">
        ğŸ“† Inventario
      </a>
      <span id="baseBadge" class="hidden md:inline text-sm bg-teal-600/80 px-2 py-1 rounded"></span>
      <span id="currentUserBadge" class="hidden md:inline text-sm bg-yellow-700/80 px-2 py-1 rounded"></span>
      <button id="btnLogout" onclick="logout()" class="hidden bg-yellow-700 text-white px-3 py-1 rounded">Salir</button>
    </div>
  </nav>

  <!-- SecciÃ³n Productos -->
  <main class="p-6">
    <h2 class="text-2xl font-bold text-gray-700 mb-4">MenÃº</h2>
    <div id="productos" class="grid grid-cols-1 md:grid-cols-3 gap-4">
      <!-- Comida -->
      <div class="bg-white p-4 rounded-xl shadow-md">
        <h3 class="text-xl font-semibold text-yellow-600 mb-2">Comida</h3>
        <div class="grid grid-cols-2 gap-2">
          <button onclick="agregarProducto('AREPA PAISA', 17000)" class="bg-yellow-300 hover:bg-yellow-400 p-2 rounded">âšª PAISA - $17.000</button>
          <button onclick="agregarProducto('AREPA PAISA POLLO', 17000)" class="bg-yellow-300 hover:bg-yellow-400 p-2 rounded">âšª PAISA POLLO - $17.000</button>
          <button onclick="agregarProducto('AREPA CHICHARRON', 14000)" class="bg-yellow-300 hover:bg-yellow-400 p-2 rounded">âšª CHICHARRON - $14.000</button>
          <button onclick="agregarProducto('AREPA EXTRA QUESILLO', 9000)" class="bg-yellow-300 hover:bg-yellow-400 p-2 rounded">âšª EXTRA QUESILLO - $9.000</button>
          <button onclick="agregarProducto('AREPA SEÃ‘OR AREPA', 14000)" class="bg-yellow-300 hover:bg-yellow-400 p-2 rounded">âšª SEÃ‘OR AREPA - $14.000</button>
          <button onclick="agregarProducto('AREPA SEÃ‘ORA AREPA', 14000)" class="bg-yellow-300 hover:bg-yellow-400 p-2 rounded">âšª SEÃ‘ORA AREPA - $14.000</button>
          <button onclick="agregarProducto('AREPA HAWAIANA', 14000)" class="bg-yellow-300 hover:bg-yellow-400 p-2 rounded">âšª HAWAIANA - $14.000</button>
          <button onclick="agregarProducto('AREPA MEGAPAISA', 22000)" class="bg-yellow-300 hover:bg-yellow-400 p-2 rounded">âšª MEGAPAISA- $22.000</button>
          <button onclick="agregarProducto('AREPA MIXTA', 14000)" class="bg-yellow-300 hover:bg-yellow-400 p-2 rounded">âšª MIXTA - $14.000</button>
          <button onclick="agregarProducto('AREPA RANCHERA', 14000)" class="bg-yellow-300 hover:bg-yellow-400 p-2 rounded">âšª RANCHERA - $14.000</button>
          <button onclick="agregarProducto('AREPA SOLO POLLO', 15000)" class="bg-yellow-300 hover:bg-yellow-400 p-2 rounded">âšª SOLO POLLO - $15.000</button>
          <button onclick="agregarProducto('AREPA SOLO CARNE', 15000)" class="bg-yellow-300 hover:bg-yellow-400 p-2 rounded">âšª SOLO CARNE - $15.000</button>
          <button onclick="agregarProducto('AREPA MEXICANA', 15000)" class="bg-yellow-300 hover:bg-yellow-400 p-2 rounded">âšª MEXICANA - $15.000</button>
          <button onclick="agregarProducto('AREPA SOLA', 1000)" class="bg-yellow-300 hover:bg-yellow-400 p-2 rounded">âšª AREPA SOLA - $1.000</button> 
        </div>
      </div>

      <!-- Adiciones -->
      <div class="bg-white p-4 rounded-xl shadow-md">
        <h3 class="text-xl font-semibold text-yellow-600 mb-2">Adiciones</h3>
        <div class="grid grid-cols-2 gap-2">
          <button onclick="agregarProducto('ADICION QUESO EXTRA', 5000)" class="bg-yellow-300 hover:bg-yellow-400 p-2 rounded">ğŸ§€ Queso Extra - $5.000</button>
          <button onclick="agregarProducto('ADICION MAIZ TIERNO', 3000)" class="bg-yellow-300 hover:bg-yellow-400 p-2 rounded">ğŸŒ½ MAIZ TIERNO - $3.000</button>
          <button onclick="agregarProducto('ADICION PIÃ‘A CALADA', 5000)" class="bg-yellow-300 hover:bg-yellow-400 p-2 rounded">ğŸ PIÃ‘A CALADA - $5.000</button>
          <button onclick="agregarProducto('ADICION POLLO', 7000)" class="bg-yellow-300 hover:bg-yellow-400 p-2 rounded">ğŸ— POLLO - $7.000</button>
          <button onclick="agregarProducto('ADICION CARNE', 7000)" class="bg-yellow-300 hover:bg-yellow-400 p-2 rounded">ğŸ¥© CARNE - $7.000</button>
          <button onclick="agregarProducto('ADICION CHICHARRON', 6000)" class="bg-yellow-300 hover:bg-yellow-400 p-2 rounded">ğŸ– CHICHARRON - $6.000</button>
          <button onclick="agregarProducto('ADICION RANCHERA', 7000)" class="bg-yellow-300 hover:bg-yellow-400 p-2 rounded">ğŸ”¥ RANCHERA - $7.000</button>
          <button onclick="agregarProducto('ADICION CHORIZO', 7000)" class="bg-yellow-300 hover:bg-yellow-400 p-2 rounded">ğŸŒ­ CHORIZO - $7.000</button>
          <button onclick="agregarProducto('ADICION TOCINETA', 7000)" class="bg-yellow-300 hover:bg-yellow-400 p-2 rounded">ğŸ¥“ TOCINETA - $7.000</button>
          <button onclick="agregarProducto('ADICION MADURO', 3000)" class="bg-yellow-300 hover:bg-yellow-400 p-2 rounded">ğŸŒ  MADURO - $3.000</button>
          <button onclick="agregarProducto('ADICION ARMA TU AREPA X5', 25000)" class="bg-yellow-300 hover:bg-yellow-400 p-2 rounded">ğŸŒ ARMA TU AREPA - $25.000</button>
        </div>
      </div>

      <!-- Bebidas -->
      <div class="bg-white p-4 rounded-xl shadow-md">
        <h3 class="text-xl font-semibold text-yellow-600 mb-2">Bebidas</h3>
        <div class="grid grid-cols-2 gap-2">
          <button onclick="agregarProducto('QUATRO', 4000)" class="bg-yellow-300 hover:bg-yellow-400 p-2 rounded">ğŸ‹ QUATRO - $4.000</button>
          <button onclick="agregarProducto('COCA COLA 400 ml', 4000)" class="bg-yellow-300 hover:bg-yellow-400 p-2 rounded">ğŸ¥¤ COCA COLA - $4.000</button>
          <button onclick="agregarProducto('COCA COLA 250 ml', 3000)" class="bg-yellow-300 hover:bg-yellow-400 p-2 rounded">ğŸ¥¤ COCA COLA - $3.000</button>
          <button onclick="agregarProducto('JUGO HIT 500 ml', 4000)" class="bg-yellow-300 hover:bg-yellow-400 p-2 rounded">ğŸ¥¤ JUGO HIT - $4.000</button>
          <button onclick="agregarProducto('SPRITE', 4000)" class="bg-yellow-300 hover:bg-yellow-400 p-2 rounded">ğŸ¥¤ SPRITE - $4.000</button>
          <button onclick="agregarProducto('COCA COLA CERO', 4000)" class="bg-yellow-300 hover:bg-yellow-400 p-2 rounded">ğŸ¥¤ COCA COLA CERO - $4.000</button>
          <button onclick="agregarProducto('BRISA LIMON', 4000)" class="bg-yellow-300 hover:bg-yellow-400 p-2 rounded">ğŸ¥¤ BRISA LIMON - $4.000</button>
          <button onclick="agregarProducto('BRISA MANZANA', 4000)" class="bg-yellow-300 hover:bg-yellow-400 p-2 rounded">ğŸ’§ BRISA MANZANA - $4.000</button>
          <button onclick="agregarProducto('MISTER TEA', 4000)" class="bg-yellow-300 hover:bg-yellow-400 p-2 rounded">ğŸ¥¤ MISTER TEA - $4.000</button>
          <button onclick="agregarProducto('AGUA CON GAS', 4000)" class="bg-yellow-300 hover:bg-yellow-400 p-2 rounded">ğŸ¥¤ AGUA CON GAS - $4.000</button>
          <button onclick="agregarProducto('AGUA SABORISADA', 4000)" class="bg-yellow-300 hover:bg-yellow-400 p-2 rounded">ğŸ¥¤ AGUA SABORISADA - $4.000</button>
          <button onclick="agregarProducto('POSTOBON 400 ml', 4000)" class="bg-yellow-300 hover:bg-yellow-400 p-2 rounded">ğŸ¥¤ POSTOBON 400 - $4.000</button>
          <button onclick="agregarProducto('POSTOBON 250 ml', 3000)" class="bg-yellow-300 hover:bg-yellow-400 p-2 rounded">ğŸ¥¤ POSTOBON 250 - $3.000</button>
          <button onclick="agregarProducto('POSTOBON 1.5', 9000)" class="bg-yellow-300 hover:bg-yellow-400 p-2 rounded">ğŸ¥¤ POSTOBON 1.5 - $9.000</button>
          <button onclick="agregarProducto('SODA BRETAÃ‘A', 4500)" class="bg-yellow-300 hover:bg-yellow-400 p-2 rounded">ğŸ¥¤ SODA BRETAÃ‘A - $4.500</button>
          <button onclick="agregarProducto('GATORADE', 6000)" class="bg-yellow-300 hover:bg-yellow-400 p-2 rounded">ğŸ¥¤ GATORADE - $6.000</button>
          <button onclick="agregarProducto('PREMIO 400 ml', 4000)" class="bg-yellow-300 hover:bg-yellow-400 p-2 rounded">ğŸ¥¤ PREMIO 400 ml - $4.000</button>
          <button onclick="agregarProducto('PREMIO 1.5l', 9000)" class="bg-yellow-300 hover:bg-yellow-400 p-2 rounded">ğŸ¥¤ PREMIO 1.5l - $9.000</button>
          <button onclick="agregarProducto('QUATRO 1.5L', 9000)" class="bg-yellow-300 hover:bg-yellow-400 p-2 rounded">ğŸ¥¤ QUATRO 1.5L - $9.000</button>
          <button onclick="agregarProducto('COCA COLA 1.5L', 9000)" class="bg-yellow-300 hover:bg-yellow-400 p-2 rounded">ğŸ¥¤ COCA COLA  1.5L - $9.000</button>
          <button onclick="agregarProducto('JUGO HIT 1.L', 7500)" class="bg-yellow-300 hover:bg-yellow-400 p-2 rounded">ğŸ¥¤ JUGO HIT 1.L - $7.500</button>
          <button onclick="agregarProducto('SPRITE 1.5L', 9000)" class="bg-yellow-300 hover:bg-yellow-400 p-2 rounded">ğŸ¥¤ SPRITE 1.5L - $9.000</button>
          <button onclick="agregarProducto('COCA COLA ZERO 1.5L', 9000)" class="bg-yellow-300 hover:bg-yellow-400 p-2 rounded">ğŸ¥¤ COCA COLA ZERO 1.5L - $9.000</button>
          <button onclick="agregarProducto(' AGUA', 3000)" class="bg-yellow-300 hover:bg-yellow-400 p-2 rounded">ğŸ¥¤ AGUA - $3.000</button>
          <button onclick="agregarProducto('MILO CALIENTE', 6000)" class="bg-yellow-300 hover:bg-yellow-400 p-2 rounded">ğŸ¥› MILO CALIENTE - $6.000</button>
          <button onclick="agregarProducto('CAFE CON LECHE', 5000)" class="bg-yellow-300 hover:bg-yellow-400 p-2 rounded">â˜•ğŸ¥› CAFE CON LECHE - $5.000</button>
          <button onclick="agregarProducto('TINTO', 4000)" class="bg-yellow-300 hover:bg-yellow-400 p-2 rounded">â˜• TINTO - $4.000</button>
          <button onclick="agregarProducto('CERVEZA', 6000)" class="bg-yellow-300 hover:bg-yellow-400 p-2 rounded">ğŸº CERVEZA - $6.000</button>
        </div>
      </div>
    </div>

    <!-- Detalle de Pedido -->
    <div class="mt-6 bg-white p-4 rounded-xl shadow-md">
      <h3 class="text-lg font-semibold mb-4 border-b pb-2">ğŸ›’ Pedido Actual</h3>
      <ul id="listaPedido" class="list-disc pl-5 text-gray-700 space-y-1"></ul>
      <p id="total" class="mt-4 font-bold text-lg text-gray-800">Total: $0</p>
    </div>

    <!-- Cliente y forma de pago -->
    <div class="mt-4 flex flex-col md:flex-row gap-4">
      <input type="text" id="cliente" placeholder="Nombre del Cliente" class="flex-1 p-2 border border-yellow-300 rounded" />
      <input type="text" id="observaciones" placeholder="Observaciones (Ej: Sin cebolla, agregar salsas, etc.)" class="flex-1 p-2 border border-yellow-300 rounded" />
      <select id="formaPago" class="flex-1 p-2 border border-yellow-300 rounded" onchange="toggleEfectivoSection()">
        <option value="">Seleccione forma de pago</option>
        <option value="Efectivo">Efectivo</option>
        <option value="Tarjeta">Tarjeta</option>
        <option value="Transferencia">Transferencia</option>
        <option value="Nequi/Daviplata">Nequi/Daviplata</option>
      </select>
    </div>

    <!-- Tipo de pedido -->
    <div class="mt-4">
      <label for="tipoPedido" class="block text-sm font-medium text-gray-700">Tipo de Pedido</label>
      <select id="tipoPedido" class="mt-1 p-2 border rounded w-full">
        <option value="">Selecciona</option>
        <option value="AquÃ­">AquÃ­</option>
        <option value="Para llevar">Para llevar</option>
        <option value="Domicilio">Domicilio</option>
      </select>
    </div>

    <!-- Efectivo recibido (solo cuando es Efectivo) -->
    <div id="efectivoSection" class="mt-6 bg-white p-4 rounded-xl shadow-md hidden">
      <h3 class="text-lg font-semibold mb-2">ğŸ’µ Efectivo recibido</h3>
      <div class="grid grid-cols-2 md:grid-cols-4 gap-2">
        <label>100.000 <input id="ef_100000" type="number" min="0" value="0" class="p-1 border rounded w-full" oninput="capturarEfectivoRecibido()"></label>
        <label>50.000  <input id="ef_50000"  type="number" min="0" value="0" class="p-1 border rounded w-full" oninput="capturarEfectivoRecibido()"></label>
        <label>20.000  <input id="ef_20000"  type="number" min="0" value="0" class="p-1 border rounded w-full" oninput="capturarEfectivoRecibido()"></label>
        <label>10.000  <input id="ef_10000"  type="number" min="0" value="0" class="p-1 border rounded w-full" oninput="capturarEfectivoRecibido()"></label>
        <label>5.000   <input id="ef_5000"   type="number" min="0" value="0" class="p-1 border rounded w-full" oninput="capturarEfectivoRecibido()"></label>
        <label>2.000   <input id="ef_2000"   type="number" min="0" value="0" class="p-1 border rounded w-full" oninput="capturarEfectivoRecibido()"></label>
        <label>1.000   <input id="ef_1000"   type="number" min="0" value="0" class="p-1 border rounded w-full" oninput="capturarEfectivoRecibido()"></label>
        <label>500     <input id="ef_500"    type="number" min="0" value="0" class="p-1 border rounded w-full" oninput="capturarEfectivoRecibido()"></label>
        <label>200     <input id="ef_200"    type="number" min="0" value="0" class="p-1 border rounded w-full" oninput="capturarEfectivoRecibido()"></label>
        <label>100     <input id="ef_100"    type="number" min="0" value="0" class="p-1 border rounded w-full" oninput="capturarEfectivoRecibido()"></label>
        <label>50      <input id="ef_50"     type="number" min="0" value="0" class="p-1 border rounded w-full" oninput="capturarEfectivoRecibido()"></label>
        <label>20      <input id="ef_20"     type="number" min="0" value="0" class="p-1 border rounded w-full" oninput="capturarEfectivoRecibido()"></label>
      </div>
      <p id="ef_total" class="mt-2 text-sm text-gray-600"></p>
    </div>

    <!-- Botones de acciÃ³n -->
    <div class="mt-6 flex flex-wrap gap-2">
      <button id="btnGuardarVenta" onclick="guardarVenta()" class="bg-green-500 hover:bg-green-600 text-white p-2 rounded">ğŸ’¾ Guardar Venta</button>
      <button id="btnImprimirCocina" onclick="imprimirUltimaCocinero()" class="bg-blue-500 hover:bg-blue-600 text-white p-2 rounded">ğŸ–¨ï¸ Imprimir para Cocina</button>
      <button id="btnImprimirCliente" onclick="imprimirUltimaCliente()" class="bg-purple-500 hover:bg-purple-600 text-white p-2 rounded">ğŸ§¾ Imprimir Recibo Cliente</button>
      <button id="btnBaseCaja" onclick="abrirModalBaseCaja()" class="bg-teal-600 hover:bg-teal-700 text-white p-2 rounded">ğŸ“¦ Base de Caja</button>
      <button id="btnExportarExcel" onclick="exportarVentasExcelConEstilo()" class="bg-green-600 hover:bg-green-700 text-white p-2 rounded">ğŸ“Š Exportar Ventas a Excel</button>
      <button id="btnBorrarVentas" onclick="borrarVentas()" class="bg-red-500 hover:bg-red-600 text-white p-2 rounded">ğŸ—‘ï¸ Borrar Ventas</button>
      <button id="btnResumenProductos" onclick="generarResumenProductos()" class="bg-indigo-500 hover:bg-indigo-600 text-white p-2 rounded">ğŸ“Š Ver Resumen Productos</button>
      <button id="btnCierreCaja" onclick="cierreDeCaja()" class="bg-amber-600 hover:bg-amber-700 text-white p-2 rounded">ğŸ’° Cierre de Caja</button>
    </div>

    <!-- VisualizaciÃ³n de Ventas Guardadas (ambos roles, con acciones segÃºn rol) -->
    <div id="ventasSeccion" class="mt-8 bg-white p-4 rounded-xl shadow-md">
      <h3 class="text-lg font-semibold mb-2">Ventas Guardadas</h3>
      <div class="mb-4">
        <input type="text" id="filtroCliente" oninput="filtrarVentasPorCliente()" placeholder="ğŸ” Filtrar por cliente..." class="w-full md:w-1/3 p-2 border border-yellow-300 rounded" />
      </div>
      <table class="min-w-full text-left border">
        <thead>
          <tr class="bg-yellow-200">
            <th class="p-2 border">#</th>
            <th class="p-2 border">Fecha</th>
            <th class="p-2 border">Cliente</th>
            <th class="p-2 border">Forma de Pago</th>
            <th class="p-2 border">Tipo de Pedido</th>
            <th class="p-2 border">Productos</th>
            <th class="p-2 border">Total</th>
            <th id="thAcciones" class="p-2 border">Acciones</th>
          </tr>
        </thead>
        <tbody id="ventasGuardadas" class="text-sm text-gray-800"></tbody>
      </table>
    </div>

    <!-- Resumen Productos (solo admin) -->
    <div id="resumenProductos" class="mt-8 bg-white p-4 rounded-xl shadow-md hidden">
      <h3 class="text-lg font-semibold mb-2">Resumen de Productos Vendidos</h3>
      <ul id="listaResumen" class="list-disc pl-5 text-gray-700 space-y-1"></ul>
    </div>

    <!-- GestiÃ³n de Usuarios (solo admin) -->
    <div id="adminUsuariosSection" class="hidden mt-8 bg-white p-4 rounded-xl shadow-md">
      <h3 class="text-lg font-semibold mb-2">GestiÃ³n de Usuarios</h3>
      <form onsubmit="return addUserFromForm(event)" class="grid grid-cols-1 md:grid-cols-4 gap-2 mb-3">
        <input id="newUsername" class="p-2 border rounded" placeholder="Usuario" required>
        <input id="newPassword" type="password" class="p-2 border rounded" placeholder="ContraseÃ±a" required>
        <select id="newRole" class="p-2 border rounded">
          <option value="cajero">Cajero</option>
          <option value="admin">Admin</option>
        </select>
        <button class="bg-green-600 hover:bg-green-700 text-white px-3 py-2 rounded">â• Agregar</button>
      </form>
      <table class="min-w-full text-left border">
        <thead>
          <tr class="bg-yellow-200">
            <th class="p-2 border">Usuario</th>
            <th class="p-2 border">Rol</th>
            <th class="p-2 border">Acciones</th>
          </tr>
        </thead>
        <tbody id="usuariosTbody"></tbody>
      </table>
    </div>
  </main>

  <!-- MODAL: Registrar Vuelto -->
  <div id="modalVuelto" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
    <div class="bg-white rounded-lg p-6 w-96">
      <h2 class="text-xl font-bold mb-4">Registrar Vuelto</h2>
      <p id="vueltoRequeridoTexto" class="text-sm text-gray-700 mb-3"></p>
      <table class="w-full text-left mb-4">
        <thead>
          <tr>
            <th class="py-1">DenominaciÃ³n</th>
            <th class="py-1">Cantidad</th>
          </tr>
        </thead>
        <tbody id="tablaVuelto"></tbody>
      </table>
      <div class="flex gap-2 justify-end">
        <button onclick="confirmarVuelto()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded">Confirmar</button>
        <button onclick="cerrarModalVuelto()" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded">Cancelar</button>
      </div>
    </div>
  </div>

  <!-- MODAL: Base de Caja -->
  <div id="modalBaseCaja" class="fixed inset-0 bg-black/50 z-50 hidden items-center justify-center">
    <div class="bg-white rounded-lg p-6 w-96">
      <h2 class="text-xl font-bold mb-2">ğŸ“¦ Base de Caja (Hoy)</h2>
      <p class="text-sm text-gray-600 mb-3">Ingresa la cantidad de billetes y monedas iniciales.</p>
      <table class="w-full text-left mb-3">
        <thead>
          <tr>
            <th class="py-1">DenominaciÃ³n</th>
            <th class="py-1">Cantidad</th>
          </tr>
        </thead>
        <tbody id="tablaBaseCaja"></tbody>
      </table>
      <p id="baseTotalTexto" class="text-sm text-gray-700 mb-3"></p>
      <div class="flex gap-2 justify-end">
        <button id="btnGuardarBase" onclick="confirmarBaseCaja()" class="bg-teal-600 hover:bg-teal-700 text-white px-4 py-2 rounded">Guardar</button>
        <button onclick="cerrarModalBaseCaja()" class="bg-gray-400 hover:bg-gray-500 text-white px-4 py-2 rounded">Cerrar</button>
      </div>
      <p id="baseMetaInfo" class="text-xs text-gray-500 mt-3"></p>
    </div>
  </div>

  <!-- MODAL: Login -->
  <div id="loginModal" class="fixed inset-0 bg-black/50 z-50 hidden items-center justify-center">
    <div class="bg-white rounded-lg p-6 w-96">
      <h2 class="text-xl font-bold mb-4">Iniciar sesiÃ³n</h2>
      <form onsubmit="return loginFromModal(event)" class="space-y-3">
        <input id="loginUser" class="p-2 border rounded w-full" placeholder="Usuario" required>
        <input id="loginPass" type="password" class="p-2 border rounded w-full" placeholder="ContraseÃ±a" required>
        <button class="w-full bg-yellow-600 hover:bg-yellow-700 text-white px-4 py-2 rounded">Entrar</button>
      </form>
      <p class="text-xs text-gray-500 mt-3">Primer uso: admin / admin123</p>
    </div>
  </div>

  <script>
  /**********  CONSTANTES & ESTADO  **********/
  const DENOMS = ["100000","50000","20000","10000","5000","2000","1000","500","200","100","50","20"];
  let pedido = [];
  let total = 0;
  let comandaEnEdicion = null;
  let ventaTemporal = null;

  /**********  AUTH & ROLES (localStorage)  **********/
  function ensureUsersInit() {
    const users = JSON.parse(localStorage.getItem('users') || '[]');
    if (users.length === 0) {
      const defaultAdmin = { username: 'admin', role: 'admin', password: 'admin123' };
      localStorage.setItem('users', JSON.stringify([defaultAdmin]));
    }
  }
  function getUsers(){ return JSON.parse(localStorage.getItem('users') || '[]'); }
  function setUsers(arr){ localStorage.setItem('users', JSON.stringify(arr)); renderUsersTable(); }
  function getSessionUser(){ return JSON.parse(localStorage.getItem('sessionUser') || 'null'); }
  function setSessionUser(user){ localStorage.setItem('sessionUser', JSON.stringify(user)); }
  function isAdmin(){ return getSessionUser()?.role === 'admin'; }

  function showLoginModal(){ const m = document.getElementById('loginModal'); m.classList.remove('hidden'); m.classList.add('flex'); }
  function hideLoginModal(){ const m = document.getElementById('loginModal'); m.classList.add('hidden'); m.classList.remove('flex'); }

  function loginFromModal(e){
    e.preventDefault();
    const u = document.getElementById('loginUser').value.trim();
    const p = document.getElementById('loginPass').value;
    const users = getUsers();
    const found = users.find(x => x.username === u && x.password === p);
    if(!found){ alert("Usuario o contraseÃ±a incorrectos."); return false; }
    setSessionUser({ username: found.username, role: found.role });
    hideLoginModal();
    applyRoleUI();
    mostrarVentas();
    autoPromptBaseIfMissing();
    return false;
  }
  function logout(){
    localStorage.removeItem('sessionUser');
    applyRoleUI();
    showLoginModal();
  }

  function addUserFromForm(e){
    e.preventDefault();
    if(!isAdmin()){ alert("Solo el Administrador puede gestionar usuarios."); return false; }
    const username = document.getElementById('newUsername').value.trim();
    const password = document.getElementById('newPassword').value;
    const role     = document.getElementById('newRole').value;
    if(!username || !password) { alert("Usuario y contraseÃ±a requeridos."); return false; }
    const users = getUsers();
    if(users.find(u => u.username === username)){ alert("Ese usuario ya existe."); return false; }
    users.push({ username, role, password });
    setUsers(users);
    document.getElementById('newUsername').value = "";
    document.getElementById('newPassword').value = "";
    document.getElementById('newRole').value = "cajero";
    alert("Usuario agregado.");
    return false;
  }
  function deleteUser(username){
    if(!isAdmin()){ alert("Solo el Administrador puede eliminar usuarios."); return; }
    const users = getUsers();
    const me = getSessionUser();
    if(me && me.username === username){ alert("No puedes eliminar tu propia cuenta mientras estÃ¡s conectado."); return; }
    const admins = users.filter(u => u.role === 'admin');
    const target = users.find(u => u.username === username);
    if(target?.role === 'admin' && admins.length <= 1){ alert("Debe existir al menos un administrador."); return; }
    const filtered = users.filter(u => u.username !== username);
    setUsers(filtered);
    alert("Usuario eliminado.");
  }
  function renderUsersTable(){
    const tbody = document.getElementById('usuariosTbody');
    if(!tbody) return;
    const users = getUsers();
    tbody.innerHTML = users.map(u => `
      <tr>
        <td class="p-2 border">${u.username}</td>
        <td class="p-2 border">${u.role}</td>
        <td class="p-2 border">
          <button onclick="deleteUser('${u.username.replace(/'/g,"\\'")}')" class="bg-red-600 text-white px-2 py-1 rounded text-xs">Eliminar</button>
        </td>
      </tr>
    `).join("");
  }

  function toggleDisplay(id, show){
    const el = document.getElementById(id);
    if(!el) return;
    if(show) el.classList.remove('hidden');
    else el.classList.add('hidden');
  }

  function applyRoleUI(){
    const badge = document.getElementById('currentUserBadge');
    const baseBadge = document.getElementById('baseBadge');
    const btnLogout = document.getElementById('btnLogout');
    const user = getSessionUser();

    if(user){
      badge.textContent = `${user.username} (${user.role})`;
      badge.classList.remove('hidden');
      btnLogout.classList.remove('hidden');
      hideLoginModal();
    }else{
      badge.classList.add('hidden');
      btnLogout.classList.add('hidden');
    }

    const admin = isAdmin();

    // Ventas guardadas visible para ambos
    toggleDisplay('ventasSeccion', true);

    // Secciones solo admin
    toggleDisplay('resumenProductos', admin);
    toggleDisplay('adminUsuariosSection', admin);
    toggleDisplay('btnExportarExcel', admin);
    toggleDisplay('btnBorrarVentas', admin);
    toggleDisplay('btnResumenProductos', admin);

    // Cierre de caja y base visibles para ambos
    toggleDisplay('btnCierreCaja', true);
    toggleDisplay('btnBaseCaja', true);

    // Encabezado de Acciones siempre visible (cajero imprime, admin imprime/edita)
    const thAcc = document.getElementById('thAcciones');
    if (thAcc) thAcc.classList.remove('hidden');

    // Efectivo visible segÃºn forma de pago
    toggleEfectivoSection();

    // Badge de base
    updateBaseBadge();
  }

  /**********  UTILIDADES DE FECHA **********/
  function todayStr(){
    const d = new Date();
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,'0');
    const day = String(d.getDate()).padStart(2,'0');
    return `${y}-${m}-${day}`;
  }

  /**********  BASE DE CAJA **********/
  function getBaseCaja() {
    const data = JSON.parse(localStorage.getItem('baseCaja') || 'null');
    if(!data) return null;
    if(data.fecha !== todayStr()) return null;
    return data;
  }
  function setBaseCaja(counts) {
    let monto = 0;
    DENOMS.forEach(d => { monto += (counts[d] || 0) * parseInt(d,10); });
    const user = getSessionUser();
    const payload = {
      fecha: todayStr(),
      counts,
      monto,
      usuario: user?.username || 'N/A',
      hora: new Date().toLocaleString()
    };
    localStorage.setItem('baseCaja', JSON.stringify(payload));
    updateBaseBadge();
  }
  function updateBaseBadge(){
    const base = getBaseCaja();
    const el = document.getElementById('baseBadge');
    if(!el) return;
    if(base){
      el.textContent = `Base hoy: $${base.monto.toLocaleString('es-CO')} (${base.usuario})`;
      el.classList.remove('hidden');
    }else{
      el.textContent = `Base no registrada`;
      el.classList.remove('hidden');
    }
  }
  function autoPromptBaseIfMissing(){
    if(!getBaseCaja()){ abrirModalBaseCaja(true); } // true => apertura automÃ¡tica (informativo)
  }

  function abrirModalBaseCaja(auto=false){
    const tbody = document.getElementById('tablaBaseCaja');
    tbody.innerHTML = "";
    const base = getBaseCaja();
    const admin = isAdmin();

    // Construir filas
    DENOMS.forEach(d=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td class="py-1">${parseInt(d,10).toLocaleString('es-CO')} COP</td>
        <td class="py-1">
          <input id="base_${d}" type="number" min="0" value="0" class="p-1 border rounded w-full">
        </td>`;
      tbody.appendChild(tr);
    });

    // Prefill si existe base
    if(base){
      DENOMS.forEach(d=>{
        const el = document.getElementById(`base_${d}`);
        if(el) el.value = base.counts[d] || 0;
      });
    }

    // Modo lectura para cajero si ya existe
    const readOnly = !!base && !admin;
    DENOMS.forEach(d=>{
      const el = document.getElementById(`base_${d}`);
      if(el) el.disabled = readOnly;
    });

    // Texto total y metainfo
    recalcularBaseTotalTexto();
    const meta = document.getElementById('baseMetaInfo');
    if(base){
      meta.textContent = `Registrada por ${base.usuario} a las ${base.hora}.`;
    }else{
      meta.textContent = `No hay base registrada para hoy (${todayStr()}).`;
    }

    // BotÃ³n guardar visible solo si:
    // - no existe base (cualquier rol puede guardar)
    // - existe base y es admin (puede actualizar)
    const btn = document.getElementById('btnGuardarBase');
    if(!base || admin){
      btn.classList.remove('hidden');
      btn.textContent = base ? 'Actualizar' : 'Guardar';
      btn.disabled = false;
    }else{
      btn.classList.add('hidden');
    }

    const m = document.getElementById("modalBaseCaja");
    m.classList.remove('hidden'); m.classList.add('flex');
  }
  function cerrarModalBaseCaja(){
    const m = document.getElementById("modalBaseCaja");
    m.classList.add('hidden'); m.classList.remove('flex');
  }
  function recalcularBaseTotalTexto(){
    let total = 0;
    DENOMS.forEach(d=>{
      const el = document.getElementById(`base_${d}`);
      const c = parseInt(el?.value || "0",10) || 0;
      total += c * parseInt(d,10);
    });
    document.getElementById('baseTotalTexto').textContent = `Total base: $${total.toLocaleString('es-CO')}`;
  }
  // Recalc en vivo
  document.addEventListener('input', (e)=>{
    if(e.target && e.target.id && e.target.id.startsWith('base_')){
      recalcularBaseTotalTexto();
    }
  });
  function confirmarBaseCaja(){
    const counts = {};
    DENOMS.forEach(d=>{
      const c = parseInt(document.getElementById(`base_${d}`)?.value || "0",10) || 0;
      counts[d] = c;
    });
    setBaseCaja(counts);
    alert("Base de caja guardada.");
    cerrarModalBaseCaja();
  }

  /**********  PEDIDOS **********/
  function agregarProducto(nombre, precio) {
    pedido.push({ nombre, precio });
    actualizarTotal();
    actualizarVistaPedido();
  }
  function quitarProducto(index) {
    if (index >= 0 && index < pedido.length) {
      pedido.splice(index, 1);
      actualizarTotal();
      actualizarVistaPedido();
    }
  }
  function actualizarTotal() { total = pedido.reduce((acc, p) => acc + p.precio, 0); }
  function actualizarVistaPedido() {
    const lista = document.getElementById("listaPedido");
    lista.innerHTML = "";
    pedido.forEach((p, i) => {
      const li = document.createElement("li");
      li.innerHTML = `${p.nombre} - $${p.precio.toLocaleString('es-CO')} <button onclick="quitarProducto(${i})" class='text-red-600 ml-2'>âŒ</button>`;
      lista.appendChild(li);
    });
    document.getElementById("total").textContent = `Total: $${total.toLocaleString('es-CO')}`;
  }
  function toggleEfectivoSection(){
    const forma = document.getElementById("formaPago").value;
    const sec = document.getElementById("efectivoSection");
    if(forma === "Efectivo") sec.classList.remove('hidden');
    else sec.classList.add('hidden');
  }
  function capturarEfectivoRecibido() {
    const recibidos = {};
    let totalRecibido = 0;
    DENOMS.forEach(d => {
      const val = parseInt(document.getElementById(`ef_${d}`)?.value || "0", 10) || 0;
      recibidos[d] = val;
      totalRecibido += val * parseInt(d, 10);
    });
    const el = document.getElementById("ef_total");
    if(el) el.textContent = `Efectivo ingresado: $${totalRecibido.toLocaleString('es-CO')}`;
    return { recibidos, totalRecibido };
  }
  function limpiarPedido() {
    pedido = []; total = 0; actualizarVistaPedido();
    ["cliente","formaPago","tipoPedido","observaciones"].forEach(id => { const el = document.getElementById(id); if(el) el.value = ""; });
    const eftxt = document.getElementById("ef_total"); if(eftxt) eftxt.textContent = "";
    DENOMS.forEach(d => { const el = document.getElementById(`ef_${d}`); if(el) el.value = 0; });
    toggleEfectivoSection();
  }

  /**********  GUARDAR VENTA + MODAL VUELTO **********/
  function guardarVenta() {
    if(!getSessionUser()){ showLoginModal(); return; }
    const cliente = document.getElementById("cliente").value.trim();
    const formaPago = document.getElementById("formaPago").value;
    const tipoPedido = document.getElementById("tipoPedido").value;
    if (pedido.length === 0) return alert("Agrega productos al pedido.");
    if (!cliente) return alert("Por favor ingresa el nombre del cliente.");
    if (!formaPago) return alert("Por favor selecciona una forma de pago.");
    if (!tipoPedido) return alert("Por favor selecciona un tipo de pedido.");
    const observaciones = document.getElementById("observaciones").value.trim();

    const { recibidos: billetesRecibidos, totalRecibido: efectivoRecibido } = capturarEfectivoRecibido();
    let vuelto = 0;
    if (formaPago === "Efectivo") {
      if (efectivoRecibido < total) return alert(`Efectivo insuficiente. Faltan $${(total - efectivoRecibido).toLocaleString('es-CO')}.`);
      vuelto = efectivoRecibido - total;
    } else {
      DENOMS.forEach(d => billetesRecibidos[d] = 0);
    }

    const baseVenta = {
      cliente, formaPago, tipoPedido, observaciones,
      pedido: [...pedido], total,
      fecha: new Date().toLocaleString(),
      billetesRecibidos, billetesDevueltos: {},
      efectivoRecibido
    };

    if (formaPago === "Efectivo" && vuelto > 0) {
      ventaTemporal = { ...baseVenta, vuelto, comanda: null };
      abrirModalVuelto(vuelto);
      return;
    }

    const venta = { ...baseVenta, comanda: comandaEnEdicion ?? obtenerSiguienteComanda() };
    const ventas = JSON.parse(localStorage.getItem("ventas")) || [];
    ventas.push(venta);
    localStorage.setItem("ventas", JSON.stringify(ventas));
    comandaEnEdicion = null;
    alert("Venta guardada exitosamente.");
    limpiarPedido();
    mostrarVentas();
    const rp = document.getElementById("resumenProductos"); if (rp) rp.classList.add("hidden");
  }

  // --- Modal de vuelto
  function abrirModalVuelto(vuelto) {
    const tbody = document.getElementById("tablaVuelto");
    tbody.innerHTML = "";
    DENOMS.forEach(d => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td class="py-1">${parseInt(d,10).toLocaleString('es-CO')} COP</td>
        <td class="py-1"><input type="number" min="0" value="0" class="p-1 border rounded w-full" data-denom="${d}"></td>`;
      tbody.appendChild(tr);
    });
    document.getElementById("vueltoRequeridoTexto").textContent = `Vuelto requerido: $${vuelto.toLocaleString('es-CO')}`;
    const m = document.getElementById("modalVuelto"); m.classList.remove('hidden'); m.classList.add('flex');
  }
  function cerrarModalVuelto() {
    const m = document.getElementById("modalVuelto"); m.classList.add('hidden'); m.classList.remove('flex');
    ventaTemporal = null;
  }
  function confirmarVuelto() {
    if(!ventaTemporal) return alert("No hay venta en proceso.");
    const inputs = document.querySelectorAll("#tablaVuelto input");
    const billetesDevueltos = {};
    let totalDevuelto = 0;
    inputs.forEach(inp => {
      const d = inp.dataset.denom;
      const cant = parseInt(inp.value || "0", 10) || 0;
      billetesDevueltos[d] = cant;
      totalDevuelto += cant * parseInt(d, 10);
    });
    if (totalDevuelto !== ventaTemporal.vuelto) {
      alert(`El total ingresado ($${totalDevuelto.toLocaleString('es-CO')}) no coincide con el vuelto requerido ($${ventaTemporal.vuelto.toLocaleString('es-CO')}).`);
      return;
    }
    const venta = { ...ventaTemporal, billetesDevueltos, comanda: comandaEnEdicion ?? obtenerSiguienteComanda() };
    const ventas = JSON.parse(localStorage.getItem("ventas")) || [];
    ventas.push(venta);
    localStorage.setItem("ventas", JSON.stringify(ventas));
    comandaEnEdicion = null; ventaTemporal = null;
    cerrarModalVuelto();
    alert("Venta guardada exitosamente.");
    limpiarPedido();
    mostrarVentas();
    const rp = document.getElementById("resumenProductos"); if (rp) rp.classList.add("hidden");
  }

  /**********  LISTADO / ACCIONES DE VENTAS **********/
  function mostrarVentas() {
    const contenedor = document.getElementById("ventasGuardadas");
    if(!contenedor) return;
    const ventas = JSON.parse(localStorage.getItem("ventas")) || [];
    const admin = isAdmin();
    contenedor.innerHTML = "";

    ventas.forEach((v, i) => {
      const resumen = {};
      v.pedido.forEach(p => { resumen[p.nombre] = (resumen[p.nombre] || 0) + 1; });
      const productosResumen = Object.entries(resumen).map(([prod, cant]) => `${prod}: ${cant}`).join("<br>");

      contenedor.innerHTML += `
        <tr>
          <td class='border p-1'>${v.comanda ?? (i + 1)}</td>
          <td class='border p-1'>${v.fecha}</td>
          <td class='border p-1'>${v.cliente}</td>
          <td class='border p-1'>${v.formaPago}</td>
          <td class='border p-1'>${v.tipoPedido}</td>
          <td class='border p-1'>${productosResumen}</td>
          <td class='border p-1'>$${v.total.toLocaleString('es-CO')}</td>
          <td class='border p-1 space-x-1'>
            <button onclick="imprimirVentaCliente(${i})" class="bg-purple-500 text-white px-2 py-1 rounded text-xs">ğŸ§¾ Cliente</button>
            <button onclick="imprimirVentaCocina(${i})" class="bg-blue-500 text-white px-2 py-1 rounded text-xs">ğŸ‘¨â€ğŸ³ Cocina</button>
            ${ admin ? `<button onclick="editarVenta(${i})" class="bg-yellow-600 text-white px-2 py-1 rounded text-xs">ğŸ“ Editar</button>` : ``}
          </td>
        </tr>`;
    });
  }

  function filtrarVentasPorCliente() {
    const filtro = document.getElementById("filtroCliente").value.toLowerCase();
    const ventas = JSON.parse(localStorage.getItem("ventas")) || [];
    const contenedor = document.getElementById("ventasGuardadas");
    const admin = isAdmin();
    contenedor.innerHTML = "";

    ventas.forEach((v, i) => {
      if (!v.cliente.toLowerCase().includes(filtro)) return;
      const resumen = {};
      v.pedido.forEach(p => { resumen[p.nombre] = (resumen[p.nombre] || 0) + 1; });
      const productosResumen = Object.entries(resumen).map(([prod, cant]) => `${prod}: ${cant}`).join("<br>");

      contenedor.innerHTML += `
        <tr>
          <td class='border p-1'>${v.comanda ?? (i + 1)}</td>
          <td class='border p-1'>${v.fecha}</td>
          <td class='border p-1'>${v.cliente}</td>
          <td class='border p-1'>${v.formaPago}</td>
          <td class='border p-1'>${v.tipoPedido}</td>
          <td class='border p-1'>${productosResumen}</td>
          <td class='border p-1'>$${v.total.toLocaleString('es-CO')}</td>
          <td class='border p-1 space-x-1'>
            <button onclick="imprimirVentaCliente(${i})" class="bg-purple-500 text-white px-2 py-1 rounded text-xs">ğŸ§¾ Cliente</button>
            <button onclick="imprimirVentaCocina(${i})" class="bg-blue-500 text-white px-2 py-1 rounded text-xs">ğŸ‘¨â€ğŸ³ Cocina</button>
            ${ admin ? `<button onclick="editarVenta(${i})" class="bg-yellow-600 text-white px-2 py-1 rounded text-xs">ğŸ“ Editar</button>` : ``}
          </td>
        </tr>`;
    });
  }

  /**********  EXPORTAR / CIERRE / IMPRESIÃ“N **********/
  async function exportarVentasExcelConEstilo(){
    if(!isAdmin()){ alert("Solo el Administrador puede exportar a Excel."); return; }
    const ventas = JSON.parse(localStorage.getItem("ventas")) || [];
    if (ventas.length === 0) return alert("No hay ventas registradas.");
    const workbook = new ExcelJS.Workbook();
    const sheet = workbook.addWorksheet("Ventas del DÃ­a");
    const headers = ["#", "Fecha", "Cliente", "Forma de Pago", "Tipo de Pedido", "Producto", "Precio (COP)", "Total Venta (COP)"];
    sheet.addRow(headers);
    let totalGlobal = 0; const conteoProductos = {};
    ventas.forEach((venta, i) => {
      const { fecha, cliente, formaPago, tipoPedido, total, pedido } = venta;
      totalGlobal += parseFloat(total) || 0;
      pedido.forEach(producto => {
        sheet.addRow([venta.comanda ?? (i + 1), fecha, cliente, formaPago, tipoPedido, producto.nombre, parseFloat(producto.precio), parseFloat(total)]);
        conteoProductos[producto.nombre] = (conteoProductos[producto.nombre] || 0) + 1;
      });
    });
    sheet.getRow(1).eachCell(c => { c.fill={type:"pattern",pattern:"solid",fgColor:{argb:"FF1F4E78"}}; c.font={color:{argb:"FFFFFFFF"},bold:true}; c.alignment={vertical:"middle",horizontal:"center"}; c.border={top:{style:"thin"},bottom:{style:"thin"},left:{style:"thin"},right:{style:"thin"}}; });
    for(let r=2;r<=sheet.rowCount;r++){ const row=sheet.getRow(r); const even=r%2===0; row.eachCell(c=>{c.fill={type:"pattern",pattern:"solid",fgColor:{argb: even ? "FFF2F2F2":"FFFFFFFF"}}; c.border={top:{style:"thin"},bottom:{style:"thin"},left:{style:"thin"},right:{style:"thin"}};}); row.getCell(7).numFmt='"$"#,##0'; row.getCell(8).numFmt='"$"#,##0';}
    sheet.addRow([]); const totalRow = sheet.addRow(["","","","","","TOTAL DEL DÃA:","",totalGlobal]); totalRow.getCell(8).numFmt='"$"#,##0'; totalRow.font={bold:true};
    let prodMas="", max=0; for(const [prod,c] of Object.entries(conteoProductos)){ if(c>max){max=c;prodMas=prod;} }
    const r2 = sheet.addRow(["","","","","","Producto mÃ¡s vendido:","",`${prodMas} (${max})`]); r2.font={italic:true};
    sheet.columns.forEach(col => col.width = 18);
    const buffer = await workbook.xlsx.writeBuffer();
    const blob = new Blob([buffer], { type: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" });
    const url = URL.createObjectURL(blob); const a = document.createElement("a"); a.href = url;
    const d = new Date(); a.download = `Ventas_del_dÃ­a_${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}.xlsx`;
    document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  }

  function cierreDeCaja(){
    const ventas = JSON.parse(localStorage.getItem("ventas")) || [];
    const base = getBaseCaja();

    const sumRec = {}, sumDev = {}, sumNet = {}, finalCounts = {};
    let montoRec=0, montoDev=0, montoNet=0, montoBase=0, montoFinal=0;

    DENOMS.forEach(d=>{sumRec[d]=0; sumDev[d]=0; sumNet[d]=0; finalCounts[d]=0;});

    ventas.forEach(v=>{
      DENOMS.forEach(d=>{
        sumRec[d]+= (v.billetesRecibidos?.[d]||0);
        sumDev[d]+= (v.billetesDevueltos?.[d]||0);
      });
    });

    DENOMS.forEach(d=>{
      sumNet[d]= sumRec[d]-sumDev[d];
      const baseCnt = base?.counts?.[d] || 0;
      finalCounts[d] = baseCnt + sumNet[d];

      montoRec  += sumRec[d]*parseInt(d,10);
      montoDev  += sumDev[d]*parseInt(d,10);
      montoNet  += sumNet[d]*parseInt(d,10);
      montoBase += baseCnt*parseInt(d,10);
      montoFinal+= finalCounts[d]*parseInt(d,10);
    });

    const html = `
      <html><head><title>Cierre de Caja</title><style>
        body { font-family: monospace; font-size: 12px; width: 76mm; padding: 10px 12px; margin: 0; }
        h2 { text-align: center; font-size: 18px; margin: 8px 0; font-weight: bold; }
        .line { border-top: 1px dashed #000; margin: 8px 0; }
        table { width:100%; border-collapse: collapse; }
        th,td{ padding:4px 2px; text-align:right; }
        th:first-child,td:first-child{text-align:left;}
        .totales p{ margin:3px 0; font-weight:bold; }
        .foot{ text-align:center; margin-top:10px; }
      </style></head><body>
        <h2>CIERRE DE CAJA</h2>
        <p>Fecha: ${new Date().toLocaleString()}</p>
        <div class="line"></div>
        <table>
          <thead>
            <tr>
              <th>Denom</th>
              <th>Base</th>
              <th>Rec</th>
              <th>Dev</th>
              <th>Neto</th>
              <th>Final</th>
              <th>$ Final</th>
            </tr>
          </thead>
          <tbody>
            ${DENOMS.map(d=>{
              const baseCnt = base?.counts?.[d] || 0;
              const rec = sumRec[d], dev = sumDev[d], net = sumNet[d], fin = finalCounts[d];
              const montoFin = fin * parseInt(d,10);
              return `<tr>
                <td>${parseInt(d,10).toLocaleString('es-CO')}</td>
                <td>${baseCnt}</td>
                <td>${rec}</td>
                <td>${dev}</td>
                <td>${net}</td>
                <td>${fin}</td>
                <td>$${montoFin.toLocaleString('es-CO')}</td>
              </tr>`;
            }).join("")}
          </tbody>
        </table>
        <div class="line"></div>
        <div class="totales">
          <p>Base de Caja: $${montoBase.toLocaleString('es-CO')} ${base ? `(${base.usuario} - ${base.hora})` : '(no registrada)'}</p>
          <p>Efectivo Recibido Ventas: $${montoRec.toLocaleString('es-CO')}</p>
          <p>Efectivo Devuelto: $${montoDev.toLocaleString('es-CO')}</p>
          <p>Neto por Ventas: $${montoNet.toLocaleString('es-CO')}</p>
          <p>Total Esperado en Caja (Base + Neto): $${montoFinal.toLocaleString('es-CO')}</p>
        </div>
        <div class="line"></div>
        <p class="foot">Gracias. â€” SeÃ±or Arepa</p>
        <script>window.print();<\/script>
      </body></html>`;
    const w = window.open("", "_blank", "width=460,height=720"); w.document.write(html); w.document.close(); w.focus();
  }

  /**********  IMPRESIONES **********/
  function imprimirUltimaCocinero() {
    const ventas = JSON.parse(localStorage.getItem("ventas")) || [];
    if (ventas.length === 0) return alert("No hay ventas para imprimir.");
    const ultimaVenta = ventas[ventas.length - 1];
    if (!ultimaVenta.pedido || !Array.isArray(ultimaVenta.pedido)) return alert("La Ãºltima venta no tiene productos vÃ¡lidos.");
    const resumen = {}; ultimaVenta.pedido.forEach(p => { resumen[p.nombre] = (resumen[p.nombre] || 0) + 1; });
    const contenido = `
      <!DOCTYPE html><html><head><style>
        body{font-family:monospace;font-size:15px;margin:0;padding:11px;}
        h2{text-align:center;font-size:19px;margin-bottom:11px;}
        .info{margin-bottom:10px;} .info p{margin:2px 0;}
        ul{list-style:none;padding:0;margin:0;} li{padding:4px 0;border-bottom:2px dashed #000;font-size:19px;}
      </style></head><body>
        <h2>ğŸ§¾ PEDIDO A COCINA</h2>
        <div class="info">
          <p style="text-align:center;font-weight:bold;margin:6px 0;">COMANDA #${ultimaVenta.comanda ?? ventas.length}</p>
          <p><strong>Cliente:</strong> ${ultimaVenta.cliente || "Sin nombre"}</p>
          <p><strong>Hora:</strong> ${ultimaVenta.fecha || "Sin hora"}</p>
          <p><strong>Tipo de Pedido:</strong> ${ultimaVenta.tipoPedido || "-"}</p>
          ${ultimaVenta.observaciones ? `<p><strong>Observaciones:</strong> ${ultimaVenta.observaciones}</p>` : ""}
        </div>
        <ul>${Object.entries(resumen).map(([producto, cantidad]) => `<li>${producto} x${cantidad}</li>`).join("")}</ul>
        <p style="text-align:center;margin-top:10px;">ğŸ‘¨â€ğŸ³ Preparar con cuidado</p>
        <script>window.print();<\/script>
      </body></html>`;
    const w = window.open("", "_blank", "width=400,height=600"); w.document.write(contenido); w.document.close(); w.focus();
  }

  function imprimirUltimaCliente() {
    const ventas = JSON.parse(localStorage.getItem("ventas")) || [];
    if (ventas.length === 0) return alert("No hay ventas para imprimir.");
    const v = ventas[ventas.length - 1]; const obs = v.observaciones || "";
    let contenido = `
      <html><head><title>Recibo Cliente</title><style>
        body{font-family:monospace;font-size:14px;width:58mm;padding:10px 12px;margin:0;line-height:1.5;}
        h2{text-align:center;font-size:19px;margin:14px 0 5px;font-weight:bold;}
        .sub-info{text-align:center;font-size:12px;margin-bottom:10px;line-height:1.3;}
        .line{border-top:1px dashed #000;margin:9px 0;} ul{list-style:none;padding:0;margin:0;} li{margin-bottom:7px;}
        .total{text-align:right;font-weight:bold;margin-top:14px;font-size:16px;} .info p{margin:6px 0;} .info strong{font-weight:bold;}
        p.thanks{text-align:center;margin-top:22px;font-weight:bold;font-size:15px;}
      </style></head><body>
        <h2>SEÃ‘OR AREPA</h2>
        <div class="sub-info">MatrÃ­cula No 289546<br>CALLE 19#25-03 ESQUINA<br>BARRIO SAN JOSÃ‰, ARMENIA</div>
        <div class="line"></div>
        <div class="info">
          <p style="text-align:center;font-weight:bold;margin:6px 0;">RECIBO #${v.comanda ?? ventas.length}</p>
          <p style="text-align:center;font-weight:bold;margin:6px 0;">COMANDA #${v.comanda ?? ventas.length}</p>
          <p><strong>Cliente:</strong> ${v.cliente || "N/A"}</p>
          <p><strong>Fecha:</strong> ${v.fecha}</p>
          <p><strong>Tipo de Pedido:</strong> ${v.tipoPedido || "-"}</p>
          ${obs ? `<p><strong>Observaciones:</strong> ${obs}</p>` : ""}
        </div>
        <div class="line"></div>
        <ul>${v.pedido.map(p => `<li>${p.nombre} - $${p.precio}</li>`).join("")}</ul>
        <div class="line"></div>
        <p class="total">Total: $${v.total.toLocaleString('es-CO')}</p>
        <div class="line"></div>
        <p class="thanks">Â¡Gracias por su compra!</p>
        <script>window.print();<\/script>
      </body></html>`;
    const w = window.open("", "_blank", "width=400,height=600"); w.document.write(contenido); w.document.close(); w.focus();
  }

  // ReimpresiÃ³n por fila â€” PERMITIDA para cajero y admin (sin editar)
  function imprimirVentaCliente(index){
    const ventas = JSON.parse(localStorage.getItem("ventas")) || []; const v = ventas[index]; if (!v) return alert("Venta no encontrada.");
    let contenido = `
      <html><head><title>Recibo Cliente</title><style>
        body{font-family:monospace;font-size:14px;width:58mm;padding:10px 12px;margin:0;line-height:1.5;}
        h2{text-align:center;font-size:19px;margin:14px 0;font-weight:bold;}
        .line{border-top:1px dashed #000;margin:9px 0;} ul{list-style:none;padding:0;margin:0;} li{margin-bottom:7px;}
        .total{text-align:right;font-weight:bold;margin-top:14px;font-size:16px;} .info p{margin:6px 0;} .info strong{font-weight:bold;}
        p.thanks{text-align:center;margin-top:22px;font-weight:bold;font-size:15px;}
      </style></head><body>
        <h2>SEÃ‘OR AREPA</h2>
        <div class="line"></div>
        <div class="info">
          <p style="text-align:center;font-weight:bold;margin:6px 0;">RECIBO #${v.comanda ?? (index + 1)}</p>
          <p style="text-align:center;font-weight:bold;margin:6px 0;">COMANDA #${v.comanda ?? (index + 1)}</p>
          <p><strong>Cliente:</strong> ${v.cliente || "N/A"}</p>
          <p><strong>Fecha:</strong> ${v.fecha}</p>
          <p><strong>Tipo de Pedido:</strong> ${v.tipoPedido || "-"}</p>
          ${v.observaciones ? `<p><strong>Observaciones:</strong> ${v.observaciones}</p>` : ""}
        </div>
        <div class="line"></div>
        <ul>${v.pedido.map(p => `<li>${p.nombre} - $${p.precio}</li>`).join("")}</ul>
        <div class="line"></div>
        <p class="total">Total: $${v.total.toLocaleString('es-CO')}</p>
        <div class="line"></div>
        <p class="thanks">Â¡Gracias por su compra!</p>
        <script>window.print();<\/script>
      </body></html>`;
    const w = window.open("", "_blank", "width=400,height=600"); w.document.write(contenido); w.document.close(); w.focus();
  }
  function imprimirVentaCocina(index){
    const ventas = JSON.parse(localStorage.getItem("ventas")) || []; const v = ventas[index]; if (!v) return alert("Venta no encontrada.");
    const resumen = {}; v.pedido.forEach(p => { resumen[p.nombre] = (resumen[p.nombre] || 0) + 1; });
    const contenido = `
      <html><head><title>Pedido Cocina</title><style>
        body{font-family:monospace;font-size:15px;margin:0;padding:11px;}
        h2{text-align:center;font-size:19px;margin-bottom:11px;}
        .info{margin-bottom:10px;} .info p{margin:2px 0;}
        ul{list-style:none;padding:0;margin:0;} li{padding:4px 0;border-bottom:2px dashed #000;font-size:19px;}
      </style></head><body>
        <h2>ğŸ§¾ PEDIDO A COCINA</h2>
        <div class="info">
          <p style="text-align:center;font-weight:bold;margin:6px 0;">RECIBO #${v.comanda ?? (index + 1)}</p>
          <p style="text-align:center;font-weight:bold;margin:6px 0;">COMANDA #${v.comanda ?? (index + 1)}</p>
          <p><strong>Cliente:</strong> ${v.cliente || "Sin nombre"}</p>
          <p><strong>Hora:</strong> ${v.fecha || "Sin hora"}</p>
          <p><strong>Tipo de Pedido:</strong> ${v.tipoPedido || "-"}</p>
          ${v.observaciones ? `<p><strong>Observaciones:</strong> ${v.observaciones}</p>` : ""}
        </div>
        <ul>${Object.entries(resumen).map(([producto, cantidad]) => `<li>${producto} x${cantidad}</li>`).join("")}</ul>
        <p style="text-align:center;margin-top:10px;">ğŸ‘¨â€ğŸ³ Preparar con cuidado</p>
        <script>window.print();<\/script>
      </body></html>`;
    const w = window.open("", "_blank", "width=400,height=600"); w.document.write(contenido); w.document.close(); w.focus();
  }

  function editarVenta(index) {
    if(!isAdmin()){ alert("Solo el Administrador puede editar ventas."); return; }
    const ventas = JSON.parse(localStorage.getItem("ventas")) || [];
    const venta = ventas[index];
    if (!venta) return alert("Venta no encontrada.");
    document.getElementById("cliente").value = venta.cliente;
    document.getElementById("formaPago").value = venta.formaPago;
    document.getElementById("tipoPedido").value = venta.tipoPedido;
    document.getElementById("observaciones").value = venta.observaciones || "";
    pedido = [...venta.pedido]; total = venta.total; actualizarVistaPedido();
    comandaEnEdicion = venta.comanda ?? null;
    ventas.splice(index, 1); localStorage.setItem("ventas", JSON.stringify(ventas));
    mostrarVentas();
    alert("Venta cargada para ediciÃ³n. Haz los cambios y presiona 'Guardar Venta'.");
  }

  /**********  COMANDAS **********/
  function obtenerSiguienteComanda() {
    const key = "ultimoNumeroComanda";
    const ultimo = parseInt(localStorage.getItem(key) || "0", 10);
    const siguiente = ultimo + 1;
    localStorage.setItem(key, String(siguiente));
    return siguiente;
  }

  /**********  INIT **********/
  window.onload = function(){
    ensureUsersInit();
    const user = getSessionUser();
    if(!user) showLoginModal(); else hideLoginModal();
    applyRoleUI();
    renderUsersTable();
    mostrarVentas();
    if(user) autoPromptBaseIfMissing(); // si ya hay sesiÃ³n activa al recargar
  }
  </script>
</body>
</html>
