<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SEÃ‘OR AREPA â€” v5.4 (Fix multi-dispositivo + negocio Ãºnico)</title>
  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Excel export -->
  <script src="https://cdn.jsdelivr.net/npm/exceljs/dist/exceljs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
</head>

<body class="bg-yellow-50 font-sans">
  <!-- NAV -->
  <nav class="bg-yellow-400 p-4 flex justify-between items-center text-white font-bold text-lg">
    <div class="flex items-center space-x-2">
      <img src="imagenes/senora.png"
           alt="Logo SeÃ±or Arepa"
           class="w-20 h-20 rounded-full object-cover"
           onerror="this.onerror=null;this.src='imagenes/logo-fallback.png';">
      <span class="text-xl">SEÃ‘OR AREPA</span>
    </div>
    <div class="flex items-center gap-3">
      <a href="finanzas1.html" class="bg-white text-yellow-700 font-semibold px-3 py-1 rounded-lg shadow hover:bg-yellow-100 transition" target="_blank">ğŸ“‹ Finanzas</a>
      <a href="inventario.html" class="bg-yellow-600 text-white font-semibold px-3 py-1 rounded-lg shadow hover:bg-yellow-700 transition" target="_blank">ğŸ“† Inventario</a>
      <span id="baseBadge" class="hidden md:inline text-sm bg-teal-600/80 px-2 py-1 rounded"></span>
      <span id="currentUserBadge" class="hidden md:inline text-sm bg-yellow-700/80 px-2 py-1 rounded"></span>
      <button id="btnLogout" onclick="logout()" class="hidden bg-yellow-700 text-white px-3 py-1 rounded">Salir</button>
    </div>
  </nav>

  <!-- MAIN -->
  <main class="p-6">
    <h2 class="text-2xl font-bold text-gray-700 mb-4">MenÃº</h2>

    <!-- Productos -->
    <div id="productos" class="grid grid-cols-1 md:grid-cols-3 gap-4">
      <!-- Comida -->
      <div class="bg-white p-4 rounded-xl shadow-md">
        <h3 class="text-xl font-semibold text-yellow-600 mb-2">Comida</h3>
        <div class="grid grid-cols-2 gap-2">
          <button onclick="agregarProducto('AREPA PAISA', 17000)" class="bg-yellow-300 hover:bg-yellow-400 p-2 rounded">âšª PAISA - $17.000</button>
          <button onclick="agregarProducto('AREPA PAISA POLLO', 17000)" class="bg-yellow-300 hover:bg-yellow-400 p-2 rounded">âšª PAISA POLLO - $17.000</button>
          <button onclick="agregarProducto('AREPA CHICHARRON', 14000)" class="bg-yellow-300 hover:bg-yellow-400 p-2 rounded">âšª CHICHARRON - $14.000</button>
          <button onclick="agregarProducto('AREPA EXTRA QUESILLO', 9000)" class="bg-yellow-300 hover:bg-yellow-400 p-2 rounded">âšª EXTRA QUESILLO - $9.000</button>
          <button onclick="agregarProducto('AREPA SEÃ‘OR AREPA', 14000)" class="bg-yellow-300 hover:bg-yellow-400 p-2 rounded">âšª SEÃ‘OR AREPA - $14.000</button>
          <button onclick="agregarProducto('AREPA SEÃ‘ORA AREPA', 14000)" class="bg-yellow-300 hover:bg-yellow-400 p-2 rounded">âšª SEÃ‘ORA AREPA - $14.000</button>
          <button onclick="agregarProducto('AREPA HAWAIANA', 14000)" class="bg-yellow-300 hover:bg-yellow-400 p-2 rounded">âšª HAWAIANA - $14.000</button>
          <button onclick="agregarProducto('AREPA MEGAPAISA', 22000)" class="bg-yellow-300 hover:bg-yellow-400 p-2 rounded">âšª MEGAPAISA- $22.000</button>
          <button onclick="agregarProducto('AREPA MIXTA', 14000)" class="bg-yellow-300 hover:bg-yellow-400 p-2 rounded">âšª MIXTA - $14.000</button>
          <button onclick="agregarProducto('AREPA RANCHERA', 14000)" class="bg-yellow-300 hover:bg-yellow-400 p-2 rounded">âšª RANCHERA - $14.000</button>
          <button onclick="agregarProducto('AREPA SOLO POLLO', 15000)" class="bg-yellow-300 hover:bg-yellow-400 p-2 rounded">âšª SOLO POLLO - $15.000</button>
          <button onclick="agregarProducto('AREPA SOLO CARNE', 15000)" class="bg-yellow-300 hover:bg-yellow-400 p-2 rounded">âšª SOLO CARNE - $15.000</button>
          <button onclick="agregarProducto('AREPA MEXICANA', 15000)" class="bg-yellow-300 hover:bg-yellow-400 p-2 rounded">âšª MEXICANA - $15.000</button>
          <button onclick="agregarProducto('AREPA SOLA', 1000)" class="bg-yellow-300 hover:bg-yellow-400 p-2 rounded">âšª AREPA SOLA - $1.000</button>
        </div>
      </div>

      <!-- Adiciones -->
      <div class="bg-white p-4 rounded-xl shadow-md">
        <h3 class="text-xl font-semibold text-yellow-600 mb-2">Adiciones</h3>
        <div class="grid grid-cols-2 gap-2">
          <button onclick="agregarProducto('ADICION QUESO EXTRA', 5000)" class="bg-yellow-300 hover:bg-yellow-400 p-2 rounded">ğŸ§€ Queso Extra - $5.000</button>
          <button onclick="agregarProducto('ADICION MAIZ TIERNO', 3000)" class="bg-yellow-300 hover:bg-yellow-400 p-2 rounded">ğŸŒ½ MAIZ TIERNO - $3.000</button>
          <button onclick="agregarProducto('ADICION PIÃ‘A CALADA', 5000)" class="bg-yellow-300 hover:bg-yellow-400 p-2 rounded">ğŸ PIÃ‘A CALADA - $5.000</button>
          <button onclick="agregarProducto('ADICION POLLO', 7000)" class="bg-yellow-300 hover:bg-yellow-400 p-2 rounded">ğŸ— POLLO - $7.000</button>
          <button onclick="agregarProducto('ADICION CARNE', 7000)" class="bg-yellow-300 hover:bg-yellow-400 p-2 rounded">ğŸ¥© CARNE - $7.000</button>
          <button onclick="agregarProducto('ADICION CHICHARRON', 6000)" class="bg-yellow-300 hover:bg-yellow-400 p-2 rounded">ğŸ– CHICHARRON - $6.000</button>
          <button onclick="agregarProducto('ADICION RANCHERA', 7000)" class="bg-yellow-300 hover:bg-yellow-400 p-2 rounded">ğŸ”¥ RANCHERA - $7.000</button>
          <button onclick="agregarProducto('ADICION CHORIZO', 7000)" class="bg-yellow-300 hover:bg-yellow-400 p-2 rounded">ğŸŒ­ CHORIZO - $7.000</button>
          <button onclick="agregarProducto('ADICION TOCINETA', 7000)" class="bg-yellow-300 hover:bg-yellow-400 p-2 rounded">ğŸ¥“ TOCINETA - $7.000</button>
          <button onclick="agregarProducto('ADICION MADURO', 3000)" class="bg-yellow-300 hover:bg-yellow-400 p-2 rounded">ğŸŒ  MADURO - $3.000</button>
          <button onclick="agregarProducto('ADICION ARMA TU AREPA X5', 25000)" class="bg-yellow-300 hover:bg-yellow-400 p-2 rounded">ğŸŒ ARMA TU AREPA - $25.000</button>
        </div>
      </div>

      <!-- Bebidas -->
      <div class="bg-white p-4 rounded-xl shadow-md">
        <h3 class="text-xl font-semibold text-yellow-600 mb-2">Bebidas</h3>
        <div class="grid grid-cols-2 gap-2">
          <button onclick="agregarProducto('QUATRO', 4000)" class="bg-yellow-300 hover:bg-yellow-400 p-2 rounded">ğŸ‹ QUATRO - $4.000</button>
          <button onclick="agregarProducto('COCA COLA 400 ml', 4000)" class="bg-yellow-300 hover:bg-yellow-400 p-2 rounded">ğŸ¥¤ COCA COLA - $4.000</button>
          <button onclick="agregarProducto('COCA COLA 250 ml', 3000)" class="bg-yellow-300 hover:bg-yellow-400 p-2 rounded">ğŸ¥¤ COCA COLA - $3.000</button>
          <button onclick="agregarProducto('JUGO HIT 500 ml', 4000)" class="bg-yellow-300 hover:bg-yellow-400 p-2 rounded">ğŸ¥¤ JUGO HIT - $4.000</button>
          <button onclick="agregarProducto('SPRITE', 4000)" class="bg-yellow-300 hover:bg-yellow-400 p-2 rounded">ğŸ¥¤ SPRITE - $4.000</button>
          <button onclick="agregarProducto('COCA COLA CERO', 4000)" class="bg-yellow-300 hover:bg-yellow-400 p-2 rounded">ğŸ¥¤ COCA COLA CERO - $4.000</button>
          <button onclick="agregarProducto('BRISA LIMON', 4000)" class="bg-yellow-300 hover:bg-yellow-400 p-2 rounded">ğŸ¥¤ BRISA LIMON - $4.000</button>
          <button onclick="agregarProducto('BRISA MANZANA', 4000)" class="bg-yellow-300 hover:bg-yellow-400 p-2 rounded">ğŸ’§ BRISA MANZANA - $4.000</button>
          <button onclick="agregarProducto('MISTER TEA', 4000)" class="bg-yellow-300 hover:bg-yellow-400 p-2 rounded">ğŸ¥¤ MISTER TEA - $4.000</button>
          <button onclick="agregarProducto('AGUA CON GAS', 4000)" class="bg-yellow-300 hover:bg-yellow-400 p-2 rounded">ğŸ¥¤ AGUA CON GAS - $4.000</button>
          <button onclick="agregarProducto('AGUA SABORISADA', 4000)" class="bg-yellow-300 hover:bg-yellow-400 p-2 rounded">ğŸ¥¤ AGUA SABORISADA - $4.000</button>
          <button onclick="agregarProducto('POSTOBON 400 ml', 4000)" class="bg-yellow-300 hover:bg-yellow-400 p-2 rounded">ğŸ¥¤ POSTOBON 400 - $4.000</button>
          <button onclick="agregarProducto('POSTOBON 250 ml', 3000)" class="bg-yellow-300 hover:bg-yellow-400 p-2 rounded">ğŸ¥¤ POSTOBON 250 - $3.000</button>
          <button onclick="agregarProducto('POSTOBON 1.5', 9000)" class="bg-yellow-300 hover:bg-yellow-400 p-2 rounded">ğŸ¥¤ POSTOBON 1.5 - $9.000</button>
          <button onclick="agregarProducto('SODA BRETAÃ‘A', 4500)" class="bg-yellow-300 hover:bg-yellow-400 p-2 rounded">ğŸ¥¤ SODA BRETAÃ‘A - $4.500</button>
          <button onclick="agregarProducto('GATORADE', 6000)" class="bg-yellow-300 hover:bg-yellow-400 p-2 rounded">ğŸ¥¤ GATORADE - $6.000</button>
          <button onclick="agregarProducto('PREMIO 400 ml', 4000)" class="bg-yellow-300 hover:bg-yellow-400 p-2 rounded">ğŸ¥¤ PREMIO 400 ml - $4.000</button>
          <button onclick="agregarProducto('PREMIO 1.5l', 9000)" class="bg-yellow-300 hover:bg-yellow-400 p-2 rounded">ğŸ¥¤ PREMIO 1.5l - $9.000</button>
          <button onclick="agregarProducto('QUATRO 1.5L', 9000)" class="bg-yellow-300 hover:bg-yellow-400 p-2 rounded">ğŸ¥¤ QUATRO 1.5L - $9.000</button>
          <button onclick="agregarProducto('COCA COLA 1.5L', 9000)" class="bg-yellow-300 hover:bg-yellow-400 p-2 rounded">ğŸ¥¤ COCA COLA  1.5L - $9.000</button>
          <button onclick="agregarProducto('JUGO HIT 1.L', 7500)" class="bg-yellow-300 hover:bg-yellow-400 p-2 rounded">ğŸ¥¤ JUGO HIT 1.L - $7.500</button>
          <button onclick="agregarProducto('SPRITE 1.5L', 9000)" class="bg-yellow-300 hover:bg-yellow-400 p-2 rounded">ğŸ¥¤ SPRITE 1.5L - $9.000</button>
          <button onclick="agregarProducto('COCA COLA ZERO 1.5L', 9000)" class="bg-yellow-300 hover:bg-yellow-400 p-2 rounded">ğŸ¥¤ COCA COLA ZERO 1.5L - $9.000</button>
          <button onclick="agregarProducto(' AGUA', 3000)" class="bg-yellow-300 hover:bg-yellow-400 p-2 rounded">ğŸ¥¤ AGUA - $3.000</button>
          <button onclick="agregarProducto('MILO CALIENTE', 6000)" class="bg-yellow-300 hover:bg-yellow-400 p-2 rounded">ğŸ¥› MILO CALIENTE - $6.000</button>
          <button onclick="agregarProducto('CAFE CON LECHE', 5000)" class="bg-yellow-300 hover:bg-yellow-400 p-2 rounded">â˜•ğŸ¥› CAFE CON LECHE - $5.000</button>
          <button onclick="agregarProducto('TINTO', 4000)" class="bg-yellow-300 hover:bg-yellow-400 p-2 rounded">â˜• TINTO - $4.000</button>
          <button onclick="agregarProducto('CERVEZA', 6000)" class="bg-yellow-300 hover:bg-yellow-400 p-2 rounded">ğŸº CERVEZA - $6.000</button>
        </div>
      </div>
    </div>

    <!-- Detalle Pedido -->
    <div class="mt-6 bg-white p-4 rounded-xl shadow-md">
      <h3 class="text-lg font-semibold mb-4 border-b pb-2">ğŸ›’ Pedido Actual</h3>
      <ul id="listaPedido" class="list-disc pl-5 text-gray-700 space-y-1"></ul>
      <p id="total" class="mt-4 font-bold text-lg text-gray-800">Total: $0</p>
    </div>

    <!-- Cliente & Pago -->
    <div class="mt-4 flex flex-col md:flex-row gap-4">
      <input type="text" id="cliente" placeholder="Nombre del Cliente" class="flex-1 p-2 border border-yellow-300 rounded" />
      <input type="text" id="observaciones" placeholder="Observaciones (Ej: Sin cebolla, agregar salsas, etc.)" class="flex-1 p-2 border border-yellow-300 rounded" />
      <select id="formaPago" class="flex-1 p-2 border border-yellow-300 rounded" onchange="toggleEfectivoSection(); if(this.value==='Efectivo'){abrirModalEfectivoRecibido();}">
        <option value="">Seleccione forma de pago</option>
        <option value="Efectivo">Efectivo</option>
        <option value="QR SeÃ±ora Arepa">QR SeÃ±ora Arepa</option>
        <option value="QR SeÃ±or Arepa">QR SeÃ±or Arepa</option>
        <option value="Nequi">Nequi</option>
        <option value="Daviplata">Daviplata</option>
      </select>
    </div>

    <!-- Tipo de pedido -->
    <div class="mt-4">
      <label for="tipoPedido" class="block text-sm font-medium text-gray-700">Tipo de Pedido</label>
      <select id="tipoPedido" class="mt-1 p-2 border rounded w-full">
        <option value="">Selecciona</option>
        <option value="AquÃ­">AquÃ­</option>
        <option value="Para llevar">Para llevar</option>
        <option value="Domicilio">Domicilio</option>
      </select>
    </div>

    <!-- Efectivo recibido -->
    <div class="mt-4">
      <button type="button" class="text-sm text-yellow-700 underline" onclick="abrirModalEfectivoRecibido()">ğŸ’µ Abrir panel de efectivo recibido</button>
      <p id="ef_total" class="mt-1 text-sm text-gray-600"></p>
    </div>

    <!-- Acciones -->
    <div class="mt-6 flex flex-wrap gap-2">
      <button id="btnGuardarVenta" onclick="guardarVenta()" class="bg-green-500 hover:bg-green-600 text-white p-2 rounded">ğŸ’¾ Guardar Venta</button>
      <button id="btnImprimirCocina" onclick="imprimirUltimaCocinero()" class="bg-blue-500 hover:bg-blue-600 text-white p-2 rounded">ğŸ–¨ï¸ Imprimir para Cocina</button>
      <button id="btnImprimirCliente" onclick="imprimirUltimaCliente()" class="bg-purple-500 hover:bg-purple-600 text-white p-2 rounded">ğŸ§¾ Imprimir Recibo Cliente</button>
      <button id="btnBaseCaja" onclick="abrirModalBaseCaja()" class="bg-teal-600 hover:bg-teal-700 text-white p-2 rounded">ğŸ“¦ Base de Caja</button>
      <button id="btnPagosCompras" onclick="abrirModalGasto()" class="bg-rose-600 hover:bg-rose-700 text-white p-2 rounded">ğŸ’¸ Compras / Pagos</button>
      <button id="btnExportarExcel" onclick="exportarVentasExcelConEstilo()" class="bg-green-600 hover:bg-green-700 text-white p-2 rounded">ğŸ“Š Exportar Ventas a Excel</button>
      <button id="btnBorrarVentas" onclick="borrarVentas()" class="bg-red-500 hover:bg-red-600 text-white p-2 rounded">ğŸ—‘ï¸ Borrar Ventas</button>
      <button id="btnResumenProductos" onclick="generarResumenProductos()" class="bg-indigo-500 hover:bg-indigo-600 text-white p-2 rounded">ğŸ“Š Ver Resumen Productos</button>
      <button id="btnCierreCaja" onclick="cierreDeCaja()" class="bg-amber-600 hover:bg-amber-700 text-white p-2 rounded">ğŸ’° Cierre de Caja</button>
    </div>

    <!-- Tabla movimientos -->
    <div id="ventasSeccion" class="mt-8 bg-white p-4 rounded-xl shadow-md">
      <div class="flex flex-col md:flex-row md:items-end md:justify-between gap-3">
        <h3 class="text-lg font-semibold">Movimientos (Ventas y Gastos)</h3>
        <div class="flex flex-col md:flex-row gap-2 md:items-center">
          <input type="text" id="filtroCliente" oninput="filtrarVentasPorCliente()" placeholder="ğŸ” Filtrar por cliente/desc..." class="w-full md:w-64 p-2 border border-yellow-300 rounded" />
          <div id="filtroUsuarioWrap" class="hidden md:flex items-center gap-2">
            <label class="text-sm text-gray-700">Usuario:</label>
            <select id="filtroUsuario" class="p-2 border rounded" onchange="mostrarVentas()">
              <option value="__todos__">Todos</option>
            </select>
          </div>
        </div>
      </div>
      <div class="mt-3">
        <table class="min-w-full text-left border">
          <thead>
            <tr class="bg-yellow-200">
              <th class="p-2 border">#</th>
              <th class="p-2 border">Fecha</th>
              <th class="p-2 border">Usuario</th>
              <th class="p-2 border">Cliente</th>
              <th class="p-2 border">Forma de Pago</th>
              <th class="p-2 border">Tipo de Pedido</th>
              <th class="p-2 border">Productos / DescripciÃ³n</th>
              <th class="p-2 border">Total</th>
              <th id="thAcciones" class="p-2 border">Acciones</th>
            </tr>
          </thead>
          <tbody id="ventasGuardadas" class="text-sm text-gray-800"></tbody>
        </table>
      </div>
    </div>

    <!-- Resumen Productos (solo admin) -->
    <div id="resumenProductos" class="mt-8 bg-white p-4 rounded-xl shadow-md hidden">
      <h3 class="text-lg font-semibold mb-2">Resumen de Productos Vendidos</h3>
      <ul id="listaResumen" class="list-disc pl-5 text-gray-700 space-y-1"></ul>
    </div>

    <!-- GestiÃ³n de Usuarios (solo admin) -->
    <div id="adminUsuariosSection" class="hidden mt-8 bg-white p-4 rounded-xl shadow-md">
      <h3 class="text-lg font-semibold mb-2">GestiÃ³n de Usuarios (nube)</h3>
      <form onsubmit="return addUserFromForm(event)" class="grid grid-cols-1 md:grid-cols-4 gap-2 mb-3">
        <input id="newUsername" class="p-2 border rounded" placeholder="Usuario" required>
        <input id="newPassword" type="password" class="p-2 border rounded" placeholder="ContraseÃ±a" required>
        <select id="newRole" class="p-2 border rounded">
          <option value="cajero">Cajero</option>
          <option value="admin">Admin</option>
        </select>
        <button class="bg-green-600 hover:bg-green-700 text-white px-3 py-2 rounded">â• Agregar</button>
      </form>
      <table class="min-w-full text-left border">
        <thead>
          <tr class="bg-yellow-200">
            <th class="p-2 border">Usuario</th>
            <th class="p-2 border">Rol</th>
            <th class="p-2 border">Creado</th>
            <th class="p-2 border">Acciones</th>
          </tr>
        </thead>
        <tbody id="usuariosTbody"></tbody>
      </table>
    </div>
  </main>

  <!-- MODALES: Vuelto / Base / Efectivo / Gasto / Login -->
  <!-- Vuelto -->
  <div id="modalVuelto" class="fixed inset-0 bg-black/50 hidden z-50 items-center justify-center">
    <div class="bg-white rounded-lg shadow-xl w-[90%] max-w-5xl flex flex-col md:flex-row overflow-hidden">
      <div class="w-full md:w-1/3 bg-yellow-50 p-6 border-r border-gray-200">
        <h2 class="text-2xl font-bold text-yellow-700 mb-2">ğŸ’µ Registrar Vuelto</h2>
        <p id="vueltoRequeridoTexto" class="text-sm text-gray-700"></p>
        <div class="mt-4">
          <div class="flex items-center justify-between rounded-lg bg-white px-3 py-2 shadow">
            <span class="text-sm font-medium">Total devuelto</span>
            <span id="totalDevueltoLabel" class="text-xl font-bold text-yellow-800">$0</span>
          </div>
        </div>
        <div class="mt-4">
          <div class="flex gap-2 justify-end">
            <button onclick="confirmarVuelto()" class="bg-teal-600 hover:bg-teal-700 text-white px-4 py-2 rounded shadow">Confirmar</button>
            <button onclick="cerrarModalVuelto()" class="bg-gray-400 hover:bg-gray-500 text-white px-4 py-2 rounded shadow">Cerrar</button>
          </div>
        </div>
      </div>
      <div class="w-full md:w-2/3 bg-white p-4 overflow-y-auto max-h-[80vh]">
        <div id="tablaVueltoUI" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-3"></div>
      </div>
    </div>
  </div>

  <!-- Base de Caja -->
  <div id="modalBaseCaja" class="fixed inset-0 bg-black/50 z-50 hidden items-center justify-center">
    <div class="bg-white rounded-lg shadow-xl w-[90%] max-w-5xl flex flex-col md:flex-row overflow-hidden">
      <div class="w-full md:w-1/3 bg-yellow-50 p-6 flex flex-col justify-between border-r border-gray-200">
        <div>
          <h2 class="text-2xl font-bold text-yellow-700 mb-2">ğŸ“¦ Base de Caja (Hoy)</h2>
          <p class="text-sm text-gray-600 mb-4">Presiona un botÃ³n para sumar un billete; usa â€œâ–â€ para restar.</p>
          <div class="flex items-center justify-between rounded-lg bg-white px-3 py-2 shadow">
            <span class="text-sm font-medium">Total base del dÃ­a</span>
            <span id="baseTotalValor" class="text-xl font-bold text-yellow-800">$0</span>
          </div>
        </div>
        <div class="mt-4">
          <p id="baseTotalTexto" class="text-sm text-gray-700 mt-3"></p>
          <div class="flex gap-2 justify-end mt-4">
            <button id="btnGuardarBase" onclick="confirmarBaseCaja()" class="bg-teal-600 hover:bg-teal-700 text-white px-4 py-2 rounded shadow">Guardar</button>
            <button onclick="cerrarModalBaseCaja()" class="bg-gray-400 hover:bg-gray-500 text-white px-4 py-2 rounded shadow">Cerrar</button>
          </div>
          <p id="baseMetaInfo" class="text-xs text-gray-500 mt-3"></p>
        </div>
      </div>
      <div class="w-full md:w-2/3 bg-white p-4 overflow-y-auto max-h-[80vh]">
        <div id="baseDenomsContainer" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-3"></div>
      </div>
    </div>
  </div>

  <!-- Efectivo Recibido -->
  <div id="modalEfectivo" class="fixed inset-0 bg-black/50 z-50 hidden items-center justify-center">
    <div class="bg-white rounded-lg shadow-xl w-[90%] max-w-5xl flex flex-col md:flex-row overflow-hidden">
      <div class="w-full md:w-1/3 bg-yellow-50 p-6 flex flex-col justify-between border-r border-gray-200">
        <div>
          <h2 class="text-2xl font-bold text-yellow-700 mb-2">ğŸ’µ Efectivo recibido</h2>
          <div class="flex items-center justify-between rounded-lg bg-white px-3 py-2 shadow">
            <span class="text-sm font-medium">Total recibido</span>
            <span id="efTotalValor" class="text-xl font-bold text-yellow-800">$0</span>
          </div>
        </div>
        <div class="mt-4">
          <div class="flex gap-2 justify-end mt-4">
            <button onclick="confirmarEfectivoRecibido()" class="bg-teal-600 hover:bg-teal-700 text-white px-4 py-2 rounded shadow">Usar</button>
            <button onclick="cerrarModalEfectivoRecibido()" class="bg-gray-400 hover:bg-gray-500 text-white px-4 py-2 rounded shadow">Cerrar</button>
          </div>
        </div>
      </div>
      <div class="w-full md:w-2/3 bg-white p-4 overflow-y-auto max-h-[80vh]">
        <div id="efDenomsContainer" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-3"></div>
      </div>
    </div>
  </div>

  <!-- Compras / Pagos -->
  <div id="modalGasto" class="fixed inset-0 bg-black/50 z-50 hidden items-center justify-center">
    <div class="bg-white rounded-lg shadow-xl w-[90%] max-w-5xl flex flex-col md:flex-row overflow-hidden">
      <div class="w-full md:w-1/3 bg-rose-50 p-6 flex flex-col justify-between border-r border-gray-200">
        <div>
          <h2 class="text-2xl font-bold text-rose-700 mb-2">ğŸ’¸ Compras / Pagos</h2>
          <label class="block text-sm text-gray-700 mb-1">DescripciÃ³n</label>
          <input id="gastoDescripcion" class="w-full border rounded px-2 py-1 mb-3" placeholder="Proveedor, insumo, etc.">
          <label class="block text-sm text-gray-700 mb-1">Total del Gasto</label>
          <input id="gastoTotal" type="number" min="0" class="w-full border rounded px-2 py-1" placeholder="0">
          <div class="mt-4">
            <div class="flex items-center justify-between rounded-lg bg-white px-3 py-2 shadow">
              <span class="text-sm font-medium">Se pagÃ³ en efectivo</span>
              <span id="gastoEfectivoValor" class="text-xl font-bold text-rose-800">$0</span>
            </div>
          </div>
        </div>
        <div class="mt-4">
          <div class="flex gap-2 justify-end mt-4">
            <button onclick="confirmarGasto()" class="bg-rose-600 hover:bg-rose-700 text-white px-4 py-2 rounded shadow">Registrar</button>
            <button onclick="cerrarModalGasto()" class="bg-gray-400 hover:bg-gray-500 text-white px-4 py-2 rounded shadow">Cerrar</button>
          </div>
        </div>
      </div>
      <div class="w-full md:w-2/3 bg-white p-4 overflow-y-auto max-h-[80vh]">
        <p class="text-sm text-gray-600 mb-2">Indica con quÃ© billetes se pagÃ³:</p>
        <div id="gastoDenomsContainer" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-3"></div>
      </div>
    </div>
  </div>

  <!-- Login -->
  <div id="loginModal" class="fixed inset-0 bg-black/50 z-50 hidden items-center justify-center">
    <div class="bg-white rounded-lg p-6 w-96">
      <h2 class="text-xl font-bold mb-4">Iniciar sesiÃ³n</h2>
      <form onsubmit="return loginFromModal(event)" class="space-y-3">
        <input id="loginUser" class="p-2 border rounded w-full" placeholder="Usuario" required>
        <input id="loginPass" type="password" class="p-2 border rounded w-full" placeholder="ContraseÃ±a" required>
        <button class="w-full bg-yellow-600 hover:bg-yellow-700 text-white px-4 py-2 rounded">Entrar</button>
      </form>
      <p class="text-xs text-gray-500 mt-3">Usuarios iniciales (si no hay en la nube): <b>admin/admin123</b> â€” <b>cajero/caja123</b></p>
    </div>
  </div>

  <!-- APP + FIREBASE -->
  <script type="module">
    /********** FIREBASE **********/
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
    import {
      initializeFirestore,
      persistentLocalCache,
      collection,
      addDoc,
      getDocs,
      getDoc,
      query,
      where,
      orderBy,
      serverTimestamp,
      doc,
      setDoc,
    } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDwCV5NmixGyEZ_bdAMTU5wqDua_BbANSo",
      authDomain: "senorarepa-689cc.firebaseapp.com",
      projectId: "senorarepa-689cc",
      storageBucket: "senorarepa-689cc.firebasestorage.app",
      messagingSenderId: "499118544254",
      appId: "1:499118544254:web:cdf7b22c12bb760d184f2f"
    };

    const app = initializeApp(firebaseConfig);
    const db  = initializeFirestore(app, { localCache: persistentLocalCache() });

    /********** NEGOCIO FIJO (soluciona â€œno pertenece a este negocioâ€) **********/
    // IMPORTANTE: usa SIEMPRE el MISMO BUSINESS_ID en TODOS los dispositivos.
    // Si ya tienes uno en tus documentos de Firestore (campo businessId), colÃ³calo aquÃ­.
    const BUSINESS_ID = "senor-arepa"; // <-- CAMBIA AQUÃ si tu negocio ya tiene otro ID en Firestore

    function getBusinessId(){ return BUSINESS_ID; } // fuerza el mismo ID (no depende del hostname)

    /********** ESTADO **********/
    const DENOMS = ["100000","50000","20000","10000","5000","2000","1000","500","200","100","50","20"];
    let pedido = []; let total = 0; let comandaEnEdicion = null; let ventaTemporal = null;
    const efCounts = {}; const baseCounts = {}; const gastoCounts = {};

    /********** UTIL **********/
    function todayStr(){ const d=new Date(); return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`; }
    function fmtMoney(n){ try{return n.toLocaleString('es-CO',{style:'currency',currency:'COP',maximumFractionDigits:0});}catch{return `$${(Math.round(n)).toString().replace(/\B(?=(\d{3})+(?!\d))/g,'.')}`;} }
    function setSessionUser(u){ localStorage.setItem('sessionUser', JSON.stringify(u)); }
    function getSessionUser(){ return JSON.parse(localStorage.getItem('sessionUser')||'null'); }
    function isAdmin(){ return getSessionUser()?.role==='admin'; }
    function toggleDisplay(id, show){ const el=document.getElementById(id); if(!el) return; el.classList[show?'remove':'add']('hidden'); }
    async function hashPassword(pwd){ const enc=new TextEncoder().encode(pwd); const buf=await crypto.subtle.digest('SHA-256', enc); return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join(''); }

    /********** USERS EN FIRESTORE **********/
    async function ensureDefaultUsersInFirestore(){
      const businessId=getBusinessId();
      const qs = await getDocs(query(collection(db,'users'), where('businessId','==',businessId)));
      if(!qs.empty) return;
      const adminHash = await hashPassword('admin123');
      const cajeroHash= await hashPassword('caja123');
      await setDoc(doc(collection(db,'users'),'admin'), {
        username:'admin', role:'admin', businessId, passwordHash:adminHash, createdAt:serverTimestamp(), updatedAt:serverTimestamp()
      });
      await setDoc(doc(collection(db,'users'),'cajero'), {
        username:'cajero', role:'cajero', businessId, passwordHash:cajeroHash, createdAt:serverTimestamp(), updatedAt:serverTimestamp()
      });
    }
    async function getUserDoc(username){
      const snap=await getDoc(doc(collection(db,'users'), username));
      return snap.exists()? snap.data() : null;
    }
    async function upsertUserProfile(username, role, passwordHash){
      const ref=doc(collection(db,'users'), username);
      const payload={ username, role, businessId:getBusinessId(), updatedAt:serverTimestamp() };
      if(passwordHash) payload.passwordHash=passwordHash;
      const exists=await getDoc(ref);
      if(!exists.exists()) payload.createdAt=serverTimestamp();
      await setDoc(ref, payload, { merge:true });
    }
    async function loadUsersFromFirestore(){
      const qs = await getDocs(query(collection(db,'users'), where('businessId','==',getBusinessId())));
      return qs.docs.map(d=>({ id:d.id, ...d.data() }));
    }
    async function renderUsersTable(){
      const tbody=document.getElementById('usuariosTbody'); if(!tbody) return;
      try{
        const list=await loadUsersFromFirestore();
        list.sort((a,b)=> (a.username||'').localeCompare(b.username||''));
        tbody.innerHTML=list.map(u=>`
          <tr>
            <td class="p-2 border">${u.username}</td>
            <td class="p-2 border">${u.role}</td>
            <td class="p-2 border">${u.createdAt?.seconds ? new Date(u.createdAt.seconds*1000).toLocaleString() : '-'}</td>
            <td class="p-2 border">
              <button onclick="deleteUser('${u.username.replace(/'/g,"\\'")}')" class="bg-red-600 text-white px-2 py-1 rounded text-xs">Eliminar</button>
            </td>
          </tr>`).join('');
        // llenar filtro usuario (admin)
        const sel=document.getElementById('filtroUsuario');
        if(sel){ const val=sel.value; sel.innerHTML = `<option value="__todos__">Todos</option>` + list.map(u=>`<option value="${u.username}">${u.username}</option>`).join(''); sel.value=val||'__todos__'; }
      }catch(e){
        tbody.innerHTML=`<tr><td colspan="4" class="p-2 border text-red-600">No se pudo cargar usuarios.</td></tr>`;
      }
    }
    async function countAdmins(){
      const qs=await getDocs(query(collection(db,'users'), where('businessId','==',getBusinessId()), where('role','==','admin')));
      return qs.size;
    }

    /********** LOGIN (adopta negocio del usuario si no coincide) **********/
    window.loginFromModal = async (e)=>{
      e.preventDefault();
      const username = document.getElementById('loginUser').value.trim();
      const password = document.getElementById('loginPass').value;
      if(!username||!password){ alert('Ingresa usuario y contraseÃ±a'); return false; }
      try{
        await ensureDefaultUsersInFirestore();
        const userDoc = await getUserDoc(username);
        if(!userDoc){ alert('Usuario no existe.'); return false; }

        // ValidaciÃ³n de contraseÃ±a
        const h = await hashPassword(password);
        if((userDoc.passwordHash||'') !== h){ alert('ContraseÃ±a incorrecta.'); return false; }

        // NEGOCIO: si el user tiene otro businessId distinto, lo permitimos solo si coincide con el BUSINESS_ID configurado.
        if(userDoc.businessId && userDoc.businessId !== getBusinessId()){
          alert(`Este usuario pertenece al negocio "${userDoc.businessId}", pero esta app estÃ¡ configurada para "${getBusinessId()}".\n\nCorrige la constante BUSINESS_ID en el cÃ³digo o crea usuarios para este negocio.`);
          return false;
        }

        // SesiÃ³n
        setSessionUser({ username:userDoc.username, role:userDoc.role });
        hideLoginModal();
        applyRoleUI();
        await renderUsersTable();
        await mostrarVentas();
        autoPromptBaseIfMissing();
      }catch(err){
        console.warn(err); alert('No fue posible iniciar sesiÃ³n.');
      }
      return false;
    };
    function showLoginModal(){ const m=document.getElementById('loginModal'); m.classList.remove('hidden'); m.classList.add('flex'); }
    function hideLoginModal(){ const m=document.getElementById('loginModal'); m.classList.add('hidden'); m.classList.remove('flex'); }
    window.logout = ()=>{ localStorage.removeItem('sessionUser'); applyRoleUI(); showLoginModal(); };

    // UI por rol
    function applyRoleUI(){
      const badge=document.getElementById('currentUserBadge');
      const btnLogout=document.getElementById('btnLogout');
      const u=getSessionUser();

      if(u){ badge.textContent=`${u.username} (${u.role})`; badge.classList.remove('hidden'); btnLogout.classList.remove('hidden'); }
      else { badge.classList.add('hidden'); btnLogout.classList.add('hidden'); }

      const admin=isAdmin();
      toggleDisplay('ventasSeccion', true);
      toggleDisplay('resumenProductos', admin);
      toggleDisplay('adminUsuariosSection', admin);
      toggleDisplay('btnExportarExcel', admin);
      toggleDisplay('btnBorrarVentas', admin);
      toggleDisplay('btnResumenProductos', admin);
      toggleDisplay('btnCierreCaja', true);
      toggleDisplay('btnBaseCaja', true);

      const wrap = document.getElementById('filtroUsuarioWrap');
      if(wrap) wrap.classList.toggle('hidden', !admin);

      const thAcc = document.getElementById('thAcciones');
      if (thAcc) thAcc.classList.remove('hidden');

      toggleEfectivoSection();
      updateBaseBadge();
    }

    /********** BASE DE CAJA **********/
    function getBaseCajaLocal(){
      const data=JSON.parse(localStorage.getItem('baseCaja')||'null');
      if(!data) return null; if(data.fecha!==todayStr()) return null; return data;
    }
    function setBaseCajaLocal(counts){
      let monto=0; DENOMS.forEach(d=> monto += (counts[d]||0)*parseInt(d,10));
      const u=getSessionUser();
      const payload={ fecha:todayStr(), counts, monto, usuario:u?.username||'N/A', hora:new Date().toLocaleString() };
      localStorage.setItem('baseCaja', JSON.stringify(payload)); updateBaseBadge();
    }
    function updateBaseBadge(){
      const base=getBaseCajaLocal(); const el=document.getElementById('baseBadge');
      if(!el) return; el.textContent = base? `Base hoy: ${fmtMoney(base.monto)} (${base.usuario})` : `Base no registrada`; el.classList.remove('hidden');
    }
    function autoPromptBaseIfMissing(){ if(!getBaseCajaLocal()){ abrirModalBaseCaja(true); } }

    async function guardarBaseEnFirestore(counts, monto){
      const id=todayStr(); const u=getSessionUser();
      await setDoc(doc(collection(db,'bases'), id), {
        businessId:getBusinessId(), fecha:todayStr(), counts, monto, usuario:u?.username||'N/A', updatedAt:serverTimestamp(), createdAt:serverTimestamp()
      }, { merge:true });
      // espejo por usuario
      await setDoc(doc(collection(db,'users', u?.username||'anon','bases'), id), {
        businessId:getBusinessId(), fecha:todayStr(), counts, monto, usuario:u?.username||'N/A', updatedAt:serverTimestamp(), createdAt:serverTimestamp()
      }, { merge:true });
    }

    window.abrirModalBaseCaja = ()=>{
      const m=document.getElementById('modalBaseCaja'); m.classList.remove('hidden'); m.classList.add('flex');
      const baseHoy=getBaseCajaLocal(); DENOMS.forEach(d=> baseCounts[d]=baseHoy?.counts?.[d]||0);
      const cont=document.getElementById('baseDenomsContainer'); cont.innerHTML='';
      DENOMS.forEach(denom=>{
        const card=document.createElement('div'); card.className='relative flex flex-col items-center justify-center border rounded-xl p-3 shadow-sm bg-white';
        const btnAdd=document.createElement('button'); btnAdd.className='w-full text-center bg-yellow-300 hover:bg-yellow-400 active:bg-yellow-500 text-gray-800 font-semibold rounded-lg py-3 transition'; btnAdd.textContent=fmtMoney(parseInt(denom,10));
        const btnSub=document.createElement('button'); btnSub.type='button'; btnSub.title='Restar 1'; btnSub.textContent='â–'; btnSub.className='absolute top-1 right-1 text-xs px-2 py-1 rounded-md border bg-white hover:bg-gray-50';
        const counter=document.createElement('span'); counter.className='mt-2 text-sm font-medium text-gray-700'; counter.textContent=`x${baseCounts[denom]||0}`;
        btnAdd.addEventListener('click',()=>{ baseCounts[denom]=(baseCounts[denom]||0)+1; counter.textContent=`x${baseCounts[denom]}`; updateBaseTotal(); });
        btnSub.addEventListener('click',(e)=>{ e.stopPropagation(); baseCounts[denom]=Math.max(0,(baseCounts[denom]||0)-1); counter.textContent=`x${baseCounts[denom]}`; updateBaseTotal(); });
        card.append(btnAdd,btnSub,counter); cont.appendChild(card);
      });
      updateBaseTotal();
      const meta=document.getElementById('baseMetaInfo'); const baseInfo=getBaseCajaLocal();
      meta.textContent = baseInfo ? `Registrada por ${baseInfo.usuario} a las ${baseInfo.hora}.` : `No hay base registrada para hoy (${todayStr()}).`;
    };
    window.cerrarModalBaseCaja = ()=>{ const m=document.getElementById('modalBaseCaja'); m.classList.add('hidden'); m.classList.remove('flex'); };
    function updateBaseTotal(){ let t=0; DENOMS.forEach(d=> t+=(baseCounts[d]||0)*parseInt(d,10));
      const v1=document.getElementById('baseTotalValor'); const v2=document.getElementById('baseTotalTexto');
      if(v1) v1.textContent=fmtMoney(t); if(v2) v2.textContent=`Total base: ${fmtMoney(t)}`; }
    window.confirmarBaseCaja = async ()=>{
      setBaseCajaLocal(baseCounts);
      try{ let monto=0; DENOMS.forEach(d=> monto+=(baseCounts[d]||0)*parseInt(d,10)); await guardarBaseEnFirestore(structuredClone(baseCounts), monto); }catch(e){ console.warn('save base cloud err:',e); }
      alert('Base de caja guardada.'); cerrarModalBaseCaja();
    };

    /********** EFECTIVO / VUELTO **********/
    function buildMoneyButton(containerId, stateMap, totalLabelId){
      const cont=document.getElementById(containerId); cont.innerHTML='';
      DENOMS.forEach(denom=>{
        if(typeof stateMap[denom]!=='number') stateMap[denom]=0;
        const card=document.createElement('div'); card.className='relative flex flex-col items-center justify-center border rounded-xl p-3 shadow-sm bg-white';
        const btnAdd=document.createElement('button'); btnAdd.className='w-full text-center bg-yellow-300 hover:bg-yellow-400 active:bg-yellow-500 text-gray-800 font-semibold rounded-lg py-3 transition'; btnAdd.textContent=fmtMoney(parseInt(denom,10));
        const btnSub=document.createElement('button'); btnSub.type='button'; btnSub.title='Restar 1'; btnSub.textContent='â–'; btnSub.className='absolute top-1 right-1 text-xs px-2 py-1 rounded-md border bg-white hover:bg-gray-50';
        const counter=document.createElement('span'); counter.className='mt-2 text-sm font-medium text-gray-700'; counter.textContent=`x${stateMap[denom]}`;
        btnAdd.addEventListener('click',()=>{ stateMap[denom]=(stateMap[denom]||0)+1; counter.textContent=`x${stateMap[denom]}`; updateMoneyTotal(stateMap,totalLabelId); });
        btnSub.addEventListener('click',(e)=>{ e.stopPropagation(); stateMap[denom]=Math.max(0,(stateMap[denom]||0)-1); counter.textContent=`x${stateMap[denom]}`; updateMoneyTotal(stateMap,totalLabelId); });
        card.append(btnAdd,btnSub,counter); cont.appendChild(card);
      });
      updateMoneyTotal(stateMap,totalLabelId);
    }
    function updateMoneyTotal(stateMap,totalLabelId){
      let t=0; DENOMS.forEach(d=> t+=(stateMap[d]||0)*parseInt(d,10));
      const lab=document.getElementById(totalLabelId); if(lab) lab.textContent=fmtMoney(t);
      if(totalLabelId==='efTotalValor'){ const lbl=document.getElementById('ef_total'); if(lbl) lbl.textContent=`Efectivo ingresado: ${fmtMoney(t)}`; }
    }

    window.abrirModalEfectivoRecibido = ()=>{ const m=document.getElementById('modalEfectivo'); m.classList.remove('hidden'); m.classList.add('flex'); buildMoneyButton('efDenomsContainer', efCounts, 'efTotalValor'); };
    window.cerrarModalEfectivoRecibido = ()=>{ const m=document.getElementById('modalEfectivo'); m.classList.add('hidden'); m.classList.remove('flex'); };
    window.confirmarEfectivoRecibido = ()=>{ cerrarModalEfectivoRecibido(); };

    window.abrirModalVuelto = (vuelto)=>{
      const m=document.getElementById('modalVuelto'); m.classList.remove('hidden'); m.classList.add('flex');
      document.getElementById('vueltoRequeridoTexto').textContent=`Vuelto requerido: ${fmtMoney(vuelto)}`;
      const temp={}; DENOMS.forEach(d=> temp[d]=0);
      const box=document.getElementById('tablaVueltoUI'); box.innerHTML='';
      DENOMS.forEach(denom=>{
        const card=document.createElement('div'); card.className='relative flex flex-col items-center justify-center border rounded-xl p-3 shadow-sm bg-white';
        const btnAdd=document.createElement('button'); btnAdd.className='w-full text-center bg-yellow-300 hover:bg-yellow-400 active:bg-yellow-500 text-gray-800 font-semibold rounded-lg py-3 transition'; btnAdd.textContent=fmtMoney(parseInt(denom,10));
        const btnSub=document.createElement('button'); btnSub.type='button'; btnSub.title='Restar 1'; btnSub.textContent='â–'; btnSub.className='absolute top-1 right-1 text-xs px-2 py-1 rounded-md border bg-white hover:bg-gray-50';
        const counter=document.createElement('span'); counter.className='mt-2 text-sm font-medium text-gray-700'; counter.textContent='x0';
        const recalc=()=>{ let tot=0; DENOMS.forEach(d=> tot+=(temp[d]||0)*parseInt(d,10)); document.getElementById('totalDevueltoLabel').textContent=fmtMoney(tot); };
        btnAdd.addEventListener('click',()=>{ temp[denom]=(temp[denom]||0)+1; counter.textContent=`x${temp[denom]}`; recalc(); });
        btnSub.addEventListener('click',(e)=>{ e.stopPropagation(); temp[denom]=Math.max(0,(temp[denom]||0)-1); counter.textContent=`x${temp[denom]}`; recalc(); });
        card.dataset.denom=denom; card.append(btnAdd,btnSub,counter); box.appendChild(card);
      });
      document.getElementById('totalDevueltoLabel').textContent=fmtMoney(0);
      document.getElementById('modalVuelto').dataset.temp='1';
    };
    window.cerrarModalVuelto = ()=>{ const m=document.getElementById('modalVuelto'); m.classList.add('hidden'); m.classList.remove('flex'); ventaTemporal=null; };
    window.confirmarVuelto = ()=>{
      if(!ventaTemporal) return alert('No hay venta en proceso.');
      const box=document.getElementById('tablaVueltoUI'); const temp={}; let totalDev=0;
      Array.from(box.children).forEach(card=>{
        const denom=card.dataset.denom;
        const count=parseInt((card.querySelector('span')?.textContent||'x0').replace('x',''),10)||0;
        temp[denom]=count; totalDev += count*parseInt(denom,10);
      });
      if(totalDev!==ventaTemporal.vuelto){ alert(`El total ingresado (${fmtMoney(totalDev)}) no coincide con el vuelto requerido (${fmtMoney(ventaTemporal.vuelto)}).`); return; }
      const venta={ ...ventaTemporal, billetesDevueltos:temp, comanda: comandaEnEdicion ?? obtenerSiguienteComanda() };
      persistirVenta(venta).then(()=>{ comandaEnEdicion=null; ventaTemporal=null; cerrarModalVuelto(); alert('Venta guardada.'); limpiarPedido(); mostrarVentas(); const rp=document.getElementById('resumenProductos'); if(rp) rp.classList.add('hidden'); }).catch(()=> alert('Error guardando venta.'));
    };

    /********** GASTOS **********/
    window.abrirModalGasto = ()=>{
      const m=document.getElementById('modalGasto'); m.classList.remove('hidden'); m.classList.add('flex');
      DENOMS.forEach(d=> gastoCounts[d]=0);
      document.getElementById('gastoDescripcion').value=''; document.getElementById('gastoTotal').value='';
      buildMoneyButton('gastoDenomsContainer', gastoCounts, 'gastoEfectivoValor');
    };
    window.cerrarModalGasto = ()=>{ const m=document.getElementById('modalGasto'); m.classList.add('hidden'); m.classList.remove('flex'); };

    async function guardarGastoEnFirestore(payload){
      await addDoc(collection(db,'gastos'), { ...payload, createdAt:serverTimestamp() });
      await addDoc(collection(db,'users', payload.usuario||'anon', 'gastos'), { ...payload, createdAt:serverTimestamp() });
    }

    window.confirmarGasto = async ()=>{
      const desc=document.getElementById('gastoDescripcion').value.trim();
      const gastoTotal=parseInt(document.getElementById('gastoTotal').value||'0',10)||0;
      let pagadoEfectivo=0; DENOMS.forEach(d=> pagadoEfectivo += (gastoCounts[d]||0)*parseInt(d,10));
      if(!desc) return alert('Escribe la descripciÃ³n del gasto.'); if(gastoTotal<=0) return alert('Escribe el total del gasto.');

      // descontar de base local
      const baseHoy=getBaseCajaLocal() || { counts:{} };
      const nuevos={}; DENOMS.forEach(d=>{ const curr=baseHoy.counts[d]||0; const resta=gastoCounts[d]||0; nuevos[d]=Math.max(0, curr-resta); });
      setBaseCajaLocal(nuevos);
      try{ let monto=0; DENOMS.forEach(d=> monto+=(nuevos[d]||0)*parseInt(d,10)); await guardarBaseEnFirestore(structuredClone(nuevos), monto);}catch(e){console.warn('save base cloud err:',e);}

      const payload={ businessId:getBusinessId(), descripcion:desc, total:gastoTotal, pagadoEfectivo, billetesUsados:structuredClone(gastoCounts), fecha:new Date().toLocaleString(), usuario:getSessionUser()?.username||'N/A', tipo:'gasto' };
      try{ await guardarGastoEnFirestore(payload);}catch(e){ console.warn('save gasto cloud err:',e); }
      alert('Gasto registrado.'); cerrarModalGasto(); updateBaseBadge(); mostrarVentas();
    };

    /********** PEDIDOS **********/
    window.agregarProducto = (nombre, precio)=>{ pedido.push({nombre,precio}); actualizarTotal(); actualizarVistaPedido(); };
    window.quitarProducto  = (i)=>{ if(i>=0 && i<pedido.length){ pedido.splice(i,1); actualizarTotal(); actualizarVistaPedido(); } };
    function actualizarTotal(){ total=pedido.reduce((a,p)=>a+p.precio,0); }
    function actualizarVistaPedido(){
      const lista=document.getElementById('listaPedido'); lista.innerHTML='';
      pedido.forEach((p,i)=>{ const li=document.createElement('li'); li.innerHTML=`${p.nombre} - ${fmtMoney(p.precio)} <button onclick="quitarProducto(${i})" class='text-red-600 ml-2'>âŒ</button>`; lista.appendChild(li); });
      document.getElementById('total').textContent=`Total: ${fmtMoney(total)}`;
    }
    window.toggleEfectivoSection = ()=>{ /* modal se abre en onchange si es efectivo */ };
    function getEfectivoRecibidoFromState(){
      const recibidos={}; let totalRec=0; DENOMS.forEach(d=>{ const c=efCounts[d]||0; recibidos[d]=c; totalRec += c*parseInt(d,10); });
      const el=document.getElementById('ef_total'); if(el) el.textContent=`Efectivo ingresado: ${fmtMoney(totalRec)}`;
      return { billetesRecibidos:recibidos, totalRecibido:totalRec };
    }
    window.limpiarPedido = ()=>{
      pedido=[]; total=0; actualizarVistaPedido();
      ["cliente","formaPago","tipoPedido","observaciones"].forEach(id=>{ const el=document.getElementById(id); if(el) el.value=""; });
      const eftxt=document.getElementById('ef_total'); if(eftxt) eftxt.textContent="";
      DENOMS.forEach(d=> efCounts[d]=0);
    };

    /********** VENTAS **********/
    async function guardarVentaEnFirestore(venta){
      await addDoc(collection(db,'ventas'), { ...venta, createdAt:serverTimestamp() });
      await addDoc(collection(db,'users', venta.usuario||'anon', 'ventas'), { ...venta, createdAt:serverTimestamp() });
    }
    async function persistirVenta(venta){
      try{ await guardarVentaEnFirestore(venta); }catch(e){ console.warn('save venta cloud err:',e); }
      const ventas=JSON.parse(localStorage.getItem('ventas')||'[]'); ventas.push(venta); localStorage.setItem('ventas', JSON.stringify(ventas));
    }
    window.guardarVenta = async ()=>{
      if(!getSessionUser()){ showLoginModal(); return; }
      const cliente=document.getElementById('cliente').value.trim();
      const formaPago=document.getElementById('formaPago').value;
      const tipoPedido=document.getElementById('tipoPedido').value;
      if(pedido.length===0) return alert('Agrega productos al pedido.');
      if(!cliente) return alert('Por favor ingresa el nombre del cliente.');
      if(!formaPago) return alert('Por favor selecciona una forma de pago.');
      if(!tipoPedido) return alert('Por favor selecciona un tipo de pedido.');
      const observaciones=document.getElementById('observaciones').value.trim();
      const { billetesRecibidos, totalRecibido } = getEfectivoRecibidoFromState();
      let vuelto=0;
      if(formaPago==='Efectivo'){ if(totalRecibido<total) return alert(`Efectivo insuficiente. Faltan ${fmtMoney(total-totalRecibido)}.`); vuelto=totalRecibido-total; }
      else{ DENOMS.forEach(d=> billetesRecibidos[d]=0); }
      const baseVenta={ businessId:getBusinessId(), cliente, formaPago, tipoPedido, observaciones, pedido:[...pedido], total, fecha:new Date().toLocaleString(), billetesRecibidos, billetesDevueltos:{}, efectivoRecibido:totalRecibido, usuario:getSessionUser()?.username||'N/A', tipo:'venta' };
      if(formaPago==='Efectivo' && vuelto>0){ ventaTemporal={ ...baseVenta, vuelto, comanda:null }; abrirModalVuelto(vuelto); return; }
      const venta={ ...baseVenta, comanda: comandaEnEdicion ?? obtenerSiguienteComanda() };
      await persistirVenta(venta); comandaEnEdicion=null; alert('Venta guardada exitosamente.'); limpiarPedido(); mostrarVentas(); const rp=document.getElementById('resumenProductos'); if(rp) rp.classList.add('hidden');
    };

    /********** CONSULTAS (ventas+gastos) **********/
    function tsKey(d){ if(!d) return 0; if(typeof d==='number') return d; if(d.seconds!==undefined) return d.seconds*1000+Math.floor((d.nanoseconds||0)/1e6); return 0; }

    async function cargarVentasDesdeFirestore(){
      const qy=query(collection(db,'ventas'), where('businessId','==',getBusinessId()), orderBy('createdAt','desc'));
      const snap=await getDocs(qy);
      return snap.docs.map(d=>({ id:d.id, ...d.data() }));
    }
    async function cargarGastosDesdeFirestore(){
      const qy=query(collection(db,'gastos'), where('businessId','==',getBusinessId()), orderBy('createdAt','desc'));
      const snap=await getDocs(qy);
      return snap.docs.map(d=>({ id:d.id, ...d.data() }));
    }

    function aplicaFiltroUsuarioListado(items){
      const sel=document.getElementById('filtroUsuario');
      if(!isAdmin() || !sel) return items;
      const v=sel.value||'__todos__';
      if(v==='__todos__') return items;
      return items.filter(x=> (x.usuario||'').toLowerCase()===v.toLowerCase());
    }

    window.mostrarVentas = async ()=>{
      const cont=document.getElementById('ventasGuardadas'); if(!cont) return; cont.innerHTML='';
      let items=[];
      try{
        const [ventas,gastos]=await Promise.all([cargarVentasDesdeFirestore(), cargarGastosDesdeFirestore()]);
        items=[...ventas, ...gastos];
      }catch(e){
        console.warn('Fallo lectura Firestore, uso LocalStorage:', e);
        items = JSON.parse(localStorage.getItem('ventas')||'[]'); // fallback solo ventas
      }

      // Filtro por admin (usuario seleccionado)
      items = aplicaFiltroUsuarioListado(items);

      // Si no es admin, solo sus datos
      if(!isAdmin()){
        const me=getSessionUser()?.username||'';
        items = items.filter(v=> (v.usuario||'')===me);
      }

      // Filtro texto
      const filtro=(document.getElementById('filtroCliente')?.value||'').toLowerCase();

      // Orden (createdAt desc si estÃ¡)
      items.sort((a,b)=> tsKey(b.createdAt)-tsKey(a.createdAt));

      // cache espejo local (para impresiÃ³n/cierre)
      localStorage.setItem('ventasTabla', JSON.stringify(items));

      items.forEach((v,i)=>{
        const isGasto = v.tipo==='gasto';
        if (filtro) {
          const match = [v.cliente||'', v.descripcion||'', v.usuario||''].join(' ').toLowerCase();
          if (!match.includes(filtro)) return;
        }
        let productosResumen='';
        if(!isGasto){
          const r={}; (v.pedido||[]).forEach(p=> r[p.nombre]=(r[p.nombre]||0)+1 );
          productosResumen = Object.entries(r).map(([n,c])=>`${n}: ${c}`).join('<br>');
        } else {
          productosResumen = `DESC: ${v.descripcion||''} Â· Pagado: ${fmtMoney(v.pagadoEfectivo||0)}`;
        }
        const clienteTxt = isGasto ? (v.usuario||'') : (v.cliente||'');
        const formaTxt   = isGasto ? 'Efectivo/Salida' : (v.formaPago||'');
        const tipoTxt    = isGasto ? 'â€”' : (v.tipoPedido||'');
        const totalTxt   = isGasto ? `- ${fmtMoney(v.total||v.pagadoEfectivo||0)}` : `${fmtMoney(v.total||0)}`;
        const acciones   = isGasto ? `<span class="text-xs text-gray-400">â€”</span>` :
          `<button onclick="imprimirVentaCliente(${i})" class="bg-purple-500 text-white px-2 py-1 rounded text-xs">ğŸ§¾ Cliente</button>
           <button onclick="imprimirVentaCocina(${i})" class="bg-blue-500 text-white px-2 py-1 rounded text-xs">ğŸ‘¨â€ğŸ³ Cocina</button>
           ${isAdmin()? `<button onclick="editarVenta(${i})" class="bg-yellow-600 text-white px-2 py-1 rounded text-xs">ğŸ“ Editar</button>`:''}`;
        cont.innerHTML += `
          <tr>
            <td class='border p-1'>${v.comanda ?? (i+1)}</td>
            <td class='border p-1 whitespace-nowrap'>${v.fecha||''}</td>
            <td class='border p-1'>${v.usuario||''}</td>
            <td class='border p-1'>${clienteTxt}</td>
            <td class='border p-1'>${formaTxt}</td>
            <td class='border p-1'>${tipoTxt}</td>
            <td class='border p-1'>${productosResumen}</td>
            <td class='border p-1'>${totalTxt}</td>
            <td class='border p-1 space-x-1'>${acciones}</td>
          </tr>`;
      });

      // ademÃ¡s, guarda sÃ³lo ventas para impresiones por Ã­ndice
      const ventasSolo = items.filter(x=> x.tipo!=='gasto');
      localStorage.setItem('ventas', JSON.stringify(ventasSolo));
    };

    window.filtrarVentasPorCliente = ()=>{ mostrarVentas(); };

    /********** EXPORTAR **********/
    window.exportarVentasExcelConEstilo = async ()=>{
      if(!isAdmin()){ alert("Solo el Administrador puede exportar a Excel."); return; }
      let ventas=[]; let gastos=[];
      try{ [ventas,gastos] = await Promise.all([
        cargarVentasDesdeFirestore(),
        cargarGastosDesdeFirestore()
      ]);}catch{}
      ventas = aplicaFiltroUsuarioListado(ventas);
      gastos = aplicaFiltroUsuarioListado(gastos);
      if( !ventas.length && !gastos.length ){ return alert("No hay datos para exportar."); }

      const wb=new ExcelJS.Workbook();

      // Ventas
      const s=wb.addWorksheet('Ventas del DÃ­a');
      const H=["#","Fecha","Usuario","Cliente","Forma de Pago","Tipo de Pedido","Producto","Precio (COP)","Total Venta (COP)"];
      s.addRow(H);
      let totalGlobal=0; const conteo={};
      ventas.forEach((v,i)=>{ const {fecha,cliente,formaPago,tipoPedido,total,pedido,usuario}=v; totalGlobal += parseFloat(total)||0;
        (pedido||[]).forEach(p=>{ s.addRow([v.comanda??(i+1), fecha, usuario, cliente, formaPago, tipoPedido, p.nombre, parseFloat(p.precio), parseFloat(total)]); conteo[p.nombre]=(conteo[p.nombre]||0)+1; });
      });
      s.getRow(1).eachCell(c=>{ c.fill={type:'pattern',pattern:'solid',fgColor:{argb:'FF1F4E78'}}; c.font={color:{argb:'FFFFFFFF'},bold:true}; c.alignment={vertical:'middle',horizontal:'center'}; c.border={top:{style:'thin'},bottom:{style:'thin'},left:{style:'thin'},right:{style:'thin'}}; });
      for(let r=2;r<=s.rowCount;r++){ const row=s.getRow(r); const even=r%2===0; row.eachCell(c=>{ c.fill={type:'pattern',pattern:'solid',fgColor:{argb:even?'FFF2F2F2':'FFFFFFFF'}}; c.border={top:{style:'thin'},bottom:{style:'thin'},left:{style:'thin'},right:{style:'thin'}}; }); row.getCell(8).numFmt='"$"#,##0'; row.getCell(9).numFmt='"$"#,##0'; }
      s.addRow([]); const tr=s.addRow(["","","","","","TOTAL DEL DÃA:","",totalGlobal]); tr.getCell(9).numFmt='"$"#,##0'; tr.font={bold:true};
      let prodMas="", max=0; for(const [k,v] of Object.entries(conteo)){ if(v>max){ max=v; prodMas=k; } }
      const r2=s.addRow(["","","","","","Producto mÃ¡s vendido:","",`${prodMas} (${max})`]); r2.font={italic:true};
      s.columns.forEach(c=> c.width=18);

      // Gastos
      const sg=wb.addWorksheet('Gastos del DÃ­a');
      const Hg=["Fecha","Usuario","DescripciÃ³n","Pagado en efectivo (COP)","Total (COP)"];
      sg.addRow(Hg);
      let totalG=0;
      gastos.forEach(g=>{ totalG += parseFloat(g.total||g.pagadoEfectivo||0)||0;
        sg.addRow([g.fecha||"", g.usuario||"", g.descripcion||"", parseFloat(g.pagadoEfectivo||0), parseFloat(g.total||g.pagadoEfectivo||0)]); });
      sg.getRow(1).eachCell(c=>{ c.fill={type:'pattern',pattern:'solid',fgColor:{argb:'FF7F1D1D'}}; c.font={color:{argb:'FFFFFFFF'},bold:true}; c.alignment={vertical:'middle',horizontal:'center'}; c.border={top:{style:'thin'},bottom:{style:'thin'},left:{style:'thin'},right:{style:'thin'}}; });
      for(let r=2;r<=sg.rowCount;r++){ const row=sg.getRow(r); const even=r%2===0; row.eachCell(c=>{ c.fill={type:'pattern',pattern:'solid',fgColor:{argb:even?'FFFDECEC':'FFFFFFFF'}}; c.border={top:{style:'thin'},bottom:{style:'thin'},left:{style:'thin'},right:{style:'thin'}}; }); row.getCell(4).numFmt='"$"#,##0'; row.getCell(5).numFmt='"$"#,##0'; }
      sg.addRow([]); const trg=sg.addRow(["","","TOTAL GASTOS DEL DÃA:","",totalG]); trg.getCell(5).numFmt='"$"#,##0'; trg.font={bold:true};
      sg.columns.forEach(c=> c.width=22);

      const buffer=await wb.xlsx.writeBuffer();
      const blob=new Blob([buffer],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"});
      const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url;
      const d=new Date(); a.download=`Ventas_y_Gastos_${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}.xlsx`;
      document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    };

    /********** CIERRE **********/
    window.cierreDeCaja = ()=>{
      const items=JSON.parse(localStorage.getItem('ventasTabla')||'[]'); // combinados
      const base=getBaseCajaLocal(); const sumRec={}, sumDev={}, sumNet={}, finalCounts={};
      let montoRec=0,montoDev=0,montoNet=0,montoBase=0,montoFinal=0;
      DENOMS.forEach(d=>{sumRec[d]=0;sumDev[d]=0;sumNet[d]=0;finalCounts[d]=0;});
      items.filter(v=>v.tipo==='venta').forEach(v=>{ DENOMS.forEach(d=>{ sumRec[d]+=(v.billetesRecibidos?.[d]||0); sumDev[d]+=(v.billetesDevueltos?.[d]||0); }); });
      DENOMS.forEach(d=>{
        sumNet[d]=sumRec[d]-sumDev[d];
        const baseCnt=base?.counts?.[d]||0;
        finalCounts[d]=baseCnt+sumNet[d];
        montoRec += sumRec[d]*parseInt(d,10);
        montoDev += sumDev[d]*parseInt(d,10);
        montoNet += sumNet[d]*parseInt(d,10);
        montoBase+= baseCnt*parseInt(d,10);
        montoFinal+= finalCounts[d]*parseInt(d,10);
      });
      const html=`<html><head><title>Cierre de Caja</title><style>
      body{font-family:monospace;font-size:12px;width:76mm;padding:10px 12px;margin:0}
      h2{text-align:center;font-size:18px;margin:8px 0;font-weight:bold}
      .line{border-top:1px dashed #000;margin:8px 0}
      table{width:100%;border-collapse:collapse} th,td{padding:4px 2px;text-align:right}
      th:first-child,td:first-child{text-align:left} .totales p{margin:3px 0;font-weight:bold} .foot{text-align:center;margin-top:10px}
      </style></head><body>
      <h2>CIERRE DE CAJA</h2><p>Fecha: ${new Date().toLocaleString()}</p><div class="line"></div>
      <table><thead><tr><th>Denom</th><th>Base</th><th>Rec</th><th>Dev</th><th>Neto</th><th>Final</th><th>$ Final</th></tr></thead><tbody>
      ${DENOMS.map(d=>{ const baseCnt=base?.counts?.[d]||0; const rec=sumRec[d], dev=sumDev[d], net=sumNet[d], fin=finalCounts[d]; const montoFin=fin*parseInt(d,10);
        return `<tr><td>${parseInt(d,10).toLocaleString('es-CO')}</td><td>${baseCnt}</td><td>${rec}</td><td>${dev}</td><td>${net}</td><td>${fin}</td><td>${fmtMoney(montoFin)}</td></tr>`;}).join('')}
      </tbody></table><div class="line"></div>
      <div class="totales"><p>Base de Caja: ${fmtMoney(montoBase)} ${base?`(${base.usuario} - ${base.hora})`:'(no registrada)'}</p>
      <p>Efectivo Recibido Ventas: ${fmtMoney(montoRec)}</p><p>Efectivo Devuelto: ${fmtMoney(montoDev)}</p><p>Neto por Ventas: ${fmtMoney(montoNet)}</p>
      <p>Total Esperado en Caja (Base + Neto): ${fmtMoney(montoFinal)}</p></div><div class="line"></div><p class="foot">Gracias. â€” SeÃ±or Arepa</p>
      <script>window.print();<\/script></body></html>`;
      const w=window.open('','_blank','width=460,height=720'); w.document.write(html); w.document.close(); w.focus();
    };

    /********** IMPRESIONES **********/
    window.imprimirUltimaCocinero = ()=>{
      const ventas=JSON.parse(localStorage.getItem("ventas")||"[]");
      if(ventas.length===0) return alert("No hay ventas para imprimir.");
      const v=ventas[ventas.length-1];
      const resumen={}; (v.pedido||[]).forEach(p=> resumen[p.nombre]=(resumen[p.nombre]||0)+1 );
      const contenido = `
        <!DOCTYPE html><html><head><style>
          body{font-family:monospace;font-size:15px;margin:0;padding:11px;}
          h2{text-align:center;font-size:19px;margin-bottom:11px;}
          .info{margin-bottom:10px;} .info p{margin:2px 0;}
          ul{list-style:none;padding:0;margin:0;} li{padding:4px 0;border-bottom:2px dashed #000;font-size:19px;}
        </style></head><body>
          <h2>ğŸ§¾ PEDIDO A COCINA</h2>
          <div class="info">
            <p style="text-align:center;font-weight:bold;margin:6px 0;">COMANDA #${v.comanda ?? ventas.length}</p>
            <p><strong>Cliente:</strong> ${v.cliente || "Sin nombre"}</p>
            <p><strong>Hora:</strong> ${v.fecha || "Sin hora"}</p>
            <p><strong>Tipo de Pedido:</strong> ${v.tipoPedido || "-"}</p>
            ${v.observaciones ? `<p><strong>Observaciones:</strong> ${v.observaciones}</p>` : ""}
          </div>
          <ul>${Object.entries(resumen).map(([producto, cantidad]) => `<li>${producto} x${cantidad}</li>`).join("")}</ul>
          <p style="text-align:center;margin-top:10px;">ğŸ‘¨â€ğŸ³ Preparar con cuidado</p>
          <script>window.print();<\/script>
        </body></html>`;
      const w=window.open("", "_blank", "width=400,height=600"); w.document.write(contenido); w.document.close(); w.focus();
    };
    window.imprimirUltimaCliente = ()=>{
      const ventas=JSON.parse(localStorage.getItem("ventas")||"[]");
      if(ventas.length===0) return alert("No hay ventas para imprimir.");
      const v=ventas[ventas.length-1];
      const contenido = `
        <html><head><title>Recibo Cliente</title><style>
          body{font-family:monospace;font-size:14px;width:58mm;padding:10px 12px;margin:0;line-height:1.5;}
          h2{text-align:center;font-size:19px;margin:14px 0 5px;font-weight:bold;}
          .sub-info{text-align:center;font-size:12px;margin-bottom:10px;line-height:1.3;}
          .line{border-top:1px dashed #000;margin:9px 0;} ul{list-style:none;padding:0;margin:0;} li{margin-bottom:7px;}
          .total{text-align:right;font-weight:bold;margin-top:14px;font-size:16px;} .info p{margin:6px 0;} .info strong{font-weight:bold;}
          p.thanks{text-align:center;margin-top:22px;font-weight:bold;font-size:15px;}
        </style></head><body>
          <h2>SEÃ‘OR AREPA</h2>
          <div class="sub-info">MatrÃ­cula No 289546<br>CALLE 19#25-03 ESQUINA<br>BARRIO SAN JOSÃ‰, ARMENIA</div>
          <div class="line"></div>
          <div class="info">
            <p style="text-align:center;font-weight:bold;margin:6px 0;">RECIBO #${v.comanda ?? ventas.length}</p>
            <p style="text-align:center;font-weight:bold;margin:6px 0;">COMANDA #${v.comanda ?? ventas.length}</p>
            <p><strong>Cliente:</strong> ${v.cliente || "N/A"}</p>
            <p><strong>Fecha:</strong> ${v.fecha}</p>
            <p><strong>Tipo de Pedido:</strong> ${v.tipoPedido || "-"}</p>
            ${v.observaciones ? `<p><strong>Observaciones:</strong> ${v.observaciones}</p>` : ""}
          </div>
          <div class="line"></div>
          <ul>${(v.pedido||[]).map(p => `<li>${p.nombre} - ${fmtMoney(p.precio)}</li>`).join("")}</ul>
          <div class="line"></div>
          <p class="total">Total: ${fmtMoney(v.total||0)}</p>
          <div class="line"></div>
          <p class="thanks">Â¡Gracias por su compra!</p>
          <script>window.print();<\/script>
        </body></html>`;
      const w=window.open("", "_blank", "width=400,height=600"); w.document.write(contenido); w.document.close(); w.focus();
    };
    window.imprimirVentaCliente = (index)=>{
      const ventas=JSON.parse(localStorage.getItem("ventas")||"[]"); const v=ventas[index]; if(!v) return alert("Venta no encontrada.");
      const contenido = `
        <html><head><title>Recibo Cliente</title><style>
          body{font-family:monospace;font-size:14px;width:58mm;padding:10px 12px;margin:0;line-height:1.5;}
          h2{text-align:center;font-size:19px;margin:14px 0;font-weight:bold;}
          .line{border-top:1px dashed #000;margin:9px 0;} ul{list-style:none;padding:0;margin:0;} li{margin-bottom:7px;}
          .total{text-align:right;font-weight:bold;margin-top:14px;font-size:16px;} .info p{margin:6px 0;} .info strong{font-weight:bold;}
          p.thanks{text-align:center;margin-top:22px;font-weight:bold;font-size:15px;}
        </style></head><body>
          <h2>SEÃ‘OR AREPA</h2>
          <div class="line"></div>
          <div class="info">
            <p style="text-align:center;font-weight:bold;margin:6px 0;">RECIBO #${v.comanda ?? (index + 1)}</p>
            <p style="text-align:center;font-weight:bold;margin:6px 0;">COMANDA #${v.comanda ?? (index + 1)}</p>
            <p><strong>Cliente:</strong> ${v.cliente || "N/A"}</p>
            <p><strong>Fecha:</strong> ${v.fecha}</p>
            <p><strong>Tipo de Pedido:</strong> ${v.tipoPedido || "-"}</p>
            ${v.observaciones ? `<p><strong>Observaciones:</strong> ${v.observaciones}</p>` : ""}
          </div>
          <div class="line"></div>
          <ul>${(v.pedido||[]).map(p => `<li>${p.nombre} - ${fmtMoney(p.precio)}</li>`).join("")}</ul>
          <div class="line"></div>
          <p class="total">Total: ${fmtMoney(v.total||0)}</p>
          <div class="line"></div>
          <p class="thanks">Â¡Gracias por su compra!</p>
          <script>window.print();<\/script>
        </body></html>`;
      const w=window.open("", "_blank", "width=400,height=600"); w.document.write(contenido); w.document.close(); w.focus();
    };

    /********** EDITAR / COMANDA **********/
    window.editarVenta = (index)=>{
      if(!isAdmin()){ alert('Solo el Administrador puede editar ventas.'); return; }
      const ventas=JSON.parse(localStorage.getItem('ventas')||'[]');
      const v=ventas[index];
      if(!v) return alert('Venta no encontrada.');
      document.getElementById('cliente').value=v.cliente||''; document.getElementById('formaPago').value=v.formaPago||''; document.getElementById('tipoPedido').value=v.tipoPedido||''; document.getElementById('observaciones').value=v.observaciones||'';
      pedido=[...(v.pedido||[])]; total=v.total||0; actualizarVistaPedido(); comandaEnEdicion=v.comanda??null;
      ventas.splice(index,1); localStorage.setItem('ventas', JSON.stringify(ventas));
      mostrarVentas(); alert("Venta cargada para ediciÃ³n. Haz los cambios y presiona 'Guardar Venta'.");
    };
    window.obtenerSiguienteComanda = ()=>{
      const key="ultimoNumeroComanda"; const ultimo=parseInt(localStorage.getItem(key)||'0',10); const siguiente=ultimo+1; localStorage.setItem(key,String(siguiente)); return siguiente;
    };

    /********** ADMIN: crear / eliminar **********/
    window.addUserFromForm = async (e)=>{
      e.preventDefault();
      if(!isAdmin()){ alert('Solo el Administrador puede gestionar usuarios.'); return false; }
      const username=document.getElementById('newUsername').value.trim();
      const password=document.getElementById('newPassword').value;
      const role    =document.getElementById('newRole').value;
      if(!username||!password){ alert('Usuario y contraseÃ±a requeridos.'); return false; }
      try{
        const exists=await getUserDoc(username);
        if(exists && exists.businessId===getBusinessId()){ alert('Ese usuario ya existe en este negocio.'); return false; }
        const h=await hashPassword(password);
        await upsertUserProfile(username, role, h);
        alert('Usuario agregado en la nube.');
        document.getElementById('newUsername').value='';
        document.getElementById('newPassword').value='';
        document.getElementById('newRole').value='cajero';
        await renderUsersTable();
      }catch(err){ console.warn(err); alert('No se pudo crear el usuario.'); }
      return false;
    };

    window.deleteUser = async (username)=>{
      if(!isAdmin()){ alert('Solo el Administrador puede eliminar usuarios.'); return; }
      const me=getSessionUser();
      if(me && me.username===username){ alert('No puedes eliminar tu propia cuenta.'); return; }
      try{
        const target=await getUserDoc(username);
        if(!target){ alert('El usuario no existe.'); return; }
        if(target.role==='admin'){
          const admins = await countAdmins();
          if(admins<=1){ alert('Debe existir al menos un administrador.'); return; }
        }
        // Deshabilitar para preservar historial
        await setDoc(doc(collection(db,'users'), username), { disabled:true, updatedAt:serverTimestamp() }, { merge:true });
        alert('Usuario deshabilitado. (Se conserva para historial)');
        await renderUsersTable();
      }catch(err){ console.warn(err); alert('No se pudo eliminar/deshabilitar el usuario.'); }
    };

    /********** RESUMEN / BORRAR **********/
    window.generarResumenProductos = ()=>{
      if(!isAdmin()){ alert('Solo el Administrador puede ver resumen de productos.'); return; }
      const items=JSON.parse(localStorage.getItem('ventasTabla')||'[]').filter(x=>x.tipo==='venta');
      const r={}; items.forEach(v=> (v.pedido||[]).forEach(p=> r[p.nombre]=(r[p.nombre]||0)+1 ));
      const ul=document.getElementById('listaResumen'); ul.innerHTML=Object.entries(r).map(([n,c])=>`<li>${n}: ${c}</li>`).join(''); document.getElementById('resumenProductos').classList.remove('hidden');
    };
    window.borrarVentas = ()=>{
      if(!isAdmin()){ alert('Solo el Administrador puede borrar ventas locales.'); return; }
      if(confirm('Â¿Seguro que deseas borrar el cache local?')){ localStorage.removeItem('ventas'); localStorage.removeItem('ventasTabla'); mostrarVentas(); alert('Cache local borrado. (Cloud se mantiene)'); }
    };

    /********** INIT **********/
    window.onload = async ()=>{
      try{ await ensureDefaultUsersInFirestore(); }catch{}
      const u=getSessionUser();
      if(!u) showLoginModal(); else hideLoginModal();
      applyRoleUI();
      await renderUsersTable();
      try{ await mostrarVentas(); }catch(e){ console.warn(e); }
      if(u) autoPromptBaseIfMissing();
    };
  </script>
</body>
</html>
