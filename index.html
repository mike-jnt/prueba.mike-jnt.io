<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SEÃ‘OR AREPA â€” v5.1 (Firestore)</title>
  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Excel export -->
  <script src="https://cdn.jsdelivr.net/npm/exceljs/dist/exceljs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
</head>

<body class="bg-yellow-50 font-sans">

  <!-- NAV -->
  <nav class="bg-yellow-400 p-4 flex justify-between items-center text-white font-bold text-lg">
    <div class="flex items-center space-x-2">
      <img src="imagenes/senora.png"
           alt="Logo SeÃ±or Arepa"
           class="w-20 h-20 rounded-full object-cover"
           onerror="this.onerror=null;this.src='data:image/svg+xml;utf8,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%2280%22 height=%2280%22><rect width=%2280%22 height=%2280%22 fill=%22%23fde68a%22/><text x=%2250%25%22 y=%2250%22 dominant-baseline=%22middle%22 text-anchor=%22middle%22 font-family=%22Arial%22 font-size=%2210%22 fill=%22%236b7280%22>Logo</text></svg>';"/>
      <span class="text-xl">SEÃ‘OR AREPA</span>
    </div>
    <div class="flex items-center gap-3">
      <a href="finanzas1.html" class="bg-white text-yellow-700 font-semibold px-3 py-1 rounded-lg shadow hover:bg-yellow-100 transition" target="_blank">
        ğŸ“‹ Finanzas
      </a>
      <a href="inventario.html" class="bg-yellow-600 text-white font-semibold px-3 py-1 rounded-lg shadow hover:bg-yellow-700 transition" target="_blank">
        ğŸ“† Inventario
      </a>
      <span id="baseBadge" class="hidden md:inline text-sm bg-teal-600/80 px-2 py-1 rounded"></span>
      <span id="currentUserBadge" class="hidden md:inline text-sm bg-yellow-700/80 px-2 py-1 rounded"></span>
      <button id="btnLogout" onclick="logout()" class="hidden bg-yellow-700 text-white px-3 py-1 rounded">Salir</button>
    </div>
  </nav>

  <!-- MAIN -->
  <main class="p-6">
    <h2 class="text-2xl font-bold text-gray-700 mb-4">MenÃº</h2>
    <div id="productos" class="grid grid-cols-1 md:grid-cols-3 gap-4">
      <!-- Comida -->
      <div class="bg-white p-4 rounded-xl shadow-md">
        <h3 class="text-xl font-semibold text-yellow-600 mb-2">Comida</h3>
        <div class="grid grid-cols-2 gap-2">
          <button onclick="agregarProducto('AREPA PAISA', 17000)" class="bg-yellow-300 hover:bg-yellow-400 p-2 rounded">âšª PAISA - $17.000</button>
          <button onclick="agregarProducto('AREPA PAISA POLLO', 17000)" class="bg-yellow-300 hover:bg-yellow-400 p-2 rounded">âšª PAISA POLLO - $17.000</button>
          <button onclick="agregarProducto('AREPA CHICHARRON', 14000)" class="bg-yellow-300 hover:bg-yellow-400 p-2 rounded">âšª CHICHARRON - $14.000</button>
          <button onclick="agregarProducto('AREPA EXTRA QUESILLO', 9000)" class="bg-yellow-300 hover:bg-yellow-400 p-2 rounded">âšª EXTRA QUESILLO - $9.000</button>
          <button onclick="agregarProducto('AREPA SEÃ‘OR AREPA', 14000)" class="bg-yellow-300 hover:bg-yellow-400 p-2 rounded">âšª SEÃ‘OR AREPA - $14.000</button>
          <button onclick="agregarProducto('AREPA SEÃ‘ORA AREPA', 14000)" class="bg-yellow-300 hover:bg-yellow-400 p-2 rounded">âšª SEÃ‘ORA AREPA - $14.000</button>
          <button onclick="agregarProducto('AREPA HAWAIANA', 14000)" class="bg-yellow-300 hover:bg-yellow-400 p-2 rounded">âšª HAWAIANA - $14.000</button>
          <button onclick="agregarProducto('AREPA MEGAPAISA', 22000)" class="bg-yellow-300 hover:bg-yellow-400 p-2 rounded">âšª MEGAPAISA- $22.000</button>
          <button onclick="agregarProducto('AREPA MIXTA', 14000)" class="bg-yellow-300 hover:bg-yellow-400 p-2 rounded">âšª MIXTA - $14.000</button>
          <button onclick="agregarProducto('AREPA RANCHERA', 14000)" class="bg-yellow-300 hover:bg-yellow-400 p-2 rounded">âšª RANCHERA - $14.000</button>
          <button onclick="agregarProducto('AREPA SOLO POLLO', 15000)" class="bg-yellow-300 hover:bg-yellow-400 p-2 rounded">âšª SOLO POLLO - $15.000</button>
          <button onclick="agregarProducto('AREPA SOLO CARNE', 15000)" class="bg-yellow-300 hover:bg-yellow-400 p-2 rounded">âšª SOLO CARNE - $15.000</button>
          <button onclick="agregarProducto('AREPA MEXICANA', 15000)" class="bg-yellow-300 hover:bg-yellow-400 p-2 rounded">âšª MEXICANA - $15.000</button>
          <button onclick="agregarProducto('AREPA SOLA', 1000)" class="bg-yellow-300 hover:bg-yellow-400 p-2 rounded">âšª AREPA SOLA - $1.000</button>
        </div>
      </div>

      <!-- Adiciones -->
      <div class="bg-white p-4 rounded-xl shadow-md">
        <h3 class="text-xl font-semibold text-yellow-600 mb-2">Adiciones</h3>
        <div class="grid grid-cols-2 gap-2">
          <button onclick="agregarProducto('ADICION QUESO EXTRA', 5000)" class="bg-yellow-300 hover:bg-yellow-400 p-2 rounded">ğŸ§€ Queso Extra - $5.000</button>
          <button onclick="agregarProducto('ADICION MAIZ TIERNO', 3000)" class="bg-yellow-300 hover:bg-yellow-400 p-2 rounded">ğŸŒ½ MAIZ TIERNO - $3.000</button>
          <button onclick="agregarProducto('ADICION PIÃ‘A CALADA', 5000)" class="bg-yellow-300 hover:bg-yellow-400 p-2 rounded">ğŸ PIÃ‘A CALADA - $5.000</button>
          <button onclick="agregarProducto('ADICION POLLO', 7000)" class="bg-yellow-300 hover:bg-yellow-400 p-2 rounded">ğŸ— POLLO - $7.000</button>
          <button onclick="agregarProducto('ADICION CARNE', 7000)" class="bg-yellow-300 hover:bg-yellow-400 p-2 rounded">ğŸ¥© CARNE - $7.000</button>
          <button onclick="agregarProducto('ADICION CHICHARRON', 6000)" class="bg-yellow-300 hover:bg-yellow-400 p-2 rounded">ğŸ– CHICHARRON - $6.000</button>
          <button onclick="agregarProducto('ADICION RANCHERA', 7000)" class="bg-yellow-300 hover:bg-yellow-400 p-2 rounded">ğŸ”¥ RANCHERA - $7.000</button>
          <button onclick="agregarProducto('ADICION CHORIZO', 7000)" class="bg-yellow-300 hover:bg-yellow-400 p-2 rounded">ğŸŒ­ CHORIZO - $7.000</button>
          <button onclick="agregarProducto('ADICION TOCINETA', 7000)" class="bg-yellow-300 hover:bg-yellow-400 p-2 rounded">ğŸ¥“ TOCINETA - $7.000</button>
          <button onclick="agregarProducto('ADICION MADURO', 3000)" class="bg-yellow-300 hover:bg-yellow-400 p-2 rounded">ğŸŒ  MADURO - $3.000</button>
          <button onclick="agregarProducto('ADICION ARMA TU AREPA X5', 25000)" class="bg-yellow-300 hover:bg-yellow-400 p-2 rounded">ğŸŒ ARMA TU AREPA - $25.000</button>
        </div>
      </div>

      <!-- Bebidas -->
      <div class="bg-white p-4 rounded-xl shadow-md">
        <h3 class="text-xl font-semibold text-yellow-600 mb-2">Bebidas</h3>
        <div class="grid grid-cols-2 gap-2">
          <button onclick="agregarProducto('QUATRO', 4000)" class="bg-yellow-300 hover:bg-yellow-400 p-2 rounded">ğŸ‹ QUATRO - $4.000</button>
          <button onclick="agregarProducto('COCA COLA 400 ml', 4000)" class="bg-yellow-300 hover:bg-yellow-400 p-2 rounded">ğŸ¥¤ COCA COLA - $4.000</button>
          <button onclick="agregarProducto('COCA COLA 250 ml', 3000)" class="bg-yellow-300 hover:bg-yellow-400 p-2 rounded">ğŸ¥¤ COCA COLA - $3.000</button>
          <button onclick="agregarProducto('JUGO HIT 500 ml', 4000)" class="bg-yellow-300 hover:bg-yellow-400 p-2 rounded">ğŸ¥¤ JUGO HIT - $4.000</button>
          <button onclick="agregarProducto('SPRITE', 4000)" class="bg-yellow-300 hover:bg-yellow-400 p-2 rounded">ğŸ¥¤ SPRITE - $4.000</button>
          <button onclick="agregarProducto('COCA COLA CERO', 4000)" class="bg-yellow-300 hover:bg-yellow-400 p-2 rounded">ğŸ¥¤ COCA COLA CERO - $4.000</button>
          <button onclick="agregarProducto('BRISA LIMON', 4000)" class="bg-yellow-300 hover:bg-yellow-400 p-2 rounded">ğŸ¥¤ BRISA LIMON - $4.000</button>
          <button onclick="agregarProducto('BRISA MANZANA', 4000)" class="bg-yellow-300 hover:bg-yellow-400 p-2 rounded">ğŸ’§ BRISA MANZANA - $4.000</button>
          <button onclick="agregarProducto('MISTER TEA', 4000)" class="bg-yellow-300 hover:bg-yellow-400 p-2 rounded">ğŸ¥¤ MISTER TEA - $4.000</button>
          <button onclick="agregarProducto('AGUA CON GAS', 4000)" class="bg-yellow-300 hover:bg-yellow-400 p-2 rounded">ğŸ¥¤ AGUA CON GAS - $4.000</button>
          <button onclick="agregarProducto('AGUA SABORISADA', 4000)" class="bg-yellow-300 hover:bg-yellow-400 p-2 rounded">ğŸ¥¤ AGUA SABORISADA - $4.000</button>
          <button onclick="agregarProducto('POSTOBON 400 ml', 4000)" class="bg-yellow-300 hover:bg-yellow-400 p-2 rounded">ğŸ¥¤ POSTOBON 400 - $4.000</button>
          <button onclick="agregarProducto('POSTOBON 250 ml', 3000)" class="bg-yellow-300 hover:bg-yellow-400 p-2 rounded">ğŸ¥¤ POSTOBON 250 - $3.000</button>
          <button onclick="agregarProducto('POSTOBON 1.5', 9000)" class="bg-yellow-300 hover:bg-yellow-400 p-2 rounded">ğŸ¥¤ POSTOBON 1.5 - $9.000</button>
          <button onclick="agregarProducto('SODA BRETAÃ‘A', 4500)" class="bg-yellow-300 hover:bg-yellow-400 p-2 rounded">ğŸ¥¤ SODA BRETAÃ‘A - $4.500</button>
          <button onclick="agregarProducto('GATORADE', 6000)" class="bg-yellow-300 hover:bg-yellow-400 p-2 rounded">ğŸ¥¤ GATORADE - $6.000</button>
          <button onclick="agregarProducto('PREMIO 400 ml', 4000)" class="bg-yellow-300 hover:bg-yellow-400 p-2 rounded">ğŸ¥¤ PREMIO 400 ml - $4.000</button>
          <button onclick="agregarProducto('PREMIO 1.5l', 9000)" class="bg-yellow-300 hover:bg-yellow-400 p-2 rounded">ğŸ¥¤ PREMIO 1.5l - $9.000</button>
          <button onclick="agregarProducto('QUATRO 1.5L', 9000)" class="bg-yellow-300 hover:bg-yellow-400 p-2 rounded">ğŸ¥¤ QUATRO 1.5L - $9.000</button>
          <button onclick="agregarProducto('COCA COLA 1.5L', 9000)" class="bg-yellow-300 hover:bg-yellow-400 p-2 rounded">ğŸ¥¤ COCA COLA  1.5L - $9.000</button>
          <button onclick="agregarProducto('JUGO HIT 1.L', 7500)" class="bg-yellow-300 hover:bg-yellow-400 p-2 rounded">ğŸ¥¤ JUGO HIT 1.L - $7.500</button>
          <button onclick="agregarProducto('SPRITE 1.5L', 9000)" class="bg-yellow-300 hover:bg-yellow-400 p-2 rounded">ğŸ¥¤ SPRITE 1.5L - $9.000</button>
          <button onclick="agregarProducto('COCA COLA ZERO 1.5L', 9000)" class="bg-yellow-300 hover:bg-yellow-400 p-2 rounded">ğŸ¥¤ COCA COLA ZERO 1.5L - $9.000</button>
          <button onclick="agregarProducto(' AGUA', 3000)" class="bg-yellow-300 hover:bg-yellow-400 p-2 rounded">ğŸ¥¤ AGUA - $3.000</button>
          <button onclick="agregarProducto('MILO CALIENTE', 6000)" class="bg-yellow-300 hover:bg-yellow-400 p-2 rounded">ğŸ¥› MILO CALIENTE - $6.000</button>
          <button onclick="agregarProducto('CAFE CON LECHE', 5000)" class="bg-yellow-300 hover:bg-yellow-400 p-2 rounded">â˜•ğŸ¥› CAFE CON LECHE - $5.000</button>
          <button onclick="agregarProducto('TINTO', 4000)" class="bg-yellow-300 hover:bg-yellow-400 p-2 rounded">â˜• TINTO - $4.000</button>
          <button onclick="agregarProducto('CERVEZA', 6000)" class="bg-yellow-300 hover:bg-yellow-400 p-2 rounded">ğŸº CERVEZA - $6.000</button>
        </div>
      </div>
    </div>

    <!-- Pedido Actual -->
    <div class="mt-6 bg-white p-4 rounded-xl shadow-md">
      <h3 class="text-lg font-semibold mb-4 border-b pb-2">ğŸ›’ Pedido Actual</h3>
      <ul id="listaPedido" class="list-disc pl-5 text-gray-700 space-y-1"></ul>
      <p id="total" class="mt-4 font-bold text-lg text-gray-800">Total: $0</p>
    </div>

    <!-- Cliente y forma de pago -->
    <div class="mt-4 flex flex-col md:flex-row gap-4">
      <input type="text" id="cliente" placeholder="Nombre del Cliente" class="flex-1 p-2 border border-yellow-300 rounded" />
      <input type="text" id="observaciones" placeholder="Observaciones (Ej: Sin cebolla, agregar salsas, etc.)" class="flex-1 p-2 border border-yellow-300 rounded" />
      <select id="formaPago" class="flex-1 p-2 border border-yellow-300 rounded" onchange="toggleEfectivoSection(); if(this.value==='Efectivo'){abrirModalEfectivoRecibido();}">
        <option value="">Seleccione forma de pago</option>
        <option value="Efectivo">Efectivo</option>
        <option value="QR SeÃ±ora Arepa">QR SeÃ±ora Arepa</option>
        <option value="QR SeÃ±or Arepa">QR SeÃ±or Arepa</option>
        <option value="Nequi">Nequi</option>
        <option value="Daviplata">Daviplata</option>
      </select>
    </div>

    <!-- Tipo de pedido -->
    <div class="mt-4">
      <label for="tipoPedido" class="block text-sm font-medium text-gray-700">Tipo de Pedido</label>
      <select id="tipoPedido" class="mt-1 p-2 border rounded w-full">
        <option value="">Selecciona</option>
        <option value="AquÃ­">AquÃ­</option>
        <option value="Para llevar">Para llevar</option>
        <option value="Domicilio">Domicilio</option>
      </select>
    </div>

    <!-- Efectivo recibido (panel) -->
    <div class="mt-4">
      <button type="button" class="text-sm text-yellow-700 underline" onclick="abrirModalEfectivoRecibido()">
        ğŸ’µ Abrir panel de efectivo recibido
      </button>
      <p id="ef_total" class="mt-1 text-sm text-gray-600"></p>
    </div>

    <!-- Acciones -->
    <div class="mt-6 flex flex-wrap gap-2">
      <button id="btnGuardarVenta" onclick="guardarVenta()" class="bg-green-500 hover:bg-green-600 text-white p-2 rounded">ğŸ’¾ Guardar Venta</button>
      <button id="btnImprimirCocina" onclick="imprimirUltimaCocinero()" class="bg-blue-500 hover:bg-blue-600 text-white p-2 rounded">ğŸ–¨ï¸ Imprimir para Cocina</button>
      <button id="btnImprimirCliente" onclick="imprimirUltimaCliente()" class="bg-purple-500 hover:bg-purple-600 text-white p-2 rounded">ğŸ§¾ Imprimir Recibo Cliente</button>
      <button id="btnBaseCaja" onclick="abrirModalBaseCaja()" class="bg-teal-600 hover:bg-teal-700 text-white p-2 rounded">ğŸ“¦ Base de Caja</button>
      <button id="btnPagosCompras" onclick="abrirModalGasto()" class="bg-rose-600 hover:bg-rose-700 text-white p-2 rounded">ğŸ’¸ Compras / Pagos</button>
      <button id="btnExportarExcel" onclick="exportarVentasExcelConEstilo()" class="bg-green-600 hover:bg-green-700 text-white p-2 rounded">ğŸ“Š Exportar Ventas a Excel</button>
      <button id="btnBorrarVentas" onclick="borrarVentas()" class="bg-red-500 hover:bg-red-600 text-white p-2 rounded">ğŸ—‘ï¸ Borrar Ventas</button>
      <button id="btnResumenProductos" onclick="generarResumenProductos()" class="bg-indigo-500 hover:bg-indigo-600 text-white p-2 rounded">ğŸ“Š Ver Resumen Productos</button>
      <button id="btnCierreCaja" onclick="handleCierreCaja()" class="bg-amber-600 hover:bg-amber-700 text-white p-2 rounded">ğŸ’° Cierre de Caja</button>
    </div>

    <!-- Tabla Ventas/Gastos -->
    <div id="ventasSeccion" class="mt-8 bg-white p-4 rounded-xl shadow-md">
      <h3 class="text-lg font-semibold mb-2">Movimientos</h3>
      <div class="mb-4">
        <input type="text" id="filtroCliente" oninput="filtrarVentasPorCliente()" placeholder="ğŸ” Filtrar por cliente, descripciÃ³n o usuario..." class="w-full md:w-1/3 p-2 border border-yellow-300 rounded" />
      </div>
      <table class="min-w-full text-left border">
        <thead>
          <tr class="bg-yellow-200">
            <th class="p-2 border">#</th>
            <th class="p-2 border">Fecha</th>
            <th class="p-2 border">Cliente / Usuario</th>
            <th class="p-2 border">Forma de Pago</th>
            <th class="p-2 border">Tipo</th>
            <th class="p-2 border">Productos / DescripciÃ³n</th>
            <th class="p-2 border">Total</th>
            <th id="thAcciones" class="p-2 border">Acciones</th>
          </tr>
        </thead>
        <tbody id="ventasGuardadas" class="text-sm text-gray-800"></tbody>
      </table>
    </div>

    <!-- Resumen Productos (solo admin) -->
    <div id="resumenProductos" class="mt-8 bg-white p-4 rounded-xl shadow-md hidden">
      <h3 class="text-lg font-semibold mb-2">Resumen de Productos Vendidos</h3>
      <ul id="listaResumen" class="list-disc pl-5 text-gray-700 space-y-1"></ul>
    </div>

    <!-- GestiÃ³n de Usuarios (solo admin) -->
    <div id="adminUsuariosSection" class="hidden mt-8 bg-white p-4 rounded-xl shadow-md">
      <h3 class="text-lg font-semibold mb-2">GestiÃ³n de Usuarios</h3>
      <form onsubmit="return addUserFromForm(event)" class="grid grid-cols-1 md:grid-cols-4 gap-2 mb-3">
        <input id="newUsername" class="p-2 border rounded" placeholder="Usuario" required>
        <input id="newPassword" type="password" class="p-2 border rounded" placeholder="ContraseÃ±a" required>
        <select id="newRole" class="p-2 border rounded">
          <option value="cajero">Cajero</option>
          <option value="admin">Admin</option>
        </select>
        <button class="bg-green-600 hover:bg-green-700 text-white px-3 py-2 rounded">â• Agregar</button>
      </form>
      <table class="min-w-full text-left border">
        <thead>
          <tr class="bg-yellow-200">
            <th class="p-2 border">Usuario</th>
            <th class="p-2 border">Rol</th>
            <th class="p-2 border">Acciones</th>
          </tr>
        </thead>
        <tbody id="usuariosTbody"></tbody>
      </table>
    </div>
  </main>

  <!-- MODALES (Vuelto, Base, Efectivo, Gasto, Arqueo, Login) -->
  <div id="modalVuelto" class="fixed inset-0 bg-black/50 hidden z-50 items-center justify-center">
    <div class="bg-white rounded-lg shadow-xl w-[90%] max-w-5xl flex flex-col md:flex-row overflow-hidden">
      <div class="w-full md:w-1/3 bg-yellow-50 p-6 border-r">
        <h2 class="text-2xl font-bold text-yellow-700 mb-2">ğŸ’µ Registrar Vuelto</h2>
        <p id="vueltoRequeridoTexto" class="text-sm text-gray-700"></p>
        <div class="mt-4">
          <div class="flex items-center justify-between rounded-lg bg-white px-3 py-2 shadow">
            <span class="text-sm font-medium">Total devuelto</span>
            <span id="totalDevueltoLabel" class="text-xl font-bold text-yellow-800">$0</span>
          </div>
        </div>
        <div class="mt-4">
          <div class="flex gap-2 justify-end">
            <button onclick="confirmarVuelto()" class="bg-teal-600 hover:bg-teal-700 text-white px-4 py-2 rounded shadow">Confirmar</button>
            <button onclick="cerrarModalVuelto()" class="bg-gray-400 hover:bg-gray-500 text-white px-4 py-2 rounded shadow">Cerrar</button>
          </div>
        </div>
      </div>
      <div class="w-full md:w-2/3 bg-white p-4 overflow-y-auto max-h-[80vh]">
        <div id="tablaVueltoUI" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-3"></div>
      </div>
    </div>
  </div>

  <div id="modalBaseCaja" class="fixed inset-0 bg-black/50 z-50 hidden items-center justify-center">
    <div class="bg-white rounded-lg shadow-xl w-[90%] max-w-5xl flex flex-col md:flex-row overflow-hidden">
      <div class="w-full md:w-1/3 bg-yellow-50 p-6 flex flex-col justify-between border-r">
        <div>
          <h2 class="text-2xl font-bold text-yellow-700 mb-2">ğŸ“¦ Base de Caja (Hoy)</h2>
          <p class="text-sm text-gray-600 mb-4">Presiona un botÃ³n para sumar un billete; usa â€œâ–â€ para restar.</p>
          <div class="flex items-center justify-between rounded-lg bg-white px-3 py-2 shadow">
            <span class="text-sm font-medium">Total base del dÃ­a</span>
            <span id="baseTotalValor" class="text-xl font-bold text-yellow-800">$0</span>
          </div>
        </div>
        <div class="mt-4">
          <p id="baseTotalTexto" class="text-sm text-gray-700 mt-3"></p>
          <div class="flex gap-2 justify-end mt-4">
            <button id="btnGuardarBase" onclick="confirmarBaseCaja()" class="bg-teal-600 hover:bg-teal-700 text-white px-4 py-2 rounded shadow">Guardar</button>
            <button onclick="cerrarModalBaseCaja()" class="bg-gray-400 hover:bg-gray-500 text-white px-4 py-2 rounded shadow">Cerrar</button>
          </div>
          <p id="baseMetaInfo" class="text-xs text-gray-500 mt-3"></p>
        </div>
      </div>
      <div class="w-full md:w-2/3 bg-white p-4 overflow-y-auto max-h-[80vh]">
        <div id="baseDenomsContainer" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-3"></div>
      </div>
    </div>
  </div>

  <div id="modalEfectivo" class="fixed inset-0 bg-black/50 z-50 hidden items-center justify-center">
    <div class="bg-white rounded-lg shadow-xl w-[90%] max-w-5xl flex flex-col md:flex-row overflow-hidden">
      <div class="w-full md:w-1/3 bg-yellow-50 p-6 flex flex-col justify-between border-r">
        <div>
          <h2 class="text-2xl font-bold text-yellow-700 mb-2">ğŸ’µ Efectivo recibido</h2>
          <div class="flex items-center justify-between rounded-lg bg-white px-3 py-2 shadow">
            <span class="text-sm font-medium">Total recibido</span>
            <span id="efTotalValor" class="text-xl font-bold text-yellow-800">$0</span>
          </div>
        </div>
        <div class="mt-4">
          <div class="flex gap-2 justify-end mt-4">
            <button onclick="confirmarEfectivoRecibido()" class="bg-teal-600 hover:bg-teal-700 text-white px-4 py-2 rounded shadow">Usar</button>
            <button onclick="cerrarModalEfectivoRecibido()" class="bg-gray-400 hover:bg-gray-500 text-white px-4 py-2 rounded shadow">Cerrar</button>
          </div>
        </div>
      </div>
      <div class="w-full md:w-2/3 bg-white p-4 overflow-y-auto max-h-[80vh]">
        <div id="efDenomsContainer" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-3"></div>
      </div>
    </div>
  </div>

  <div id="modalGasto" class="fixed inset-0 bg-black/50 z-50 hidden items-center justify-center">
    <div class="bg-white rounded-lg shadow-xl w-[90%] max-w-5xl flex flex-col md:flex-row overflow-hidden">
      <div class="w-full md:w-1/3 bg-rose-50 p-6 flex flex-col justify-between border-r">
        <div>
          <h2 class="text-2xl font-bold text-rose-700 mb-2">ğŸ’¸ Compras / Pagos</h2>
          <label class="block text-sm text-gray-700 mb-1">DescripciÃ³n</label>
          <input id="gastoDescripcion" class="w-full border rounded px-2 py-1 mb-3" placeholder="Proveedor, insumo, etc.">
          <label class="block text-sm text-gray-700 mb-1">Total del Gasto</label>
          <input id="gastoTotal" type="number" min="0" class="w-full border rounded px-2 py-1" placeholder="0">
          <div class="mt-4">
            <div class="flex items-center justify-between rounded-lg bg-white px-3 py-2 shadow">
              <span class="text-sm font-medium">Se pagÃ³ en efectivo</span>
              <span id="gastoEfectivoValor" class="text-xl font-bold text-rose-800">$0</span>
            </div>
          </div>
        </div>
        <div class="mt-4">
          <div class="flex gap-2 justify-end mt-4">
            <button onclick="confirmarGasto()" class="bg-rose-600 hover:bg-rose-700 text-white px-4 py-2 rounded shadow">Registrar</button>
            <button onclick="cerrarModalGasto()" class="bg-gray-400 hover:bg-gray-500 text-white px-4 py-2 rounded shadow">Cerrar</button>
          </div>
        </div>
      </div>
      <div class="w-full md:w-2/3 bg-white p-4 overflow-y-auto max-h-[80vh]">
        <p class="text-sm text-gray-600 mb-2">Indica con quÃ© billetes se pagÃ³:</p>
        <div id="gastoDenomsContainer" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-3"></div>
      </div>
    </div>
  </div>

  <div id="modalArqueo" class="fixed inset-0 bg-black/50 z-50 hidden items-center justify-center">
    <div class="bg-white rounded-lg shadow-xl w-[90%] max-w-lg overflow-hidden">
      <div class="bg-yellow-50 p-6 border-b">
        <h2 class="text-2xl font-bold text-yellow-700">ğŸ§® Arqueo de Cajero</h2>
        <p class="text-sm text-gray-600 mt-1">Ingresa el total de efectivo contado en caja y una nota opcional.</p>
      </div>
      <div class="p-6 space-y-3">
        <label class="block text-sm">Monto contado (COP)</label>
        <input id="arqueoMonto" type="number" min="0" class="w-full border rounded px-3 py-2" placeholder="0" />
        <label class="block text-sm">Nota (opcional)</label>
        <textarea id="arqueoNota" rows="3" class="w-full border rounded px-3 py-2" placeholder="Observaciones..."></textarea>
      </div>
      <div class="flex justify-end gap-2 p-6 border-t">
        <button class="bg-gray-400 hover:bg-gray-500 text-white px-4 py-2 rounded" onclick="cerrarModalArqueo()">Cerrar</button>
        <button class="bg-amber-600 hover:bg-amber-700 text-white px-4 py-2 rounded" onclick="confirmarArqueo()">Guardar</button>
      </div>
    </div>
  </div>

  <div id="loginModal" class="fixed inset-0 bg-black/50 z-50 hidden items-center justify-center">
    <div class="bg-white rounded-lg p-6 w-96">
      <h2 class="text-xl font-bold mb-4">Iniciar sesiÃ³n</h2>
      <form onsubmit="return loginFromModal(event)" class="space-y-3">
        <input id="loginUser" class="p-2 border rounded w-full" placeholder="Usuario" required>
        <input id="loginPass" type="password" class="p-2 border rounded w-full" placeholder="ContraseÃ±a" required>
        <button class="w-full bg-yellow-600 hover:bg-yellow-700 text-white px-4 py-2 rounded">Entrar</button>
      </form>
      <p class="text-xs text-gray-500 mt-3">
        Usuarios ejemplo: <b>admin/admin123</b> o <b>cajero/caja123</b>
      </p>
    </div>
  </div>

  <!-- APP -->
  <script type="module">
    /********** FIREBASE **********/
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
    import {
      initializeFirestore,
      persistentLocalCache,
      collection,
      addDoc,
      getDoc,
      getDocs,
      query,
      where,
      orderBy,
      serverTimestamp,
      doc,
      setDoc
    } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDwCV5NmixGyEZ_bdAMTU5wqDua_BbANSo",
      authDomain: "senorarepa-689cc.firebaseapp.com",
      projectId: "senorarepa-689cc",
      storageBucket: "senorarepa-689cc.firebasestorage.app",
      messagingSenderId: "499118544254",
      appId: "1:499118544254:web:cdf7b22c12bb760d184f2f"
    };

    const app = initializeApp(firebaseConfig);
    const db = initializeFirestore(app, { localCache: persistentLocalCache() });

    /********** ESTADO **********/
    const DENOMS = ["100000","50000","20000","10000","5000","2000","1000","500","200","100","50","20"];
    let pedido = [];
    let total = 0;
    let comandaEnEdicion = null;
    let ventaTemporal = null;

    const efCounts = {};
    const baseCounts = {};
    const gastoCounts = {};

    /********** TENANT **********/
    function getOrInitBusinessId() {
      let id = localStorage.getItem('businessId');
      if (!id) {
        id = location.hostname || 'senor-arepa';
        localStorage.setItem('businessId', id);
      }
      return id;
    }

    /********** USERS **********/
    function getSessionUser(){ return JSON.parse(localStorage.getItem('sessionUser') || 'null'); }
    function setSessionUser(user){ localStorage.setItem('sessionUser', JSON.stringify(user)); }
    function isAdmin(){ return getSessionUser()?.role === 'admin'; }

    async function getUserDoc(username){
      const ref = doc(collection(db,'users'), username);
      const snap = await getDoc(ref);
      return snap.exists() ? { id: snap.id, ...snap.data() } : null;
    }

    async function upsertUserProfile(username, role, password=null) {
      const ref = doc(collection(db, 'users'), username);
      const payload = {
        username,
        role,
        businessId: getOrInitBusinessId(),
        ...(password !== null ? { password } : {}),
        updatedAt: serverTimestamp(),
        createdAt: serverTimestamp()
      };
      await setDoc(ref, payload, { merge: true });
    }

    function showLoginModal(){ const m = document.getElementById('loginModal'); m.classList.remove('hidden'); m.classList.add('flex'); }
    function hideLoginModal(){ const m = document.getElementById('loginModal'); m.classList.add('hidden'); m.classList.remove('flex'); }

    window.loginFromModal = async (e) => {
      e.preventDefault();
      const u = document.getElementById('loginUser').value.trim();
      const p = document.getElementById('loginPass').value;

      try {
        const userDoc = await getUserDoc(u);
        if(!userDoc){ alert("Usuario no existe."); return false; }
        if((userDoc.password || '') !== p){ alert("ContraseÃ±a incorrecta."); return false; }
        setSessionUser({ username: userDoc.username, role: userDoc.role });
        await upsertUserProfile(userDoc.username, userDoc.role); // actualiza timestamps
        hideLoginModal();
        applyRoleUI();
        await mostrarVentas();
        autoPromptBaseIfMissing();
      } catch(err){
        console.warn('login err:', err);
        alert("No se pudo iniciar sesiÃ³n.");
      }
      return false;
    };

    window.logout = () => {
      localStorage.removeItem('sessionUser');
      applyRoleUI();
      showLoginModal();
    };

    /********** UI **********/
    function toggleDisplay(id, show){
      const el = document.getElementById(id);
      if(!el) return;
      if(show) el.classList.remove('hidden');
      else el.classList.add('hidden');
    }
    function applyRoleUI(){
      const badge = document.getElementById('currentUserBadge');
      const btnLogout = document.getElementById('btnLogout');
      const user = getSessionUser();

      if(user){
        badge.textContent = `${user.username} (${user.role})`;
        badge.classList.remove('hidden');
        btnLogout.classList.remove('hidden');
        hideLoginModal();
      }else{
        badge.classList.add('hidden');
        btnLogout.classList.add('hidden');
      }

      const admin = isAdmin();
      toggleDisplay('ventasSeccion', true);
      toggleDisplay('resumenProductos', admin);
      toggleDisplay('adminUsuariosSection', admin);
      toggleDisplay('btnExportarExcel', true); // ambos pueden exportar
      toggleDisplay('btnBorrarVentas', admin);
      toggleDisplay('btnResumenProductos', admin);
      toggleDisplay('btnCierreCaja', true);
      toggleDisplay('btnBaseCaja', true);

      const thAcc = document.getElementById('thAcciones');
      if (thAcc) thAcc.classList.remove('hidden');

      toggleEfectivoSection();
      updateBaseBadge();
    }

    /********** FECHA & MONEY **********/
    function todayStr(){
      const d = new Date();
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,'0');
      const day = String(d.getDate()).padStart(2,'0');
      return `${y}-${m}-${day}`;
    }
    function fmtMoney(n) {
      try { return n.toLocaleString('es-CO', { style: 'currency', currency: 'COP', maximumFractionDigits: 0 }); }
      catch { return `$${(Math.round(n)).toString().replace(/\B(?=(\d{3})+(?!\d))/g, '.')}`; }
    }

    /********** BASE DE CAJA (Local + Cloud espejo por usuario) **********/
    function getBaseCajaLocal() {
      const data = JSON.parse(localStorage.getItem('baseCaja') || 'null');
      if(!data) return null;
      if(data.fecha !== todayStr()) return null;
      return data;
    }
    function setBaseCajaLocal(counts) {
      let monto = 0;
      DENOMS.forEach(d => { monto += (counts[d] || 0) * parseInt(d,10); });
      const user = getSessionUser();
      const payload = {
        fecha: todayStr(),
        counts,
        monto,
        usuario: user?.username || 'N/A',
        hora: new Date().toLocaleString()
      };
      localStorage.setItem('baseCaja', JSON.stringify(payload));
      updateBaseBadge();
    }
    function updateBaseBadge(){
      const base = getBaseCajaLocal();
      const el = document.getElementById('baseBadge');
      if(!el) return;
      if(base){
        el.textContent = `Base hoy: ${fmtMoney(base.monto)} (${base.usuario})`;
        el.classList.remove('hidden');
      }else{
        el.textContent = `Base no registrada`;
        el.classList.remove('hidden');
      }
    }
    function autoPromptBaseIfMissing(){
      if(!getBaseCajaLocal()){ abrirModalBaseCaja(true); }
    }
    async function guardarBaseEnFirestore(counts, monto) {
      const id = todayStr();
      const user = getSessionUser();
      const data = {
        businessId: getOrInitBusinessId(),
        fecha: todayStr(),
        counts,
        monto,
        usuario: user?.username || 'N/A',
        updatedAt: serverTimestamp(),
        createdAt: serverTimestamp()
      };
      await setDoc(doc(collection(db, 'bases'), id), data, { merge: true });
      await setDoc(doc(collection(db, 'users', user?.username || 'anon', 'bases'), id), data, { merge: true });
    }

    /********** BOTONERAS EFECTIVO **********/
    function buildMoneyButton(containerId, stateMap, totalLabelId) {
      const cont = document.getElementById(containerId);
      cont.innerHTML = '';
      DENOMS.forEach(denom => {
        if (typeof stateMap[denom] !== 'number') stateMap[denom] = 0;
        const card = document.createElement('div');
        card.className = 'relative flex flex-col items-center justify-center border rounded-xl p-3 shadow-sm bg-white';

        const btnAdd = document.createElement('button');
        btnAdd.className = 'w-full text-center bg-yellow-300 hover:bg-yellow-400 active:bg-yellow-500 text-gray-800 font-semibold rounded-lg py-3 transition';
        btnAdd.textContent = fmtMoney(parseInt(denom, 10));

        const btnSub = document.createElement('button');
        btnSub.type = 'button';
        btnSub.title = 'Restar 1';
        btnSub.textContent = 'â–';
        btnSub.className = 'absolute top-1 right-1 text-xs px-2 py-1 rounded-md border bg-white hover:bg-gray-50';

        const counter = document.createElement('span');
        counter.className = 'mt-2 text-sm font-medium text-gray-700';
        counter.textContent = `x${stateMap[denom]}`;

        btnAdd.addEventListener('click', () => {
          stateMap[denom] = (stateMap[denom] || 0) + 1;
          counter.textContent = `x${stateMap[denom]}`;
          updateMoneyTotal(stateMap, totalLabelId);
        });
        btnSub.addEventListener('click', (e) => {
          e.stopPropagation();
          stateMap[denom] = Math.max(0, (stateMap[denom] || 0) - 1);
          counter.textContent = `x${stateMap[denom]}`;
          updateMoneyTotal(stateMap, totalLabelId);
        });

        card.appendChild(btnAdd);
        card.appendChild(btnSub);
        card.appendChild(counter);
        cont.appendChild(card);
      });
      updateMoneyTotal(stateMap, totalLabelId);
    }
    function updateMoneyTotal(stateMap, totalLabelId) {
      let total = 0;
      DENOMS.forEach(d => total += (stateMap[d] || 0) * parseInt(d, 10));
      const lab = document.getElementById(totalLabelId);
      if (lab) lab.textContent = fmtMoney(total);
      if (totalLabelId === 'efTotalValor') {
        const lbl = document.getElementById('ef_total');
        if (lbl) lbl.textContent = `Efectivo ingresado: ${fmtMoney(total)}`;
      }
    }

    /********** MODALES ABRIR/CERRAR **********/
    window.abrirModalBaseCaja = (auto=false) => {
      const m = document.getElementById('modalBaseCaja');
      m.classList.remove('hidden'); m.classList.add('flex');
      const baseHoy = getBaseCajaLocal();
      DENOMS.forEach(d => baseCounts[d] = baseHoy?.counts?.[d] || 0);

      const cont = document.getElementById('baseDenomsContainer');
      cont.innerHTML = '';
      DENOMS.forEach(denom => {
        const card = document.createElement('div');
        card.className = 'relative flex flex-col items-center justify-center border rounded-xl p-3 shadow-sm bg-white';
        const btnAdd = document.createElement('button');
        btnAdd.className = 'w-full text-center bg-yellow-300 hover:bg-yellow-400 active:bg-yellow-500 text-gray-800 font-semibold rounded-lg py-3 transition';
        btnAdd.textContent = fmtMoney(parseInt(denom, 10));
        const btnSub = document.createElement('button');
        btnSub.type = 'button';
        btnSub.title = 'Restar 1';
        btnSub.textContent = 'â–';
        btnSub.className = 'absolute top-1 right-1 text-xs px-2 py-1 rounded-md border bg-white hover:bg-gray-50';
        const counter = document.createElement('span');
        counter.className = 'mt-2 text-sm font-medium text-gray-700';
        counter.textContent = `x${baseCounts[denom] || 0}`;

        btnAdd.addEventListener('click', () => {
          baseCounts[denom] = (baseCounts[denom] || 0) + 1;
          counter.textContent = `x${baseCounts[denom]}`;
          updateBaseTotal();
        });
        btnSub.addEventListener('click', (e) => {
          e.stopPropagation();
          baseCounts[denom] = Math.max(0, (baseCounts[denom] || 0) - 1);
          counter.textContent = `x${baseCounts[denom]}`;
          updateBaseTotal();
        });
        card.appendChild(btnAdd);
        card.appendChild(btnSub);
        card.appendChild(counter);
        cont.appendChild(card);
      });
      updateBaseTotal();
      const baseHoyInfo = getBaseCajaLocal();
      const meta = document.getElementById('baseMetaInfo');
      meta.textContent = baseHoyInfo ? `Registrada por ${baseHoyInfo.usuario} a las ${baseHoyInfo.hora}.` : `No hay base registrada para hoy (${todayStr()}).`;
    };
    window.cerrarModalBaseCaja = () => { const m = document.getElementById('modalBaseCaja'); m.classList.add('hidden'); m.classList.remove('flex'); };
    function updateBaseTotal() {
      let total = 0;
      DENOMS.forEach(d => total += (baseCounts[d] || 0) * parseInt(d, 10));
      const v1 = document.getElementById('baseTotalValor');
      const v2 = document.getElementById('baseTotalTexto');
      if (v1) v1.textContent = fmtMoney(total);
      if (v2) v2.textContent = `Total base: ${fmtMoney(total)}`;
    }
    window.confirmarBaseCaja = async () => {
      setBaseCajaLocal(baseCounts);
      try {
        let monto = 0; DENOMS.forEach(d=> monto += (baseCounts[d]||0)*parseInt(d,10));
        await guardarBaseEnFirestore(structuredClone(baseCounts), monto);
      } catch(e){
        console.warn('save base cloud err:', e);
      }
      alert('Base de caja guardada.');
      cerrarModalBaseCaja();
    };

    window.abrirModalEfectivoRecibido = () => {
      const m = document.getElementById('modalEfectivo');
      m.classList.remove('hidden'); m.classList.add('flex');
      buildMoneyButton('efDenomsContainer', efCounts, 'efTotalValor');
    };
    window.cerrarModalEfectivoRecibido = () => { const m = document.getElementById('modalEfectivo'); m.classList.add('hidden'); m.classList.remove('flex'); };
    window.confirmarEfectivoRecibido = () => { cerrarModalEfectivoRecibido(); };

    window.abrirModalVuelto = (vuelto) => {
      const m = document.getElementById('modalVuelto');
      m.classList.remove('hidden'); m.classList.add('flex');
      document.getElementById('vueltoRequeridoTexto').textContent = `Vuelto requerido: ${fmtMoney(vuelto)}`;
      const tempVuelto = {};
      DENOMS.forEach(d => tempVuelto[d]=0);
      const box = document.getElementById('tablaVueltoUI');
      box.innerHTML = '';
      DENOMS.forEach(denom => {
        const card = document.createElement('div');
        card.className = 'relative flex flex-col items-center justify-center border rounded-xl p-3 shadow-sm bg-white';
        const btnAdd = document.createElement('button');
        btnAdd.className = 'w-full text-center bg-yellow-300 hover:bg-yellow-400 active:bg-yellow-500 text-gray-800 font-semibold rounded-lg py-3 transition';
        btnAdd.textContent = fmtMoney(parseInt(denom, 10));
        const btnSub = document.createElement('button');
        btnSub.type = 'button'; btnSub.title='Restar 1'; btnSub.textContent='â–';
        btnSub.className = 'absolute top-1 right-1 text-xs px-2 py-1 rounded-md border bg-white hover:bg-gray-50';
        const counter = document.createElement('span');
        counter.className = 'mt-2 text-sm font-medium text-gray-700'; counter.textContent = `x0`;

        const recalc = () => {
          let tot = 0; DENOMS.forEach(d => tot += (tempVuelto[d]||0)*parseInt(d,10));
          document.getElementById('totalDevueltoLabel').textContent = fmtMoney(tot);
        };

        btnAdd.addEventListener('click', () => { tempVuelto[denom] = (tempVuelto[denom] || 0) + 1; counter.textContent = `x${tempVuelto[denom]}`; recalc(); });
        btnSub.addEventListener('click', (e) => { e.stopPropagation(); tempVuelto[denom] = Math.max(0,(tempVuelto[denom]||0)-1); counter.textContent=`x${tempVuelto[denom]}`; recalc(); });

        card.dataset.denom = denom;
        card.appendChild(btnAdd); card.appendChild(btnSub); card.appendChild(counter);
        box.appendChild(card);
      });
      document.getElementById('modalVuelto').dataset.temp = '1';
      document.getElementById('totalDevueltoLabel').textContent = fmtMoney(0);
    };
    window.cerrarModalVuelto = () => { const m = document.getElementById('modalVuelto'); m.classList.add('hidden'); m.classList.remove('flex'); ventaTemporal = null; };
    window.confirmarVuelto = () => {
      if(!ventaTemporal) return alert('No hay venta en proceso.');
      const box = document.getElementById('tablaVueltoUI');
      const temp = {}; let totalDev = 0;
      Array.from(box.children).forEach(card=>{
        const denom = card.dataset.denom;
        const count = parseInt((card.querySelector('span')?.textContent || 'x0').replace('x',''),10) || 0;
        temp[denom]=count; totalDev += count * parseInt(denom,10);
      });
      if (totalDev !== ventaTemporal.vuelto) {
        alert(`El total ingresado (${fmtMoney(totalDev)}) no coincide con el vuelto requerido (${fmtMoney(ventaTemporal.vuelto)}).`);
        return;
      }
      const venta = { ...ventaTemporal, billetesDevueltos: temp, comanda: comandaEnEdicion ?? obtenerSiguienteComanda() };
      persistirVenta(venta).then(()=>{
        comandaEnEdicion = null; ventaTemporal = null;
        cerrarModalVuelto();
        alert("Venta guardada exitosamente.");
        limpiarPedido();
        mostrarVentas();
        const rp = document.getElementById("resumenProductos"); if (rp) rp.classList.add("hidden");
      }).catch(e=>{
        console.warn('save venta err:', e);
        alert('Error guardando venta.');
      });
    };

    // GASTO
    window.abrirModalGasto = () => {
      const m = document.getElementById('modalGasto');
      m.classList.remove('hidden'); m.classList.add('flex');
      DENOMS.forEach(d=> gastoCounts[d]=0);
      document.getElementById('gastoDescripcion').value = '';
      document.getElementById('gastoTotal').value = '';
      buildMoneyButton('gastoDenomsContainer', gastoCounts, 'gastoEfectivoValor');
    };
    window.cerrarModalGasto = () => { const m = document.getElementById('modalGasto'); m.classList.add('hidden'); m.classList.remove('flex'); };

    async function guardarGastoEnFirestore(payload) {
      const col = collection(db, 'gastos');
      const res = await addDoc(col, { ...payload, createdAt: serverTimestamp() });
      const u = getSessionUser()?.username || 'anon';
      await addDoc(collection(db, 'users', u, 'gastos'), { ...payload, createdAt: serverTimestamp() });
      return res;
    }
    window.confirmarGasto = async () => {
      const desc = document.getElementById('gastoDescripcion').value.trim();
      const gastoTotal = parseInt(document.getElementById('gastoTotal').value || '0', 10) || 0;
      let pagadoEfectivo = 0; DENOMS.forEach(d=> pagadoEfectivo += (gastoCounts[d]||0)*parseInt(d,10));
      if (!desc) return alert('Escribe la descripciÃ³n del gasto.');
      if (gastoTotal <= 0) return alert('Escribe el total del gasto.');

      // Descontar base local
      DENOMS.forEach(d => {
        const curr = baseCounts[d] || 0;
        const resta = gastoCounts[d] || 0;
        baseCounts[d] = Math.max(0, curr - resta);
      });
      setBaseCajaLocal(baseCounts);
      try {
        let monto = 0; DENOMS.forEach(d=> monto += (baseCounts[d]||0)*parseInt(d,10));
        await guardarBaseEnFirestore(structuredClone(baseCounts), monto);
      } catch(e){
        console.warn('save base cloud err:', e);
      }

      const payload = {
        businessId: getOrInitBusinessId(),
        descripcion: desc,
        total: gastoTotal,
        pagadoEfectivo,
        billetesUsados: structuredClone(gastoCounts),
        fecha: new Date().toLocaleString(),
        usuario: getSessionUser()?.username || 'N/A',
        tipo: 'gasto'
      };
      try { await guardarGastoEnFirestore(payload); } catch(e){ console.warn('save gasto cloud err:', e); }
      const gl = JSON.parse(localStorage.getItem('gastos') || '[]');
      gl.push({ ...payload, createdAt: Date.now() });
      localStorage.setItem('gastos', JSON.stringify(gl));

      alert('Gasto registrado.');
      cerrarModalGasto();
      updateBaseBadge();
      mostrarVentas();
    };

    /********** ARQUEO (CAJERO) **********/
    window.abrirModalArqueo = () => {
      const m = document.getElementById('modalArqueo');
      m.classList.remove('hidden'); m.classList.add('flex');
      document.getElementById('arqueoMonto').value = '';
      document.getElementById('arqueoNota').value = '';
    };
    window.cerrarModalArqueo = () => { const m = document.getElementById('modalArqueo'); m.classList.add('hidden'); m.classList.remove('flex'); };

    async function guardarArqueoEnFirestore(payload){
      const res = await addDoc(collection(db, 'arqueos'), { ...payload, createdAt: serverTimestamp() });
      await addDoc(collection(db, 'users', payload.usuario || 'anon', 'arqueos'), { ...payload, createdAt: serverTimestamp() });
      return res;
    }
    window.confirmarArqueo = async () => {
      const monto = parseInt(document.getElementById('arqueoMonto').value || '0', 10) || 0;
      const nota  = (document.getElementById('arqueoNota').value || '').trim();
      if (monto < 0) return alert('Ingresa un monto vÃ¡lido.');
      const u = getSessionUser();
      if(!u){ showLoginModal(); return; }
      const payload = {
        businessId: getOrInitBusinessId(),
        fecha: todayStr(),
        hora: new Date().toLocaleString(),
        usuario: u.username,
        montoReportado: monto,
        nota
      };
      try { await guardarArqueoEnFirestore(payload); } catch(e){ console.warn('save arqueo cloud err:', e); }
      const aLocal = JSON.parse(localStorage.getItem('arqueos') || '[]');
      aLocal.push({ ...payload, createdAt: Date.now() });
      localStorage.setItem('arqueos', JSON.stringify(aLocal));
      alert('Arqueo guardado. Â¡Gracias!');
      cerrarModalArqueo();
    };

    /********** PEDIDOS **********/
    window.agregarProducto = (nombre, precio) => { pedido.push({ nombre, precio }); actualizarTotal(); actualizarVistaPedido(); };
    window.quitarProducto = (index) => { if (index >= 0 && index < pedido.length) { pedido.splice(index, 1); actualizarTotal(); actualizarVistaPedido(); } };
    function actualizarTotal() { total = pedido.reduce((acc, p) => acc + p.precio, 0); }
    function actualizarVistaPedido() {
      const lista = document.getElementById("listaPedido");
      lista.innerHTML = "";
      pedido.forEach((p, i) => {
        const li = document.createElement("li");
        li.innerHTML = `${p.nombre} - ${fmtMoney(p.precio)} <button onclick="quitarProducto(${i})" class='text-red-600 ml-2'>âŒ</button>`;
        lista.appendChild(li);
      });
      document.getElementById("total").textContent = `Total: ${fmtMoney(total)}`;
    }
    window.toggleEfectivoSection = () => {
      const forma = document.getElementById("formaPago").value;
      if (forma === 'Efectivo') { /* modal se abre en onchange */ }
    };
    function getEfectivoRecibidoFromState() {
      const recibidos = {}; let totalRec = 0;
      DENOMS.forEach(d => { const c = efCounts[d] || 0; recibidos[d] = c; totalRec += c * parseInt(d,10); });
      const el = document.getElementById("ef_total");
      if(el) el.textContent = `Efectivo ingresado: ${fmtMoney(totalRec)}`;
      return { billetesRecibidos: recibidos, totalRecibido: totalRec };
    }
    window.limpiarPedido = () => {
      pedido = []; total = 0; actualizarVistaPedido();
      ["cliente","formaPago","tipoPedido","observaciones"].forEach(id => { const el = document.getElementById(id); if(el) el.value = ""; });
      const eftxt = document.getElementById("ef_total"); if(eftxt) eftxt.textContent = "";
      DENOMS.forEach(d => { efCounts[d] = 0; });
    };

    /********** GUARDAR VENTA **********/
    async function guardarVentaEnFirestore(venta) {
      const res = await addDoc(collection(db, 'ventas'), { ...venta, createdAt: serverTimestamp() });
      const u = getSessionUser()?.username || 'anon';
      await addDoc(collection(db, 'users', u, 'ventas'), { ...venta, createdAt: serverTimestamp() });
      return res;
    }
    async function persistirVenta(venta) {
      try { await guardarVentaEnFirestore(venta); } catch(e) { console.warn('save venta cloud err:', e); }
      const ventas = JSON.parse(localStorage.getItem("ventas")) || [];
      ventas.push({ ...venta, createdAt: Date.now() });
      localStorage.setItem("ventas", JSON.stringify(ventas));
    }

    window.guardarVenta = async () => {
      if(!getSessionUser()){ showLoginModal(); return; }
      const cliente = document.getElementById("cliente").value.trim();
      const formaPago = document.getElementById("formaPago").value;
      const tipoPedido = document.getElementById("tipoPedido").value;
      if (pedido.length === 0) return alert("Agrega productos al pedido.");
      if (!cliente) return alert("Por favor ingresa el nombre del cliente.");
      if (!formaPago) return alert("Por favor selecciona una forma de pago.");
      if (!tipoPedido) return alert("Por favor selecciona un tipo de pedido.");
      const observaciones = document.getElementById("observaciones").value.trim();

      const { billetesRecibidos, totalRecibido } = getEfectivoRecibidoFromState();
      let vuelto = 0;
      if (formaPago === "Efectivo") {
        if (totalRecibido < total) return alert(`Efectivo insuficiente. Faltan ${fmtMoney(total - totalRecibido)}.`);
        vuelto = totalRecibido - total;
      } else {
        DENOMS.forEach(d => billetesRecibidos[d] = 0);
      }

      const baseVenta = {
        businessId: getOrInitBusinessId(),
        cliente, formaPago, tipoPedido, observaciones,
        pedido: [...pedido], total,
        fecha: new Date().toLocaleString(),
        billetesRecibidos, billetesDevueltos: {},
        efectivoRecibido: totalRecibido,
        usuario: getSessionUser()?.username || 'N/A',
        tipo: 'venta'
      };

      if (formaPago === "Efectivo" && vuelto > 0) { ventaTemporal = { ...baseVenta, vuelto, comanda: null }; abrirModalVuelto(vuelto); return; }

      const venta = { ...baseVenta, comanda: comandaEnEdicion ?? obtenerSiguienteComanda() };
      await persistirVenta(venta);
      comandaEnEdicion = null;
      alert("Venta guardada exitosamente.");
      limpiarPedido();
      mostrarVentas();
      const rp = document.getElementById("resumenProductos"); if (rp) rp.classList.add("hidden");
    };

    /********** CARGA DE DATOS (USER vs ADMIN) **********/
    function tsKey(d) { if (!d) return 0; if (typeof d === 'number') return d; if (d.seconds !== undefined) return d.seconds * 1000 + Math.floor((d.nanoseconds || 0)/1e6); return 0; }

    // Por usuario (subcolecciones)
    async function cargarVentasUsuarioDesdeFirestore(username) {
      const snap = await getDocs(query(collection(db, 'users', username, 'ventas'), orderBy('createdAt','desc')));
      return snap.docs.map(d => ({ id: d.id, ...d.data() }));
    }
    async function cargarGastosUsuarioDesdeFirestore(username) {
      const snap = await getDocs(query(collection(db, 'users', username, 'gastos'), orderBy('createdAt','desc')));
      return snap.docs.map(d => ({ id: d.id, ...d.data() }));
    }

    // Por negocio (admin ve todo) â€“ colecciones globales con businessId
    async function cargarVentasNegocioDesdeFirestore() {
      const snap = await getDocs(query(collection(db, 'ventas'), where('businessId','==', getOrInitBusinessId()), orderBy('createdAt','desc')));
      return snap.docs.map(d => ({ id: d.id, ...d.data() }));
    }
    async function cargarGastosNegocioDesdeFirestore() {
      const snap = await getDocs(query(collection(db, 'gastos'), where('businessId','==', getOrInitBusinessId()), orderBy('createdAt','desc')));
      return snap.docs.map(d => ({ id: d.id, ...d.data() }));
    }

    window.mostrarVentas = async () => {
      const contenedor = document.getElementById("ventasGuardadas");
      if(!contenedor) return;
      contenedor.innerHTML = "";

      const u = getSessionUser()?.username;
      if(!u){ localStorage.setItem("ventasTabla","[]"); return; }

      const admin = isAdmin();
      let items = [];
      try {
        let ventasFS = [];
        let gastosFS = [];
        if (admin) {
          ventasFS = await cargarVentasNegocioDesdeFirestore();
          gastosFS = await cargarGastosNegocioDesdeFirestore();
        } else {
          ventasFS = await cargarVentasUsuarioDesdeFirestore(u);
          gastosFS = await cargarGastosUsuarioDesdeFirestore(u);
        }
        items = [...ventasFS, ...gastosFS];
      } catch(e) {
        console.warn('Fallo lectura Firestore, uso LocalStorage:', e);
        const ventasLS_all = JSON.parse(localStorage.getItem("ventas") || "[]");
        const gastosLS_all = JSON.parse(localStorage.getItem("gastos") || "[]");
        if (admin) {
          // Filtro por businessId si estÃ¡ presente
          const bid = getOrInitBusinessId();
          items = [
            ...ventasLS_all.filter(v => !v.businessId || v.businessId===bid),
            ...gastosLS_all.filter(g => !g.businessId || g.businessId===bid)
          ];
        } else {
          items = [
            ...ventasLS_all.filter(v => v?.usuario === u),
            ...gastosLS_all.filter(g => g?.usuario === u)
          ];
        }
      }

      items.sort((a,b) => tsKey(b.createdAt) - tsKey(a.createdAt));
      localStorage.setItem("ventasTabla", JSON.stringify(items));

      items.forEach((v, i) => {
        const isGasto = (v.tipo === 'gasto');
        let productosResumen = '';
        if (!isGasto) {
          const resumen = {};
          (v.pedido||[]).forEach(p => { resumen[p.nombre] = (resumen[p.nombre] || 0) + 1; });
          productosResumen = Object.entries(resumen).map(([prod, cant]) => `${prod}: ${cant}`).join("<br>");
        } else {
          productosResumen = `DESC: ${v.descripcion || ''} Â· Pagado: ${fmtMoney(v.pagadoEfectivo || 0)}`;
        }

        const tipoBadge = isGasto
          ? `<span class="inline-block text-xs px-2 py-0.5 bg-rose-100 text-rose-700 rounded">Gasto</span>`
          : `<span class="inline-block text-xs px-2 py-0.5 bg-emerald-100 text-emerald-700 rounded">Venta</span>`;

        const clienteTxt = isGasto ? (v.usuario || '') : (v.cliente || '');
        const formaTxt = isGasto ? 'Efectivo/Salida' : (v.formaPago || '');
        const totalTxt = isGasto ? `- ${fmtMoney(v.total || v.pagadoEfectivo || 0)}` : `${fmtMoney(v.total || 0)}`;

        const acciones = isGasto
          ? `<button onclick="imprimirGasto(${i})" class="bg-rose-600 text-white px-2 py-1 rounded text-xs">ğŸ§¾ Gasto</button>`
          : `
            <button onclick="imprimirVentaCliente(${i})" class="bg-purple-500 text-white px-2 py-1 rounded text-xs">ğŸ§¾ Cliente</button>
            <button onclick="imprimirVentaCocina(${i})" class="bg-blue-500 text-white px-2 py-1 rounded text-xs">ğŸ‘¨â€ğŸ³ Cocina</button>
            ${ isAdmin() ? `<button onclick="editarVenta(${i})" class="bg-yellow-600 text-white px-2 py-1 rounded text-xs">ğŸ“ Editar</button>` : ``}
          `;

        contenedor.innerHTML += `
          <tr>
            <td class='border p-1'>${v.comanda ?? (i + 1)}</td>
            <td class='border p-1'>${v.fecha || ''}</td>
            <td class='border p-1'>${clienteTxt}</td>
            <td class='border p-1'>${formaTxt}</td>
            <td class='border p-1'>${tipoBadge}</td>
            <td class='border p-1'>${productosResumen}</td>
            <td class='border p-1'>${totalTxt}</td>
            <td class='border p-1 space-x-1'>${acciones}</td>
          </tr>`;
      });
    };

    window.filtrarVentasPorCliente = () => {
      const filtro = (document.getElementById("filtroCliente").value || '').toLowerCase();
      const items = JSON.parse(localStorage.getItem("ventasTabla") || "[]");
      const contenedor = document.getElementById("ventasGuardadas");
      const admin = isAdmin();
      contenedor.innerHTML = "";

      items.forEach((v, i) => {
        const isGasto = (v.tipo === 'gasto');
        const matchText = [
          v.cliente || '',
          v.descripcion || '',
          v.usuario || ''
        ].join(' ').toLowerCase();
        if (!matchText.includes(filtro)) return;

        let productosResumen = '';
        if (!isGasto) {
          const resumen = {};
          (v.pedido||[]).forEach(p => { resumen[p.nombre] = (resumen[p.nombre] || 0) + 1; });
          productosResumen = Object.entries(resumen).map(([prod, cant]) => `${prod}: ${cant}`).join("<br>");
        } else {
          productosResumen = `DESC: ${v.descripcion || ''} Â· Pagado: ${fmtMoney(v.pagadoEfectivo || 0)}`;
        }

        const tipoBadge = isGasto
          ? `<span class="inline-block text-xs px-2 py-0.5 bg-rose-100 text-rose-700 rounded">Gasto</span>`
          : `<span class="inline-block text-xs px-2 py-0.5 bg-emerald-100 text-emerald-700 rounded">Venta</span>`;

        const clienteTxt = isGasto ? (v.usuario || '') : (v.cliente || '');
        const formaTxt = isGasto ? 'Efectivo/Salida' : (v.formaPago || '');
        const totalTxt = isGasto ? `- ${fmtMoney(v.total || v.pagadoEfectivo || 0)}` : `${fmtMoney(v.total || 0)}`;

        const acciones = isGasto
          ? `<button onclick="imprimirGasto(${i})" class="bg-rose-600 text-white px-2 py-1 rounded text-xs">ğŸ§¾ Gasto</button>`
          : `
            <button onclick="imprimirVentaCliente(${i})" class="bg-purple-500 text-white px-2 py-1 rounded text-xs">ğŸ§¾ Cliente</button>
            <button onclick="imprimirVentaCocina(${i})" class="bg-blue-500 text-white px-2 py-1 rounded text-xs">ğŸ‘¨â€ğŸ³ Cocina</button>
            ${ admin ? `<button onclick="editarVenta(${i})" class="bg-yellow-600 text-white px-2 py-1 rounded text-xs">ğŸ“ Editar</button>` : ``}
          `;

        contenedor.innerHTML += `
          <tr>
            <td class='border p-1'>${v.comanda ?? (i + 1)}</td>
            <td class='border p-1'>${v.fecha || ''}</td>
            <td class='border p-1'>${clienteTxt}</td>
            <td class='border p-1'>${formaTxt}</td>
            <td class='border p-1'>${tipoBadge}</td>
            <td class='border p-1'>${productosResumen}</td>
            <td class='border p-1'>${totalTxt}</td>
            <td class='border p-1 space-x-1'>${acciones}</td>
          </tr>`;
      });
    };

    /********** EXPORTAR / CIERRE / IMPRESIÃ“N **********/
    window.exportarVentasExcelConEstilo = async () => {
      const user = getSessionUser();
      if(!user){ alert("Inicia sesiÃ³n."); return; }

      let ventas = [];
      let gastos = [];
      try {
        if (isAdmin()) {
          ventas = await cargarVentasNegocioDesdeFirestore();
          gastos = await cargarGastosNegocioDesdeFirestore();
        } else {
          ventas = await cargarVentasUsuarioDesdeFirestore(user.username);
          gastos = await cargarGastosUsuarioDesdeFirestore(user.username);
        }
      } catch {
        const vLS = JSON.parse(localStorage.getItem("ventas") || "[]");
        const gLS = JSON.parse(localStorage.getItem("gastos") || "[]");
        if (isAdmin()) {
          const bid = getOrInitBusinessId();
          ventas = vLS.filter(v => !v.businessId || v.businessId===bid);
          gastos = gLS.filter(g => !g.businessId || g.businessId===bid);
        } else {
          ventas = vLS.filter(v => v?.usuario === user.username);
          gastos = gLS.filter(g => g?.usuario === user.username);
        }
      }

      if (ventas.length === 0 && gastos.length === 0) return alert("No hay datos para exportar.");

      const workbook = new ExcelJS.Workbook();
      const sheet = workbook.addWorksheet(isAdmin() ? "Ventas (Negocio)" : "Ventas (Usuario)");

      const headers = ["#", "Fecha", "Cliente", "Forma de Pago", "Tipo de Pedido", "Producto", "Precio (COP)", "Total Venta (COP)"];
      sheet.addRow(headers);
      let totalGlobal = 0; const conteoProductos = {};
      ventas.forEach((venta, i) => {
        const { fecha, cliente, formaPago, tipoPedido, total, pedido } = venta;
        totalGlobal += parseFloat(total) || 0;
        (pedido||[]).forEach(producto => {
          sheet.addRow([venta.comanda ?? (i + 1), fecha, cliente, formaPago, tipoPedido, producto.nombre, parseFloat(producto.precio), parseFloat(total)]);
          conteoProductos[producto.nombre] = (conteoProductos[producto.nombre] || 0) + 1;
        });
      });
      sheet.getRow(1).eachCell(c => { c.fill={type:"pattern",pattern:"solid",fgColor:{argb:"FF1F4E78"}}; c.font={color:{argb:"FFFFFFFF"},bold:true}; c.alignment={vertical:"middle",horizontal:"center"}; c.border={top:{style:"thin"},bottom:{style:"thin"},left:{style:"thin"},right:{style:"thin"}}; });
      for(let r=2;r<=sheet.rowCount;r++){ const row=sheet.getRow(r); const even=r%2===0; row.eachCell(c=>{c.fill={type:"pattern",pattern:"solid",fgColor:{argb: even ? "FFF2F2F2":"FFFFFFFF"}}; c.border={top:{style:"thin"},bottom:{style:"thin"},left:{style:"thin"},right:{style:"thin"}};}); row.getCell(7).numFmt='"$"#,##0'; row.getCell(8).numFmt='"$"#,##0';}
      sheet.addRow([]); const totalRow = sheet.addRow(["","","","","","TOTAL DEL DÃA:","",totalGlobal]); totalRow.getCell(8).numFmt='"$"#,##0'; totalRow.font={bold:true};
      let prodMas="", max=0; for(const [prod,c] of Object.entries(conteoProductos)){ if(c>max){max=c;prodMas=prod;} }
      const r2 = sheet.addRow(["","","","","","Producto mÃ¡s vendido:","",`${prodMas} (${max})`]); r2.font={italic:true};
      sheet.columns.forEach(col => col.width = 18);

      sheet.addRow([]); sheet.addRow([]);

      const startRow = sheet.rowCount + 1;
      const gHeaders = ["Fecha", "Usuario", "DescripciÃ³n", "Total Gasto (COP)", "Pagado en Efectivo (COP)"];
      sheet.addRow(gHeaders);
      let totalGastos = 0;
      gastos.forEach(g => {
        const tg = parseFloat(g.total || g.pagadoEfectivo || 0) || 0;
        totalGastos += tg;
        sheet.addRow([g.fecha || "", g.usuario || "", g.descripcion || "", tg, parseFloat(g.pagadoEfectivo || 0) || 0]);
      });
      const hdr = sheet.getRow(startRow);
      hdr.eachCell(c => { c.fill={type:"pattern",pattern:"solid",fgColor:{argb:"FF7F1D1D"}}; c.font={color:{argb:"FFFFFFFF"},bold:true}; c.alignment={vertical:"middle",horizontal:"center"}; c.border={top:{style:"thin"},bottom:{style:"thin"},left:{style:"thin"},right:{style:"thin"}}; });
      for(let r=startRow+1;r<=sheet.rowCount;r++){ const row=sheet.getRow(r); const even=r%2===0; row.eachCell(c=>{c.fill={type:"pattern",pattern:"solid",fgColor:{argb: even ? "FFFDF2F8":"FFFFFFFF"}}; c.border={top:{style:"thin"},bottom:{style:"thin"},left:{style:"thin"},right:{style:"thin"}};}); row.getCell(4).numFmt='"$"#,##0'; row.getCell(5).numFmt='"$"#,##0';}
      sheet.addRow([]); const totalGRow = sheet.addRow(["","","TOTAL GASTOS:","", totalGastos]); totalGRow.getCell(5).numFmt='"$"#,##0'; totalGRow.font={bold:true};

      const buffer = await workbook.xlsx.writeBuffer();
      const blob = new Blob([buffer], { type: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" });
      const url = URL.createObjectURL(blob); const a = document.createElement("a"); a.href = url;
      const d = new Date();
      const who = isAdmin() ? "NEGOCIO" : user.username;
      a.download = `Ventas_y_Gastos_${who}_${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}.xlsx`;
      document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    };

    // Imprimir gasto (desde tabla)
    window.imprimirGasto = (index) => {
      const items = JSON.parse(localStorage.getItem("ventasTabla") || "[]"); const g = items[index]; if (!g || g.tipo !== 'gasto') return alert("Gasto no encontrado.");
      const contenido = `
        <html><head><title>Comprobante de Gasto</title><style>
          body{font-family:monospace;font-size:14px;width:58mm;padding:10px 12px;margin:0;line-height:1.5;}
          h2{text-align:center;font-size:18px;margin:10px 0;font-weight:bold;}
          .line{border-top:1px dashed #000;margin:8px 0;}
          .info p{margin:6px 0;}
          .total{text-align:right;font-weight:bold;margin-top:10px;font-size:16px;}
        </style></head><body>
          <h2>COMPROBANTE DE GASTO</h2>
          <div class="line"></div>
          <div class="info">
            <p><strong>Fecha:</strong> ${g.fecha || ''}</p>
            <p><strong>Usuario:</strong> ${g.usuario || ''}</p>
            <p><strong>DescripciÃ³n:</strong> ${g.descripcion || ''}</p>
          </div>
          <div class="line"></div>
          <p class="total">Total: ${fmtMoney(g.total || g.pagadoEfectivo || 0)}</p>
          <div class="line"></div>
          <p style="text-align:center;">Gracias.</p>
          <script>window.print();<\/script>
        </body></html>`;
      const w = window.open("", "_blank", "width=400,height=600"); w.document.write(contenido); w.document.close(); w.focus();
    };

    /********** CIERRE DE CAJA (cajero vs admin) **********/
    window.handleCierreCaja = () => { if (isAdmin()) { cierreDeCaja(); } else { abrirModalArqueo(); } };

    async function guardarCierreEnFirestore(payload){
      const res = await addDoc(collection(db, 'cierres'), { ...payload, createdAt: serverTimestamp() });
      await addDoc(collection(db, 'users', payload.usuarioAdmin || 'admin', 'cierres'), { ...payload, createdAt: serverTimestamp() });
      return res;
    }

    async function cargarArqueosHoyDesdeFirestore(){
      const businessId = getOrInitBusinessId();
      const snap = await getDocs(query(collection(db, 'arqueos'), where('businessId','==', businessId)));
      const hoy = todayStr();
      const all = snap.docs.map(d => ({ id: d.id, ...d.data() }));
      return all.filter(a => (a.fecha === hoy));
    }

    // Helper ventas para cierre (admin ve negocio completo)
    async function cargarVentasParaCierre() {
      if (isAdmin()) {
        try { return await cargarVentasNegocioDesdeFirestore(); }
        catch { 
          const bid = getOrInitBusinessId();
          return (JSON.parse(localStorage.getItem("ventas") || "[]") || []).filter(v => !v.businessId || v.businessId===bid);
        }
      } else {
        const u = getSessionUser()?.username;
        try { return await cargarVentasUsuarioDesdeFirestore(u); }
        catch { 
          return (JSON.parse(localStorage.getItem("ventas") || "[]") || []).filter(v => v?.usuario === u);
        }
      }
    }

    window.cierreDeCaja = async () => {
      const user = getSessionUser();
      if(!user){ showLoginModal(); return; }
      const ventas = await cargarVentasParaCierre();
      const base = getBaseCajaLocal();

      const sumRec = {}, sumDev = {}, sumNet = {}, finalCounts = {};
      let montoRec=0, montoDev=0, montoNet=0, montoBase=0, montoFinal=0;
      DENOMS.forEach(d=>{sumRec[d]=0; sumDev[d]=0; sumNet[d]=0; finalCounts[d]=0;});
      ventas.forEach(v=>{
        DENOMS.forEach(d=>{
          sumRec[d]+= (v.billetesRecibidos?.[d]||0);
          sumDev[d]+= (v.billetesDevueltos?.[d]||0);
        });
      });
      DENOMS.forEach(d=>{
        sumNet[d]= sumRec[d]-sumDev[d];
        const baseCnt = base?.counts?.[d] || 0;
        finalCounts[d] = baseCnt + sumNet[d];
        montoRec  += sumRec[d]*parseInt(d,10);
        montoDev  += sumDev[d]*parseInt(d,10);
        montoNet  += sumNet[d]*parseInt(d,10);
        montoBase += baseCnt*parseInt(d,10);
        montoFinal+= finalCounts[d]*parseInt(d,10);
      });

      let arqueos = [];
      try { arqueos = await cargarArqueosHoyDesdeFirestore(); }
      catch(e) {
        console.warn('Fallo lectura arqueos Firestore, uso LocalStorage:', e);
        const aLocal = JSON.parse(localStorage.getItem('arqueos') || '[]');
        const hoy = todayStr();
        arqueos = aLocal.filter(a => a.fecha === hoy);
      }

      const cierrePayload = {
        businessId: getOrInitBusinessId(),
        fecha: todayStr(),
        fechaHora: new Date().toLocaleString(),
        usuarioAdmin: user.username,
        base: montoBase,
        efectivoRecibidoVentas: montoRec,
        efectivoDevuelto: montoDev,
        netoVentas: montoNet,
        totalEsperadoCaja: montoFinal,
        detalle: {
          sumRec,
          sumDev,
          sumNet,
          baseCounts: base?.counts || {},
          finalCounts
        },
        // si es admin, aquÃ­ verÃ¡ arqueos de todos los cajeros del dÃ­a
        arqueos: (arqueos || []).map(a => ({ usuario: a.usuario || '', hora: a.hora || '', montoReportado: a.montoReportado || 0, nota: a.nota || '' }))
      };

      try { await guardarCierreEnFirestore(cierrePayload); } catch(e){ console.warn('save cierre cloud err:', e); }
      const cierresLocal = JSON.parse(localStorage.getItem('cierres') || '[]');
      cierresLocal.push({ ...cierrePayload, createdAt: Date.now() });
      localStorage.setItem('cierres', JSON.stringify(cierresLocal));

      const html = `
        <html><head><title>Cierre de Caja</title><style>
          body { font-family: monospace; font-size: 12px; width: 76mm; padding: 10px 12px; margin: 0; }
          h2 { text-align: center; font-size: 18px; margin: 8px 0; font-weight: bold; }
          .line { border-top: 1px dashed #000; margin: 8px 0; }
          table { width:100%; border-collapse: collapse; }
          th,td{ padding:4px 2px; text-align:right; }
          th:first-child,td:first-child{text-align:left;}
          .totales p{ margin:3px 0; font-weight:bold; }
          .foot{ text-align:center; margin-top:10px; }
          .sec h3{ font-size:14px; margin:8px 0 4px; text-align:center;}
        </style></head><body>
          <h2>CIERRE DE CAJA</h2>
          <p>Fecha: ${cierrePayload.fechaHora}</p>
          <p>Usuario: ${cierrePayload.usuarioAdmin} ${isAdmin() ? '(ADMIN - todo el negocio)' : ''}</p>
          <div class="line"></div>
          <table>
            <thead>
              <tr><th>Denom</th><th>Base</th><th>Rec</th><th>Dev</th><th>Neto</th><th>Final</th><th>$ Final</th></tr>
            </thead>
            <tbody>
              ${DENOMS.map(d=>{
                const baseCnt = base?.counts?.[d] || 0;
                const rec = sumRec[d], dev = sumDev[d], net = sumNet[d], fin = finalCounts[d];
                const montoFin = fin * parseInt(d,10);
                return `<tr>
                  <td>${parseInt(d,10).toLocaleString('es-CO')}</td>
                  <td>${baseCnt}</td>
                  <td>${rec}</td>
                  <td>${dev}</td>
                  <td>${net}</td>
                  <td>${fin}</td>
                  <td>${(montoFin).toLocaleString('es-CO',{style:'currency',currency:'COP',maximumFractionDigits:0})}</td>
                </tr>`;
              }).join("")}
            </tbody>
          </table>
          <div class="line"></div>
          <div class="totales">
            <p>Base de Caja: ${fmtMoney(montoBase)} ${base ? `(${base.usuario} - ${base.hora})` : '(no registrada)'}</p>
            <p>Efectivo Recibido Ventas: ${fmtMoney(montoRec)}</p>
            <p>Efectivo Devuelto: ${fmtMoney(montoDev)}</p>
            <p>Neto por Ventas: ${fmtMoney(montoNet)}</p>
            <p>Total Esperado en Caja (Base + Neto): ${fmtMoney(montoFinal)}</p>
          </div>
          <div class="line"></div>
          <div class="sec">
            <h3>Arqueos de Cajero (Hoy)</h3>
            ${ (arqueos && arqueos.length)
              ? `<table><thead><tr><th style="text-align:left;">Usuario</th><th>Hora</th><th>Total</th></tr></thead><tbody>
                  ${arqueos.map(a => `<tr><td style="text-align:left;">${a.usuario||''}</td><td>${a.hora||''}</td><td>${fmtMoney(a.montoReportado||0)}</td></tr>`).join('')}
                 </tbody></table>`
              : `<p style="text-align:center;">Sin arqueos reportados.</p>`
            }
          </div>
          <div class="line"></div>
          <p class="foot">Gracias. â€” SeÃ±or Arepa</p>
          <script>window.print();<\/script>
        </body></html>`;
      const w = window.open("", "_blank", "width=460,height=720"); w.document.write(html); w.document.close(); w.focus();
    };

    /********** IMPRESIONES VENTAS **********/
    window.imprimirUltimaCocinero = () => {
      const u = getSessionUser()?.username;
      const ventas = JSON.parse(localStorage.getItem("ventas") || "[]").filter(v => v?.usuario === u);
      if (ventas.length === 0) return alert("No hay ventas para imprimir.");
      const ultimaVenta = ventas[ventas.length - 1];
      if (!ultimaVenta.pedido || !Array.isArray(ultimaVenta.pedido)) return alert("La Ãºltima venta no tiene productos vÃ¡lidos.");
      const resumen = {}; ultimaVenta.pedido.forEach(p => { resumen[p.nombre] = (resumen[p.nombre] || 0) + 1; });
      const contenido = `
        <!DOCTYPE html><html><head><style>
          body{font-family:monospace;font-size:15px;margin:0;padding:11px;}
          h2{text-align:center;font-size:19px;margin-bottom:11px;}
          .info{margin-bottom:10px;} .info p{margin:2px 0;}
          ul{list-style:none;padding:0;margin:0;} li{padding:4px 0;border-bottom:2px dashed #000;font-size:19px;}
        </style></head><body>
          <h2>ğŸ§¾ PEDIDO A COCINA</h2>
          <div class="info">
            <p style="text-align:center;font-weight:bold;margin:6px 0;">COMANDA #${ultimaVenta.comanda ?? ventas.length}</p>
            <p><strong>Cliente:</strong> ${ultimaVenta.cliente || "Sin nombre"}</p>
            <p><strong>Hora:</strong> ${ultimaVenta.fecha || "Sin hora"}</p>
            <p><strong>Tipo de Pedido:</strong> ${ultimaVenta.tipoPedido || "-"}</p>
            ${ultimaVenta.observaciones ? `<p><strong>Observaciones:</strong> ${ultimaVenta.observaciones}</p>` : ""}
          </div>
          <ul>${Object.entries(resumen).map(([producto, cantidad]) => `<li>${producto} x${cantidad}</li>`).join("")}</ul>
          <p style="text-align:center;margin-top:10px;">ğŸ‘¨â€ğŸ³ Preparar con cuidado</p>
          <script>window.print();<\/script>
        </body></html>`;
      const w = window.open("", "_blank", "width=400,height=600"); w.document.write(contenido); w.document.close(); w.focus();
    };
    window.imprimirUltimaCliente = () => {
      const u = getSessionUser()?.username;
      const ventas = JSON.parse(localStorage.getItem("ventas") || "[]").filter(v => v?.usuario === u);
      if (ventas.length === 0) return alert("No hay ventas para imprimir.");
      const v = ventas[ventas.length - 1]; const obs = v.observaciones || "";
      let contenido = `
        <html><head><title>Recibo Cliente</title><style>
          body{font-family:monospace;font-size:14px;width:58mm;padding:10px 12px;margin:0;line-height:1.5;}
          h2{text-align:center;font-size:19px;margin:14px 0 5px;font-weight:bold;}
          .sub-info{text-align:center;font-size:12px;margin-bottom:10px;line-height:1.3;}
          .line{border-top:1px dashed #000;margin:9px 0;} ul{list-style:none;padding:0;margin:0;} li{margin-bottom:7px;}
          .total{text-align:right;font-weight:bold;margin-top:14px;font-size:16px;} .info p{margin:6px 0;} .info strong{font-weight:bold;}
          p.thanks{text-align:center;margin-top:22px;font-weight:bold;font-size:15px;}
        </style></head><body>
          <h2>SEÃ‘OR AREPA</h2>
          <div class="sub-info">MatrÃ­cula No 289546<br>CALLE 19#25-03 ESQUINA<br>BARRIO SAN JOSÃ‰, ARMENIA</div>
          <div class="line"></div>
          <div class="info">
            <p style="text-align:center;font-weight:bold;margin:6px 0;">RECIBO #${v.comanda ?? ventas.length}</p>
            <p style="text-align:center;font-weight:bold;margin:6px 0;">COMANDA #${v.comanda ?? ventas.length}</p>
            <p><strong>Cliente:</strong> ${v.cliente || "N/A"}</p>
            <p><strong>Fecha:</strong> ${v.fecha}</p>
            <p><strong>Tipo de Pedido:</strong> ${v.tipoPedido || "-"}</p>
            ${obs ? `<p><strong>Observaciones:</strong> ${obs}</p>` : ""}
          </div>
          <div class="line"></div>
          <ul>${(v.pedido||[]).map(p => `<li>${p.nombre} - ${fmtMoney(p.precio)}</li>`).join("")}</ul>
          <div class="line"></div>
          <p class="total">Total: ${fmtMoney(v.total||0)}</p>
          <div class="line"></div>
          <p class="thanks">Â¡Gracias por su compra!</p>
          <script>window.print();<\/script>
        </body></html>`;
      const w = window.open("", "_blank", "width=400,height=600"); w.document.write(contenido); w.document.close(); w.focus();
    };

    window.imprimirVentaCliente = (index) => {
      const items = JSON.parse(localStorage.getItem("ventasTabla") || "[]"); const v = items[index]; if (!v) return alert("Elemento no encontrado.");
      if (v.tipo === 'gasto') return alert("No se puede imprimir recibo para un gasto.");
      let contenido = `
        <html><head><title>Recibo Cliente</title><style>
          body{font-family:monospace;font-size:14px;width:58mm;padding:10px 12px;margin:0;line-height:1.5;}
          h2{text-align:center;font-size:19px;margin:14px 0;font-weight:bold;}
          .line{border-top:1px dashed #000;margin:9px 0;} ul{list-style:none;padding:0;margin:0;} li{margin-bottom:7px;}
          .total{text-align:right;font-weight:bold;margin-top:14px;font-size:16px;} .info p{margin:6px 0;} .info strong{font-weight:bold;}
          p.thanks{text-align:center;margin-top:22px;font-weight:bold;font-size:15px;}
        </style></head><body>
          <h2>SEÃ‘OR AREPA</h2>
          <div class="line"></div>
          <div class="info">
            <p style="text-align:center;font-weight:bold;margin:6px 0;">RECIBO #${v.comanda ?? (index + 1)}</p>
            <p style="text-align:center;font-weight:bold;margin:6px 0;">COMANDA #${v.comanda ?? (index + 1)}</p>
            <p><strong>Cliente:</strong> ${v.cliente || "N/A"}</p>
            <p><strong>Fecha:</strong> ${v.fecha || ''}</p>
            <p><strong>Tipo de Pedido:</strong> ${v.tipoPedido || "-"}</p>
            ${v.observaciones ? `<p><strong>Observaciones:</strong> ${v.observaciones}</p>` : ""}
          </div>
          <div class="line"></div>
          <ul>${(v.pedido||[]).map(p => `<li>${p.nombre} - ${fmtMoney(p.precio)}</li>`).join("")}</ul>
          <div class="line"></div>
          <p class="total">Total: ${fmtMoney(v.total||0)}</p>
          <div class="line"></div>
          <p class="thanks">Â¡Gracias por su compra!</p>
          <script>window.print();<\/script>
        </body></html>`;
      const w = window.open("", "_blank", "width=400,height=600"); w.document.write(contenido); w.document.close(); w.focus();
    };
    window.imprimirVentaCocina = (index) => {
      const items = JSON.parse(localStorage.getItem("ventasTabla") || "[]"); const v = items[index]; if (!v) return alert("Elemento no encontrado.");
      if (v.tipo === 'gasto') return alert("No se puede imprimir comanda para un gasto.");
      const resumen = {}; (v.pedido||[]).forEach(p => { resumen[p.nombre] = (resumen[p.nombre] || 0) + 1; });
      const contenido = `
        <html><head><title>Pedido Cocina</title><style>
          body{font-family:monospace;font-size:15px;margin:0;padding:11px;}
          h2{text-align:center;font-size:19px;margin-bottom:11px;}
          .info{margin-bottom:10px;} .info p{margin:2px 0;}
          ul{list-style:none;padding:0;margin:0;} li{padding:4px 0;border-bottom:2px dashed #000;font-size:19px;}
        </style></head><body>
          <h2>ğŸ§¾ PEDIDO A COCINA</h2>
          <div class="info">
            <p style="text-align:center;font-weight:bold;margin:6px 0;">RECIBO #${v.comanda ?? (index + 1)}</p>
            <p style="text-align:center;font-weight:bold;margin:6px 0;">COMANDA #${v.comanda ?? (index + 1)}</p>
            <p><strong>Cliente:</strong> ${v.cliente || "Sin nombre"}</p>
            <p><strong>Hora:</strong> ${v.fecha || "Sin hora"}</p>
            <p><strong>Tipo de Pedido:</strong> ${v.tipoPedido || "-"}</p>
            ${v.observaciones ? `<p><strong>Observaciones:</strong> ${v.observaciones}</p>` : ""}
          </div>
          <ul>${Object.entries(resumen).map(([producto, cantidad]) => `<li>${producto} x${cantidad}</li>`).join("")}</ul>
          <p style="text-align:center;margin-top:10px;">ğŸ‘¨â€ğŸ³ Preparar con cuidado</p>
          <script>window.print();<\/script>
        </body></html>`;
      const w = window.open("", "_blank", "width=400,height=600"); w.document.write(contenido); w.document.close(); w.focus();
    };

    /********** ADMIN: USUARIOS **********/
    window.addUserFromForm = async (e) => {
      e.preventDefault();
      if(!isAdmin()){ alert("Solo el Administrador puede gestionar usuarios."); return false; }
      const username = document.getElementById('newUsername').value.trim();
      const password = document.getElementById('newPassword').value;
      const role     = document.getElementById('newRole').value;
      if(!username || !password) { alert("Usuario y contraseÃ±a requeridos."); return false; }

      try { await upsertUserProfile(username, role, password); }
      catch(e){ console.warn('crear usuario err:', e); alert("No se pudo crear el usuario en la nube."); return false; }

      const tbody = document.getElementById('usuariosTbody');
      if (tbody) {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td class="p-2 border">${username}</td>
          <td class="p-2 border">${role}</td>
          <td class="p-2 border"><span class="text-xs text-gray-400">â€”</span></td>`;
        tbody.appendChild(row);
      }
      document.getElementById('newUsername').value = "";
      document.getElementById('newPassword').value = "";
      document.getElementById('newRole').value = "cajero";
      alert("Usuario creado en la base de datos.");
      return false;
    };
    window.renderUsersTable = async () => {
      const tbody = document.getElementById('usuariosTbody');
      if(!tbody) return;
      tbody.innerHTML = "";
      try{
        const snap = await getDocs(query(collection(db,'users'), where('businessId','==', getOrInitBusinessId())));
        snap.forEach(docu => {
          const u = docu.data();
          tbody.innerHTML += `
            <tr>
              <td class="p-2 border">${u.username}</td>
              <td class="p-2 border">${u.role}</td>
              <td class="p-2 border"><span class="text-xs text-gray-400">â€”</span></td>
            </tr>`;
        });
      }catch(e){ console.warn('list users err', e); }
    };

    /********** MISC **********/
    window.borrarVentas = () => {
      if(!isAdmin()){ alert("Solo el Administrador puede borrar ventas locales."); return; }
      if(confirm("Â¿Seguro que deseas borrar ventas y gastos locales? (No borra en la nube)")) {
        localStorage.removeItem("ventas");
        localStorage.removeItem("gastos");
        mostrarVentas();
        alert("Historial local borrado.");
      }
    };
    window.generarResumenProductos = () => {
      if(!isAdmin()){ alert("Solo el Administrador puede ver resumen de productos."); return; }
      const ventas = JSON.parse(localStorage.getItem("ventas") || "[]");
      const bid = getOrInitBusinessId();
      const ventasNegocio = ventas.filter(v => !v.businessId || v.businessId===bid);
      const resumen = {};
      ventasNegocio.forEach(v=> (v.pedido||[]).forEach(p=> resumen[p.nombre]=(resumen[p.nombre]||0)+1 ));
      const ul = document.getElementById('listaResumen');
      ul.innerHTML = Object.entries(resumen).map(([n,c])=>`<li>${n}: ${c}</li>`).join('');
      document.getElementById('resumenProductos').classList.remove('hidden');
    };
    window.obtenerSiguienteComanda = () => {
      const key = "ultimoNumeroComanda";
      const ultimo = parseInt(localStorage.getItem(key) || "0", 10);
      const siguiente = ultimo + 1;
      localStorage.setItem(key, String(siguiente));
      return siguiente;
    };

    /********** INIT **********/
    window.onload = async function(){
      const user = getSessionUser();
      if(!user) showLoginModal(); else hideLoginModal();
      applyRoleUI();
      await renderUsersTable();
      try { await mostrarVentas(); } catch(e){ console.warn(e); }
      if(user) autoPromptBaseIfMissing();
    };
  </script>
</body>
</html>
