<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SEÃ‘OR AREPA â€” v6.1 (100% Firestore, realtime ventas)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/exceljs/dist/exceljs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
</head>

<body class="bg-yellow-50 font-sans">
  <!-- NAV -->
  <nav class="bg-yellow-400 p-4 flex justify-between items-center text-white font-bold text-lg">
    <div class="flex items-center space-x-2">
      <img src="imagenes/senora.png" alt="Logo SeÃ±or Arepa" class="w-16 h-16 rounded-full object-cover"
           onerror="this.onerror=null;this.src='imagenes/logo-fallback.png';">
      <span class="text-xl">SEÃ‘OR AREPA</span>
    </div>
    <div class="flex items-center gap-3">
      <span id="baseBadge" class="hidden md:inline text-sm bg-teal-700/80 px-2 py-1 rounded"></span>
      <span id="currentUserBadge" class="hidden md:inline text-sm bg-yellow-700/80 px-2 py-1 rounded"></span>
      <button id="btnLogout" onclick="logout()" class="hidden bg-yellow-700 text-white px-3 py-1 rounded">Salir</button>
    </div>
  </nav>

  <main class="p-6">
    <!-- MENÃš -->
    <h2 class="text-2xl font-bold text-gray-700 mb-4">MenÃº</h2>
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
      <div class="bg-white p-4 rounded-xl shadow-md">
        <h3 class="text-xl font-semibold text-yellow-600 mb-2">Comida</h3>
        <div class="grid grid-cols-2 gap-2">
          <button onclick="agregarProducto('AREPA PAISA',17000)" class="bg-yellow-300 hover:bg-yellow-400 p-2 rounded">âšª PAISA - $17.000</button>
          <button onclick="agregarProducto('AREPA PAISA POLLO',17000)" class="bg-yellow-300 hover:bg-yellow-400 p-2 rounded">âšª PAISA POLLO - $17.000</button>
          <button onclick="agregarProducto('AREPA CHICHARRON',14000)" class="bg-yellow-300 hover:bg-yellow-400 p-2 rounded">âšª CHICHARRON - $14.000</button>
          <button onclick="agregarProducto('AREPA EXTRA QUESILLO',9000)" class="bg-yellow-300 hover:bg-yellow-400 p-2 rounded">âšª EXTRA QUESILLO - $9.000</button>
          <button onclick="agregarProducto('AREPA SEÃ‘OR AREPA',14000)" class="bg-yellow-300 hover:bg-yellow-400 p-2 rounded">âšª SEÃ‘OR AREPA - $14.000</button>
          <button onclick="agregarProducto('AREPA SEÃ‘ORA AREPA',14000)" class="bg-yellow-300 hover:bg-yellow-400 p-2 rounded">âšª SEÃ‘ORA AREPA - $14.000</button>
          <button onclick="agregarProducto('AREPA HAWAIANA',14000)" class="bg-yellow-300 hover:bg-yellow-400 p-2 rounded">âšª HAWAIANA - $14.000</button>
          <button onclick="agregarProducto('AREPA MEGAPAISA',22000)" class="bg-yellow-300 hover:bg-yellow-400 p-2 rounded">âšª MEGAPAISA - $22.000</button>
          <button onclick="agregarProducto('AREPA MIXTA',14000)" class="bg-yellow-300 hover:bg-yellow-400 p-2 rounded">âšª MIXTA - $14.000</button>
          <button onclick="agregarProducto('AREPA RANCHERA',14000)" class="bg-yellow-300 hover:bg-yellow-400 p-2 rounded">âšª RANCHERA - $14.000</button>
          <button onclick="agregarProducto('AREPA SOLO POLLO',15000)" class="bg-yellow-300 hover:bg-yellow-400 p-2 rounded">âšª SOLO POLLO - $15.000</button>
          <button onclick="agregarProducto('AREPA SOLO CARNE',15000)" class="bg-yellow-300 hover:bg-yellow-400 p-2 rounded">âšª SOLO CARNE - $15.000</button>
          <button onclick="agregarProducto('AREPA MEXICANA',15000)" class="bg-yellow-300 hover:bg-yellow-400 p-2 rounded">âšª MEXICANA - $15.000</button>
          <button onclick="agregarProducto('AREPA SOLA',1000)" class="bg-yellow-300 hover:bg-yellow-400 p-2 rounded">âšª AREPA SOLA - $1.000</button>
        </div>
      </div>

      <div class="bg-white p-4 rounded-xl shadow-md">
        <h3 class="text-xl font-semibold text-yellow-600 mb-2">Adiciones</h3>
        <div class="grid grid-cols-2 gap-2">
          <button onclick="agregarProducto('ADICION QUESO EXTRA',5000)" class="bg-yellow-300 hover:bg-yellow-400 p-2 rounded">ğŸ§€ Queso Extra - $5.000</button>
          <button onclick="agregarProducto('ADICION MAIZ TIERNO',3000)" class="bg-yellow-300 hover:bg-yellow-400 p-2 rounded">ğŸŒ½ MAIZ TIERNO - $3.000</button>
          <button onclick="agregarProducto('ADICION PIÃ‘A CALADA',5000)" class="bg-yellow-300 hover:bg-yellow-400 p-2 rounded">ğŸ PIÃ‘A CALADA - $5.000</button>
          <button onclick="agregarProducto('ADICION POLLO',7000)" class="bg-yellow-300 hover:bg-yellow-400 p-2 rounded">ğŸ— POLLO - $7.000</button>
          <button onclick="agregarProducto('ADICION CARNE',7000)" class="bg-yellow-300 hover:bg-yellow-400 p-2 rounded">ğŸ¥© CARNE - $7.000</button>
          <button onclick="agregarProducto('ADICION CHICHARRON',6000)" class="bg-yellow-300 hover:bg-yellow-400 p-2 rounded">ğŸ– CHICHARRON - $6.000</button>
          <button onclick="agregarProducto('ADICION RANCHERA',7000)" class="bg-yellow-300 hover:bg-yellow-400 p-2 rounded">ğŸ”¥ RANCHERA - $7.000</button>
          <button onclick="agregarProducto('ADICION CHORIZO',7000)" class="bg-yellow-300 hover:bg-yellow-400 p-2 rounded">ğŸŒ­ CHORIZO - $7.000</button>
          <button onclick="agregarProducto('ADICION TOCINETA',7000)" class="bg-yellow-300 hover:bg-yellow-400 p-2 rounded">ğŸ¥“ TOCINETA - $7.000</button>
          <button onclick="agregarProducto('ADICION MADURO',3000)" class="bg-yellow-300 hover:bg-yellow-400 p-2 rounded">ğŸŒ MADURO - $3.000</button>
          <button onclick="agregarProducto('ADICION ARMA TU AREPA X5',25000)" class="bg-yellow-300 hover:bg-yellow-400 p-2 rounded">ğŸŒ ARMA TU AREPA - $25.000</button>
        </div>
      </div>

      <div class="bg-white p-4 rounded-xl shadow-md">
        <h3 class="text-xl font-semibold text-yellow-600 mb-2">Bebidas</h3>
        <div class="grid grid-cols-2 gap-2">
          <button onclick="agregarProducto('QUATRO',4000)" class="bg-yellow-300 hover:bg-yellow-400 p-2 rounded">ğŸ‹ QUATRO - $4.000</button>
          <button onclick="agregarProducto('COCA COLA 400 ml',4000)" class="bg-yellow-300 hover:bg-yellow-400 p-2 rounded">ğŸ¥¤ COCA COLA - $4.000</button>
          <button onclick="agregarProducto('COCA COLA 250 ml',3000)" class="bg-yellow-300 hover:bg-yellow-400 p-2 rounded">ğŸ¥¤ COCA COLA - $3.000</button>
          <button onclick="agregarProducto('JUGO HIT 500 ml',4000)" class="bg-yellow-300 hover:bg-yellow-400 p-2 rounded">ğŸ¥¤ JUGO HIT - $4.000</button>
          <button onclick="agregarProducto('SPRITE',4000)" class="bg-yellow-300 hover:bg-yellow-400 p-2 rounded">ğŸ¥¤ SPRITE - $4.000</button>
          <button onclick="agregarProducto('COCA COLA CERO',4000)" class="bg-yellow-300 hover:bg-yellow-400 p-2 rounded">ğŸ¥¤ COCA COLA CERO - $4.000</button>
          <button onclick="agregarProducto('BRISA LIMON',4000)" class="bg-yellow-300 hover:bg-yellow-400 p-2 rounded">ğŸ¥¤ BRISA LIMON - $4.000</button>
          <button onclick="agregarProducto('BRISA MANZANA',4000)" class="bg-yellow-300 hover:bg-yellow-400 p-2 rounded">ğŸ’§ BRISA MANZANA - $4.000</button>
          <button onclick="agregarProducto('MISTER TEA',4000)" class="bg-yellow-300 hover:bg-yellow-400 p-2 rounded">ğŸ¥¤ MISTER TEA - $4.000</button>
          <button onclick="agregarProducto('AGUA CON GAS',4000)" class="bg-yellow-300 hover:bg-yellow-400 p-2 rounded">ğŸ¥¤ AGUA CON GAS - $4.000</button>
          <button onclick="agregarProducto('AGUA SABORISADA',4000)" class="bg-yellow-300 hover:bg-yellow-400 p-2 rounded">ğŸ¥¤ AGUA SABORISADA - $4.000</button>
          <button onclick="agregarProducto('POSTOBON 400 ml',4000)" class="bg-yellow-300 hover:bg-yellow-400 p-2 rounded">ğŸ¥¤ POSTOBON 400 - $4.000</button>
          <button onclick="agregarProducto('POSTOBON 250 ml',3000)" class="bg-yellow-300 hover:bg-yellow-400 p-2 rounded">ğŸ¥¤ POSTOBON 250 - $3.000</button>
          <button onclick="agregarProducto('POSTOBON 1.5',9000)" class="bg-yellow-300 hover:bg-yellow-400 p-2 rounded">ğŸ¥¤ POSTOBON 1.5 - $9.000</button>
          <button onclick="agregarProducto('SODA BRETAÃ‘A',4500)" class="bg-yellow-300 hover:bg-yellow-400 p-2 rounded">ğŸ¥¤ SODA BRETAÃ‘A - $4.500</button>
          <button onclick="agregarProducto('GATORADE',6000)" class="bg-yellow-300 hover:bg-yellow-400 p-2 rounded">ğŸ¥¤ GATORADE - $6.000</button>
          <button onclick="agregarProducto('PREMIO 400 ml',4000)" class="bg-yellow-300 hover:bg-yellow-400 p-2 rounded">ğŸ¥¤ PREMIO 400 ml - $4.000</button>
          <button onclick="agregarProducto('PREMIO 1.5l',9000)" class="bg-yellow-300 hover:bg-yellow-400 p-2 rounded">ğŸ¥¤ PREMIO 1.5l - $9.000</button>
          <button onclick="agregarProducto('QUATRO 1.5L',9000)" class="bg-yellow-300 hover:bg-yellow-400 p-2 rounded">ğŸ¥¤ QUATRO 1.5L - $9.000</button>
          <button onclick="agregarProducto('COCA COLA 1.5L',9000)" class="bg-yellow-300 hover:bg-yellow-400 p-2 rounded">ğŸ¥¤ COCA COLA 1.5L - $9.000</button>
          <button onclick="agregarProducto('JUGO HIT 1.L',7500)" class="bg-yellow-300 hover:bg-yellow-400 p-2 rounded">ğŸ¥¤ JUGO HIT 1.L - $7.500</button>
          <button onclick="agregarProducto('SPRITE 1.5L',9000)" class="bg-yellow-300 hover:bg-yellow-400 p-2 rounded">ğŸ¥¤ SPRITE 1.5L - $9.000</button>
          <button onclick="agregarProducto('COCA COLA ZERO 1.5L',9000)" class="bg-yellow-300 hover:bg-yellow-400 p-2 rounded">ğŸ¥¤ COCA COLA ZERO 1.5L - $9.000</button>
          <button onclick="agregarProducto('AGUA',3000)" class="bg-yellow-300 hover:bg-yellow-400 p-2 rounded">ğŸ¥¤ AGUA - $3.000</button>
          <button onclick="agregarProducto('MILO CALIENTE',6000)" class="bg-yellow-300 hover:bg-yellow-400 p-2 rounded">ğŸ¥› MILO CALIENTE - $6.000</button>
          <button onclick="agregarProducto('CAFE CON LECHE',5000)" class="bg-yellow-300 hover:bg-yellow-400 p-2 rounded">â˜•ğŸ¥› CAFE CON LECHE - $5.000</button>
          <button onclick="agregarProducto('TINTO',4000)" class="bg-yellow-300 hover:bg-yellow-400 p-2 rounded">â˜• TINTO - $4.000</button>
          <button onclick="agregarProducto('CERVEZA',6000)" class="bg-yellow-300 hover:bg-yellow-400 p-2 rounded">ğŸº CERVEZA - $6.000</button>
        </div>
      </div>
    </div>

    <!-- Pedido -->
    <div class="mt-6 bg-white p-4 rounded-xl shadow-md">
      <h3 class="text-lg font-semibold mb-4 border-b pb-2">ğŸ›’ Pedido Actual</h3>
      <ul id="listaPedido" class="list-disc pl-5 text-gray-700 space-y-1"></ul>
      <p id="total" class="mt-4 font-bold text-lg text-gray-800">Total: $0</p>
    </div>

    <!-- Cliente / pago -->
    <div class="mt-4 flex flex-col md:flex-row gap-4">
      <input id="cliente" class="flex-1 p-2 border border-yellow-300 rounded" placeholder="Nombre del Cliente" />
      <input id="observaciones" class="flex-1 p-2 border border-yellow-300 rounded" placeholder="Observaciones" />
      <select id="formaPago" class="flex-1 p-2 border border-yellow-300 rounded"
              onchange="if(this.value==='Efectivo'){abrirModalEfectivoRecibido();}">
        <option value="">Seleccione forma de pago</option>
        <option value="Efectivo">Efectivo</option>
        <option value="QR SeÃ±ora Arepa">QR SeÃ±ora Arepa</option>
        <option value="QR SeÃ±or Arepa">QR SeÃ±or Arepa</option>
        <option value="Nequi">Nequi</option>
        <option value="Daviplata">Daviplata</option>
      </select>
    </div>

    <!-- Tipo de pedido -->
    <div class="mt-4">
      <label class="block text-sm text-gray-700">Tipo de Pedido</label>
      <select id="tipoPedido" class="mt-1 p-2 border rounded w-full">
        <option value="">Selecciona</option>
        <option value="AquÃ­">AquÃ­</option>
        <option value="Para llevar">Para llevar</option>
        <option value="Domicilio">Domicilio</option>
      </select>
    </div>

    <!-- Panel efectivo recibido -->
    <div class="mt-4">
      <button type="button" class="text-sm text-yellow-700 underline" onclick="abrirModalEfectivoRecibido()">ğŸ’µ Abrir panel de efectivo recibido</button>
      <p id="ef_total" class="mt-1 text-sm text-gray-600"></p>
    </div>

    <!-- Acciones -->
    <div class="mt-6 flex flex-wrap gap-2">
      <button onclick="guardarVenta()" class="bg-green-500 hover:bg-green-600 text-white p-2 rounded">ğŸ’¾ Guardar Venta</button>
      <button onclick="imprimirUltimaCocinero()" class="bg-blue-500 hover:bg-blue-600 text-white p-2 rounded">ğŸ–¨ï¸ Imprimir Cocina</button>
      <button onclick="imprimirUltimaCliente()" class="bg-purple-500 hover:bg-purple-600 text-white p-2 rounded">ğŸ§¾ Imprimir Recibo Cliente</button>
      <button onclick="abrirModalBaseCaja()" class="bg-teal-600 hover:bg-teal-700 text-white p-2 rounded">ğŸ“¦ Base de Caja</button>
      <button onclick="abrirModalGasto()" class="bg-rose-600 hover:bg-rose-700 text-white p-2 rounded">ğŸ’¸ Compras / Pagos</button>
      <button onclick="exportarVentasExcelConEstilo()" class="bg-green-600 hover:bg-green-700 text-white p-2 rounded">ğŸ“Š Exportar Excel</button>
      <button onclick="generarResumenProductos()" class="bg-indigo-500 hover:bg-indigo-600 text-white p-2 rounded">ğŸ“Š Resumen Productos</button>
      <button onclick="cierreDeCaja()" class="bg-amber-600 hover:bg-amber-700 text-white p-2 rounded">ğŸ’° Cierre de Caja</button>
    </div>

    <!-- Ventas -->
    <div class="mt-8 bg-white p-4 rounded-xl shadow-md">
      <div class="flex flex-col md:flex-row md:items-end md:justify-between gap-3">
        <h3 class="text-lg font-semibold">Ventas Guardadas</h3>
        <div class="flex flex-col md:flex-row gap-2 md:items-center">
          <input id="filtroCliente" oninput="renderVentasFromCache()" placeholder="ğŸ” Filtrar por cliente..." class="w-full md:w-64 p-2 border border-yellow-300 rounded" />
          <div id="filtroUsuarioWrap" class="hidden md:flex items-center gap-2">
            <label class="text-sm text-gray-700">Usuario:</label>
            <select id="filtroUsuario" class="p-2 border rounded" onchange="renderVentasFromCache()">
              <option value="__todos__">Todos</option>
            </select>
          </div>
        </div>
      </div>
      <div class="mt-3">
        <table class="min-w-full text-left border">
          <thead>
            <tr class="bg-yellow-200">
              <th class="p-2 border">#</th>
              <th class="p-2 border">Fecha</th>
              <th class="p-2 border">Usuario</th>
              <th class="p-2 border">Cliente</th>
              <th class="p-2 border">Forma</th>
              <th class="p-2 border">Tipo</th>
              <th class="p-2 border">Productos</th>
              <th class="p-2 border">Total</th>
              <th id="thAcciones" class="p-2 border">Acciones</th>
            </tr>
          </thead>
          <tbody id="ventasGuardadas" class="text-sm text-gray-800"></tbody>
        </table>
      </div>
    </div>

    <!-- Resumen -->
    <div id="resumenProductos" class="mt-8 bg-white p-4 rounded-xl shadow-md hidden">
      <h3 class="text-lg font-semibold mb-2">Resumen de Productos Vendidos</h3>
      <ul id="listaResumen" class="list-disc pl-5 text-gray-700 space-y-1"></ul>
    </div>

    <!-- Admin: Usuarios -->
    <div id="adminUsuariosSection" class="hidden mt-8 bg-white p-4 rounded-xl shadow-md">
      <h3 class="text-lg font-semibold mb-2">GestiÃ³n de Usuarios</h3>
      <form onsubmit="return addUserFromForm(event)" class="grid grid-cols-1 md:grid-cols-5 gap-2 mb-3">
        <input id="newUsername" class="p-2 border rounded" placeholder="Usuario" required>
        <input id="newPassword" type="password" class="p-2 border rounded" placeholder="ContraseÃ±a" required>
        <select id="newRole" class="p-2 border rounded">
          <option value="cajero">Cajero</option>
          <option value="admin">Admin</option>
        </select>
        <input id="newFullname" class="p-2 border rounded" placeholder="Nombre (opcional)">
        <button class="bg-green-600 hover:bg-green-700 text-white px-3 py-2 rounded">â• Agregar/Actualizar</button>
      </form>
      <table class="min-w-full text-left border">
        <thead>
          <tr class="bg-yellow-200">
            <th class="p-2 border">Usuario</th>
            <th class="p-2 border">Rol</th>
            <th class="p-2 border">Nombre</th>
            <th class="p-2 border">Editado</th>
          </tr>
        </thead>
        <tbody id="usuariosTbody"></tbody>
      </table>
    </div>
  </main>

  <!-- MODALES (idÃ©nticos a versiÃ³n anterior) -->
  <!-- Vuelto -->
  <div id="modalVuelto" class="fixed inset-0 bg-black/50 hidden z-50 items-center justify-center">
    <div class="bg-white rounded-lg shadow-xl w-[90%] max-w-5xl flex flex-col md:flex-row overflow-hidden">
      <div class="w-full md:w-1/3 bg-yellow-50 p-6 border-r border-gray-200">
        <h2 class="text-2xl font-bold text-yellow-700 mb-2">ğŸ’µ Registrar Vuelto</h2>
        <p id="vueltoRequeridoTexto" class="text-sm text-gray-700"></p>
        <div class="mt-4">
          <div class="flex items-center justify-between rounded-lg bg-white px-3 py-2 shadow">
            <span class="text-sm font-medium">Total devuelto</span>
            <span id="totalDevueltoLabel" class="text-xl font-bold text-yellow-800">$0</span>
          </div>
        </div>
        <div class="mt-4">
          <div class="flex gap-2 justify-end">
            <button onclick="confirmarVuelto()" class="bg-teal-600 hover:bg-teal-700 text-white px-4 py-2 rounded shadow">Confirmar</button>
            <button onclick="cerrarModalVuelto()" class="bg-gray-400 hover:bg-gray-500 text-white px-4 py-2 rounded shadow">Cerrar</button>
          </div>
        </div>
      </div>
      <div class="w-full md:w-2/3 bg-white p-4 overflow-y-auto max-h-[80vh]">
        <div id="tablaVueltoUI" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-3"></div>
      </div>
    </div>
  </div>

  <!-- Base de Caja -->
  <div id="modalBaseCaja" class="fixed inset-0 bg-black/50 z-50 hidden items-center justify-center">
    <div class="bg-white rounded-lg shadow-xl w-[90%] max-w-5xl flex flex-col md:flex-row overflow-hidden">
      <div class="w-full md:w-1/3 bg-yellow-50 p-6 flex flex-col justify-between border-r border-gray-200">
        <div>
          <h2 class="text-2xl font-bold text-yellow-700 mb-2">ğŸ“¦ Base de Caja (Hoy)</h2>
          <p class="text-sm text-gray-600 mb-4">Suma y resta billetes.</p>
          <div class="flex items-center justify-between rounded-lg bg-white px-3 py-2 shadow">
            <span class="text-sm font-medium">Total base del dÃ­a</span>
            <span id="baseTotalValor" class="text-xl font-bold text-yellow-800">$0</span>
          </div>
        </div>
        <div class="mt-4">
          <p id="baseTotalTexto" class="text-sm text-gray-700 mt-3"></p>
          <div class="flex gap-2 justify-end mt-4">
            <button id="btnGuardarBase" onclick="confirmarBaseCaja()" class="bg-teal-600 hover:bg-teal-700 text-white px-4 py-2 rounded shadow">Guardar</button>
            <button onclick="cerrarModalBaseCaja()" class="bg-gray-400 hover:bg-gray-500 text-white px-4 py-2 rounded shadow">Cerrar</button>
          </div>
          <p id="baseMetaInfo" class="text-xs text-gray-500 mt-3"></p>
        </div>
      </div>
      <div class="w-full md:w-2/3 bg-white p-4 overflow-y-auto max-h-[80vh]">
        <div id="baseDenomsContainer" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-3"></div>
      </div>
    </div>
  </div>

  <!-- Efectivo recibido -->
  <div id="modalEfectivo" class="fixed inset-0 bg-black/50 z-50 hidden items-center justify-center">
    <div class="bg-white rounded-lg shadow-xl w-[90%] max-w-5xl flex flex-col md:flex-row overflow-hidden">
      <div class="w-full md:w-1/3 bg-yellow-50 p-6 flex flex-col justify-between border-r border-gray-200">
        <div>
          <h2 class="text-2xl font-bold text-yellow-700 mb-2">ğŸ’µ Efectivo recibido</h2>
          <div class="flex items-center justify-between rounded-lg bg-white px-3 py-2 shadow">
            <span class="text-sm font-medium">Total recibido</span>
            <span id="efTotalValor" class="text-xl font-bold text-yellow-800">$0</span>
          </div>
        </div>
        <div class="mt-4">
          <div class="flex gap-2 justify-end mt-4">
            <button onclick="confirmarEfectivoRecibido()" class="bg-teal-600 hover:bg-teal-700 text-white px-4 py-2 rounded shadow">Usar</button>
            <button onclick="cerrarModalEfectivoRecibido()" class="bg-gray-400 hover:bg-gray-500 text-white px-4 py-2 rounded shadow">Cerrar</button>
          </div>
        </div>
      </div>
      <div class="w-full md:w-2/3 bg-white p-4 overflow-y-auto max-h-[80vh]">
        <div id="efDenomsContainer" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-3"></div>
      </div>
    </div>
  </div>

  <!-- Compras / Pagos -->
  <div id="modalGasto" class="fixed inset-0 bg-black/50 z-50 hidden items-center justify-center">
    <div class="bg-white rounded-lg shadow-xl w-[90%] max-w-5xl flex flex-col md:flex-row overflow-hidden">
      <div class="w-full md:w-1/3 bg-rose-50 p-6 flex flex-col justify-between border-r border-gray-200">
        <div>
          <h2 class="text-2xl font-bold text-rose-700 mb-2">ğŸ’¸ Compras / Pagos</h2>
          <label class="block text-sm text-gray-700 mb-1">DescripciÃ³n</label>
          <input id="gastoDescripcion" class="w-full border rounded px-2 py-1 mb-3" placeholder="Proveedor, insumo, etc.">
          <label class="block text-sm text-gray-700 mb-1">Total del Gasto</label>
          <input id="gastoTotal" type="number" min="0" class="w-full border rounded px-2 py-1" placeholder="0">
          <div class="mt-4">
            <div class="flex items-center justify-between rounded-lg bg-white px-3 py-2 shadow">
              <span class="text-sm font-medium">Se pagÃ³ en efectivo</span>
              <span id="gastoEfectivoValor" class="text-xl font-bold text-rose-800">$0</span>
            </div>
          </div>
        </div>
        <div class="mt-4">
          <div class="flex gap-2 justify-end mt-4">
            <button onclick="confirmarGasto()" class="bg-rose-600 hover:bg-rose-700 text-white px-4 py-2 rounded shadow">Registrar</button>
            <button onclick="cerrarModalGasto()" class="bg-gray-400 hover:bg-gray-500 text-white px-4 py-2 rounded shadow">Cerrar</button>
          </div>
        </div>
      </div>
      <div class="w-full md:w-2/3 bg-white p-4 overflow-y-auto max-h-[80vh]">
        <p class="text-sm text-gray-600 mb-2">Indica con quÃ© billetes se pagÃ³:</p>
        <div id="gastoDenomsContainer" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-3"></div>
      </div>
    </div>
  </div>

  <!-- Login -->
  <div id="loginModal" class="fixed inset-0 bg-black/50 z-50 hidden items-center justify-center">
    <div class="bg-white rounded-lg p-6 w-96">
      <h2 class="text-xl font-bold mb-4">Iniciar sesiÃ³n</h2>
      <form onsubmit="return loginFromModal(event)" class="space-y-3">
        <input id="loginUser" class="p-2 border rounded w-full" placeholder="Usuario" required>
        <input id="loginPass" type="password" class="p-2 border rounded w-full" placeholder="ContraseÃ±a" required>
        <button class="w-full bg-yellow-600 hover:bg-yellow-700 text-white px-4 py-2 rounded">Entrar</button>
      </form>
      <p class="text-xs text-gray-500 mt-3">Iniciales: <b>admin/admin123</b> â€” <b>cajero/caja123</b></p>
    </div>
  </div>

  <!-- APP -->
  <script type="module">
    /********** FIREBASE **********/
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
    import {
      initializeFirestore,
      memoryLocalCache,
      collection, addDoc, getDocs, getDoc, query, where, orderBy, serverTimestamp, doc, setDoc, runTransaction, limit, deleteDoc,
      onSnapshot
    } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDwCV5NmixGyEZ_bdAMTU5wqDua_BbANSo",
      authDomain: "senorarepa-689cc.firebaseapp.com",
      projectId: "senorarepa-689cc",
      storageBucket: "senorarepa-689cc.firebasestorage.app",
      messagingSenderId: "499118544254",
      appId: "1:499118544254:web:cdf7b22c12bb760d184f2f"
    };
    const BUSINESS_ID = "senor-arepa";
    const app = initializeApp(firebaseConfig);
    const db = initializeFirestore(app, { localCache: memoryLocalCache() }); // sin persistencia

    /********** ESTADO UI **********/
    const DENOMS = ["100000","50000","20000","10000","5000","2000","1000","500","200","100","50","20"];
    let pedido = [];
    let total = 0;
    let ventaTemporal = null;
    let comandaEnEdicion = null;

    // Ventas en memoria + subcripciÃ³n realtime
    let allVentasCache = [];
    let currentVentas = [];
    let unsubscribeVentas = null;

    const efCounts = {}, baseCounts = {}, gastoCounts = {};

    /********** UTILES **********/
    const fmtMoney = n => {
      try { return n.toLocaleString('es-CO',{style:'currency',currency:'COP',maximumFractionDigits:0}); }
      catch { return `$${(Math.round(n)).toString().replace(/\B(?=(\d{3})+(?!\d))/g,'.')}`; }
    };
    const todayStr = () => {
      const d = new Date(), y = d.getFullYear(), m = String(d.getMonth()+1).padStart(2,'0'), day = String(d.getDate()).padStart(2,'0');
      return `${y}-${m}-${day}`;
    };

    /********** SESIÃ“N **********/
    let sessionUser = null;
    const isAdmin = () => sessionUser?.role === 'admin';
    const showLoginModal = () => { const m = document.getElementById('loginModal'); m.classList.remove('hidden'); m.classList.add('flex'); };
    const hideLoginModal = () => { const m = document.getElementById('loginModal'); m.classList.add('hidden'); m.classList.remove('flex'); };
    window.logout = () => {
      if (unsubscribeVentas) { unsubscribeVentas(); unsubscribeVentas=null; }
      sessionUser = null;
      allVentasCache = [];
      renderVentasFromCache();
      applyRoleUI();
      showLoginModal();
    };

    /********** USUARIOS **********/
    async function upsertUser({username, role, password, fullname=''}) {
      await setDoc(doc(db,'users',username), {
        username, role, password, fullname,
        businessId: BUSINESS_ID, updatedAt: serverTimestamp(), createdAt: serverTimestamp()
      }, { merge: true });
    }
    async function ensureDefaultUsers(){
      await upsertUser({username:'admin', role:'admin', password:'admin123', fullname:'Administrador'});
      await upsertUser({username:'cajero', role:'cajero', password:'caja123', fullname:'Cajero'});
    }
    async function fetchAllUsers() {
      const snap = await getDocs(query(collection(db,'users'), where('businessId','==',BUSINESS_ID)));
      return snap.docs.map(d => ({ id: d.id, ...d.data() }));
    }
    async function syncUsersUI(){
      if(!isAdmin()) return;
      const users = await fetchAllUsers();
      // Filtro de usuario en ventas
      const sel = document.getElementById('filtroUsuario');
      if (sel) {
        const current = sel.value || '__todos__';
        sel.innerHTML = `<option value="__todos__">Todos</option>` + users.map(u=>`<option value="${u.username}">${u.username}</option>`).join('');
        sel.value = current;
      }
      // Tabla admin
      const tbody = document.getElementById('usuariosTbody');
      if (tbody) {
        users.sort((a,b)=>a.username.localeCompare(b.username));
        tbody.innerHTML = users.map(u=>`
          <tr>
            <td class="p-2 border">${u.username}</td>
            <td class="p-2 border">${u.role}</td>
            <td class="p-2 border">${u.fullname||''}</td>
            <td class="p-2 border">${u.updatedAt?.seconds? new Date(u.updatedAt.seconds*1000).toLocaleString():''}</td>
          </tr>
        `).join('');
      }
    }
    window.addUserFromForm = async (e) => {
      e.preventDefault();
      if(!isAdmin()) return alert("Solo Admin.");
      const username = document.getElementById('newUsername').value.trim();
      const password = document.getElementById('newPassword').value;
      const role = document.getElementById('newRole').value;
      const fullname = document.getElementById('newFullname').value.trim();
      if(!username || !password) return alert("Usuario y contraseÃ±a requeridos.");
      await upsertUser({username, role, password, fullname});
      document.getElementById('newUsername').value = "";
      document.getElementById('newPassword').value = "";
      document.getElementById('newRole').value = "cajero";
      document.getElementById('newFullname').value = "";
      await syncUsersUI();
      alert("Usuario guardado.");
      return false;
    };
    window.loginFromModal = async (e) => {
      e.preventDefault();
      const u = document.getElementById('loginUser').value.trim();
      const p = document.getElementById('loginPass').value;
      const ds = await getDoc(doc(db,'users',u));
      if(!ds.exists()) return alert("Usuario no encontrado.");
      const data = ds.data();
      if (data.businessId !== BUSINESS_ID) return alert("Usuario no pertenece a este negocio.");
      if ((data.password||'') !== p) return alert("ContraseÃ±a incorrecta.");
      sessionUser = { username: data.username, role: data.role, fullname: data.fullname||'' };
      hideLoginModal();
      await applyRoleUI();
      await autoPromptBaseIfMissing();
      subscribeVentasRealtime(); // <â€”â€” activar realtime justo al iniciar sesiÃ³n
      return false;
    };

    /********** UI **********/
    function toggleDisplay(id, show){
      const el = document.getElementById(id);
      if(!el) return;
      if(show) el.classList.remove('hidden'); else el.classList.add('hidden');
    }
    async function applyRoleUI(){
      const badge = document.getElementById('currentUserBadge');
      const btnLogout = document.getElementById('btnLogout');
      if(sessionUser){
        badge.textContent = `${sessionUser.username} (${sessionUser.role})`;
        badge.classList.remove('hidden');
        btnLogout.classList.remove('hidden');
      }else{
        badge.classList.add('hidden');
        btnLogout.classList.add('hidden');
      }
      const admin = isAdmin();
      toggleDisplay('adminUsuariosSection', admin);
      const wrap = document.getElementById('filtroUsuarioWrap');
      if (wrap) wrap.classList.toggle('hidden', !admin);
      await syncUsersUI();
      await updateBaseBadge();
    }

    /********** COMANDA (contador atÃ³mico) **********/
    async function getNextComanda(){
      const ref = doc(db,'counters', BUSINESS_ID);
      let newValue = 0;
      await runTransaction(db, async (tx)=>{
        const snap = await tx.get(ref);
        const curr = snap.exists()? (snap.data().comanda||0) : 0;
        newValue = curr + 1;
        tx.set(ref, { businessId: BUSINESS_ID, comanda: newValue, updatedAt: serverTimestamp() }, { merge: true });
      });
      return newValue;
    }

    /********** BASE DE CAJA **********/
    function buildMoneyButton(containerId, stateMap, totalLabelId) {
      const cont = document.getElementById(containerId);
      cont.innerHTML = '';
      DENOMS.forEach(denom => {
        if (typeof stateMap[denom] !== 'number') stateMap[denom] = 0;
        const card = document.createElement('div');
        card.className = 'relative flex flex-col items-center justify-center border rounded-xl p-3 shadow-sm bg-white';
        const btnAdd = document.createElement('button');
        btnAdd.className = 'w-full text-center bg-yellow-300 hover:bg-yellow-400 text-gray-800 font-semibold rounded-lg py-3';
        btnAdd.textContent = fmtMoney(parseInt(denom,10));
        const btnSub = document.createElement('button');
        btnSub.type='button'; btnSub.title='Restar 1'; btnSub.textContent='â–';
        btnSub.className = 'absolute top-1 right-1 text-xs px-2 py-1 rounded-md border bg-white hover:bg-gray-50';
        const counter = document.createElement('span');
        counter.className = 'mt-2 text-sm font-medium text-gray-700';
        counter.textContent = `x${stateMap[denom]}`;
        btnAdd.addEventListener('click',()=>{ stateMap[denom]=(stateMap[denom]||0)+1; counter.textContent=`x${stateMap[denom]}`; updateMoneyTotal(stateMap,totalLabelId);});
        btnSub.addEventListener('click',(e)=>{ e.stopPropagation(); stateMap[denom]=Math.max(0,(stateMap[denom]||0)-1); counter.textContent=`x${stateMap[denom]}`; updateMoneyTotal(stateMap,totalLabelId);});
        card.append(btnAdd,btnSub,counter);
        cont.appendChild(card);
      });
      updateMoneyTotal(stateMap,totalLabelId);
    }
    function updateMoneyTotal(stateMap, totalLabelId){
      let tot=0; DENOMS.forEach(d=> tot+=(stateMap[d]||0)*parseInt(d,10));
      const lab = document.getElementById(totalLabelId); if(lab) lab.textContent = fmtMoney(tot);
      if (totalLabelId==='efTotalValor'){ const lbl=document.getElementById('ef_total'); if(lbl) lbl.textContent = `Efectivo ingresado: ${fmtMoney(tot)}`; }
    }
    async function getBaseDocToday(){
      const id = `${BUSINESS_ID}_${todayStr()}`;
      const ds = await getDoc(doc(db,'bases', id));
      return ds.exists()? ds.data() : null;
    }
    async function updateBaseBadge(){
      const base = await getBaseDocToday();
      const el = document.getElementById('baseBadge');
      if(!el) return;
      if(base){ el.textContent = `Base hoy: ${fmtMoney(base.monto)} (${base.usuario})`; el.classList.remove('hidden'); }
      else { el.textContent = `Base no registrada`; el.classList.remove('hidden'); }
    }
    window.abrirModalBaseCaja = async () => {
      const m = document.getElementById('modalBaseCaja');
      m.classList.remove('hidden'); m.classList.add('flex');
      const base = await getBaseDocToday();
      DENOMS.forEach(d=> baseCounts[d] = base?.counts?.[d] || 0);
      buildMoneyButton('baseDenomsContainer', baseCounts, 'baseTotalValor');
      document.getElementById('baseTotalTexto').textContent = `Total base: ${fmtMoney(Object.entries(baseCounts).reduce((s,[d,c])=>s+parseInt(d,10)*(c||0),0))}`;
      document.getElementById('baseMetaInfo').textContent = base ? `Registrada por ${base.usuario} â€” ${base.hora}` : `No hay base registrada para hoy (${todayStr()}).`;
    };
    window.cerrarModalBaseCaja = () => {
      const m = document.getElementById('modalBaseCaja'); m.classList.add('hidden'); m.classList.remove('flex');
    };
    window.confirmarBaseCaja = async () => {
      if(!sessionUser) return showLoginModal();
      const id = `${BUSINESS_ID}_${todayStr()}`;
      const prev = await getDoc(doc(db,'bases',id));
      if (prev.exists() && !isAdmin()) return alert("La base de hoy ya fue registrada. Solo Admin puede actualizarla.");
      let monto=0; DENOMS.forEach(d=> monto+=(baseCounts[d]||0)*parseInt(d,10));
      const payload = {
        businessId: BUSINESS_ID, fecha: todayStr(), counts: baseCounts, monto,
        usuario: sessionUser.username, hora: new Date().toLocaleString(),
        updatedAt: serverTimestamp(), createdAt: serverTimestamp()
      };
      await setDoc(doc(db,'bases',id), payload, { merge:true });
      await updateBaseBadge();
      cerrarModalBaseCaja();
      alert("Base guardada.");
    };

    /********** EFECTIVO / VUELTO **********/
    window.abrirModalEfectivoRecibido = () => {
      const m = document.getElementById('modalEfectivo'); m.classList.remove('hidden'); m.classList.add('flex');
      DENOMS.forEach(d=> { if(typeof efCounts[d]!=='number') efCounts[d]=0; });
      buildMoneyButton('efDenomsContainer', efCounts, 'efTotalValor');
    };
    window.cerrarModalEfectivoRecibido = () => {
      const m = document.getElementById('modalEfectivo'); m.classList.add('hidden'); m.classList.remove('flex');
    };
    window.confirmarEfectivoRecibido = () => { window.cerrarModalEfectivoRecibido(); };

    window.abrirModalVuelto = (vuelto) => {
      const m = document.getElementById('modalVuelto'); m.classList.remove('hidden'); m.classList.add('flex');
      document.getElementById('vueltoRequeridoTexto').textContent = `Vuelto requerido: ${fmtMoney(vuelto)}`;
      const box = document.getElementById('tablaVueltoUI'); box.innerHTML='';
      const temp = {}; DENOMS.forEach(d=> temp[d]=0);
      DENOMS.forEach(denom=>{
        const card = document.createElement('div');
        card.className='relative flex flex-col items-center justify-center border rounded-xl p-3 shadow-sm bg-white';
        const add=document.createElement('button'); add.className='w-full text-center bg-yellow-300 hover:bg-yellow-400 text-gray-800 font-semibold rounded-lg py-3'; add.textContent=fmtMoney(parseInt(denom,10));
        const sub=document.createElement('button'); sub.type='button'; sub.title='Restar 1'; sub.textContent='â–'; sub.className='absolute top-1 right-1 text-xs px-2 py-1 rounded-md border bg-white hover:bg-gray-50';
        const cnt=document.createElement('span'); cnt.className='mt-2 text-sm font-medium text-gray-700'; cnt.textContent='x0';
        const recalc=()=>{ let s=0; DENOMS.forEach(d=> s+=(temp[d]||0)*parseInt(d,10)); document.getElementById('totalDevueltoLabel').textContent = fmtMoney(s); };
        add.onclick=()=>{ temp[denom]=(temp[denom]||0)+1; cnt.textContent=`x${temp[denom]}`; recalc(); };
        sub.onclick=(e)=>{ e.stopPropagation(); temp[denom]=Math.max(0,(temp[denom]||0)-1); cnt.textContent=`x${temp[denom]}`; recalc(); };
        card.dataset.denom=denom;
        card.append(add,sub,cnt);
        box.appendChild(card);
      });
      document.getElementById('totalDevueltoLabel').textContent = fmtMoney(0);
      (document.getElementById('modalVuelto')).dataset.temp="1";
    };
    window.cerrarModalVuelto = () => {
      const m = document.getElementById('modalVuelto'); m.classList.add('hidden'); m.classList.remove('flex'); ventaTemporal=null;
    };
    window.confirmarVuelto = async () => {
      if(!ventaTemporal) return alert('No hay venta en proceso.');
      const box = document.getElementById('tablaVueltoUI');
      const billetesDevueltos = {}; let totalDev=0;
      Array.from(box.children).forEach(card=>{
        const denom = card.dataset.denom;
        const count = parseInt((card.querySelector('span')?.textContent||'x0').replace('x',''),10)||0;
        billetesDevueltos[denom]=count; totalDev += count*parseInt(denom,10);
      });
      if (totalDev !== ventaTemporal.vuelto) return alert(`El total ingresado (${fmtMoney(totalDev)}) no coincide con el vuelto requerido (${fmtMoney(ventaTemporal.vuelto)}).`);
      const venta = { ...ventaTemporal, billetesDevueltos, comanda: comandaEnEdicion ?? await getNextComanda() };
      await guardarVentaEnFirestore(venta);
      comandaEnEdicion = null; ventaTemporal=null;
      cerrarModalVuelto();
      alert("Venta guardada.");
      limpiarPedido();
      // no hace falta llamar mostrarVentas(); el listener realtime actualizarÃ¡ la tabla
      document.getElementById("resumenProductos").classList.add("hidden");
    };

    /********** GASTOS **********/
    window.abrirModalGasto = () => {
      const m = document.getElementById('modalGasto'); m.classList.remove('hidden'); m.classList.add('flex');
      DENOMS.forEach(d=> gastoCounts[d]=0);
      document.getElementById('gastoDescripcion').value=''; document.getElementById('gastoTotal').value='';
      buildMoneyButton('gastoDenomsContainer', gastoCounts, 'gastoEfectivoValor');
    };
    window.cerrarModalGasto = () => {
      const m = document.getElementById('modalGasto'); m.classList.add('hidden'); m.classList.remove('flex');
    };
    async function guardarGastoEnFirestore(payload){
      await addDoc(collection(db,'gastos'), { ...payload, createdAt: serverTimestamp() });
      await addDoc(collection(db,'users',payload.usuario,'gastos'), { ...payload, createdAt: serverTimestamp() });
    }
    window.confirmarGasto = async () => {
      if(!sessionUser) return showLoginModal();
      const desc = document.getElementById('gastoDescripcion').value.trim();
      const totalG = parseInt(document.getElementById('gastoTotal').value||'0',10)||0;
      if(!desc) return alert('Escribe la descripciÃ³n.'); if(totalG<=0) return alert('Escribe el total del gasto.');
      let pagadoEfectivo=0; DENOMS.forEach(d=> pagadoEfectivo += (gastoCounts[d]||0)*parseInt(d,10));

      const idBase = `${BUSINESS_ID}_${todayStr()}`;
      const ds = await getDoc(doc(db,'bases',idBase));
      if(!ds.exists()) return alert("Primero registra la base de caja.");
      const base = ds.data();
      const nuevos = {};
      DENOMS.forEach(d=>{
        const curr = base.counts?.[d] || 0;
        const resta = gastoCounts[d] || 0;
        nuevos[d] = Math.max(0, curr - resta);
      });
      const nuevoMonto = DENOMS.reduce((s,d)=> s + (nuevos[d]||0)*parseInt(d,10), 0);
      await setDoc(doc(db,'bases',idBase), { ...base, counts: nuevos, monto: nuevoMonto, updatedAt: serverTimestamp() }, { merge:true });

      const payload = {
        businessId: BUSINESS_ID, descripcion: desc, total: totalG, pagadoEfectivo,
        billetesUsados: structuredClone(gastoCounts), fecha: new Date().toLocaleString(),
        usuario: sessionUser.username, tipo: 'gasto'
      };
      await guardarGastoEnFirestore(payload);
      await updateBaseBadge();
      cerrarModalGasto();
      alert('Gasto registrado.');
    };

    /********** PEDIDO **********/
    window.agregarProducto = (nombre, precio) => { pedido.push({nombre, precio}); actualizarPedidoUI(); };
    window.quitarProducto = (idx) => { if(idx>=0 && idx<pedido.length){ pedido.splice(idx,1); actualizarPedidoUI(); } };
    function actualizarPedidoUI(){
      const ul = document.getElementById('listaPedido'); ul.innerHTML='';
      pedido.forEach((p,i)=>{
        const li=document.createElement('li');
        li.innerHTML = `${p.nombre} - ${fmtMoney(p.precio)} <button onclick="quitarProducto(${i})" class="text-red-600 ml-2">âŒ</button>`;
        ul.appendChild(li);
      });
      total = pedido.reduce((s,p)=>s+p.precio,0);
      document.getElementById('total').textContent = `Total: ${fmtMoney(total)}`;
    }
    window.limpiarPedido = () => {
      pedido = []; total=0; actualizarPedidoUI();
      ['cliente','formaPago','tipoPedido','observaciones'].forEach(id=>{ const el=document.getElementById(id); if(el) el.value=''; });
      document.getElementById('ef_total').textContent='';
      DENOMS.forEach(d=> efCounts[d]=0);
    };

    /********** VENTAS (CRUD + REALTIME) **********/
    async function guardarVentaEnFirestore(venta){
      await addDoc(collection(db,'ventas'), { ...venta, createdAt: serverTimestamp() });
      await addDoc(collection(db,'users', venta.usuario, 'ventas'), { ...venta, createdAt: serverTimestamp() });
    }

    function getEfectivoRecibidoFromState(){
      const billetesRecibidos={}; let totalRec=0;
      DENOMS.forEach(d=>{ const c=efCounts[d]||0; billetesRecibidos[d]=c; totalRec += c*parseInt(d,10); });
      const el = document.getElementById('ef_total'); if(el) el.textContent = `Efectivo ingresado: ${fmtMoney(totalRec)}`;
      return { billetesRecibidos, totalRecibido: totalRec };
    }

    window.guardarVenta = async () => {
      if(!sessionUser) return showLoginModal();
      const cliente = document.getElementById('cliente').value.trim();
      const formaPago = document.getElementById('formaPago').value;
      const tipoPedido = document.getElementById('tipoPedido').value;
      const observaciones = document.getElementById('observaciones').value.trim();
      if(pedido.length===0) return alert("Agrega productos.");
      if(!cliente) return alert("Ingresa el cliente.");
      if(!formaPago) return alert("Selecciona la forma de pago.");
      if(!tipoPedido) return alert("Selecciona el tipo de pedido.");

      const { billetesRecibidos, totalRecibido } = getEfectivoRecibidoFromState();
      let vuelto = 0;
      if(formaPago==='Efectivo'){
        if(totalRecibido < total) return alert(`Efectivo insuficiente. Faltan ${fmtMoney(total-totalRecibido)}.`);
        vuelto = totalRecibido - total;
      } else {
        DENOMS.forEach(d=> billetesRecibidos[d]=0);
      }

      const baseVenta = {
        businessId: BUSINESS_ID, cliente, formaPago, tipoPedido, observaciones,
        pedido: [...pedido], total, fecha: new Date().toLocaleString(),
        billetesRecibidos, billetesDevueltos: {}, efectivoRecibido: totalRecibido,
        usuario: sessionUser.username, tipo: 'venta'
      };

      if(formaPago==='Efectivo' && vuelto>0){
        ventaTemporal = { ...baseVenta, vuelto, comanda: null };
        abrirModalVuelto(vuelto); return;
      }

      const venta = { ...baseVenta, comanda: comandaEnEdicion ?? await getNextComanda() };
      await guardarVentaEnFirestore(venta);
      comandaEnEdicion=null;
      alert("Venta guardada.");
      limpiarPedido();
      // La tabla se actualiza sola por onSnapshot
      document.getElementById("resumenProductos").classList.add("hidden");
    };

    // SuscripciÃ³n realtime a ventas (filtrada por rol)
    function subscribeVentasRealtime(){
      if (unsubscribeVentas) { unsubscribeVentas(); unsubscribeVentas=null; }
      let qy = query(collection(db,'ventas'), where('businessId','==',BUSINESS_ID), orderBy('createdAt','desc'));
      if(!isAdmin()){
        qy = query(collection(db,'ventas'),
          where('businessId','==',BUSINESS_ID),
          where('usuario','==',sessionUser.username),
          orderBy('createdAt','desc')
        );
      }
      unsubscribeVentas = onSnapshot(qy, (snap)=>{
        allVentasCache = snap.docs.map(d=> ({ id:d.id, ...d.data() }));
        renderVentasFromCache();
      }, (err)=> {
        console.warn('onSnapshot ventas error:', err);
      });
    }

    // Render con filtros sin re-consultar
    function renderVentasFromCache(){
      const cont = document.getElementById('ventasGuardadas'); if(!cont) return;
      cont.innerHTML='';
      const filtroCliente = (document.getElementById('filtroCliente')?.value||'').toLowerCase();
      let ventas = [...allVentasCache];

      if (isAdmin()) {
        const sel = document.getElementById('filtroUsuario');
        const v = sel ? (sel.value || '__todos__') : '__todos__';
        if (v !== '__todos__') ventas = ventas.filter(x => (x.usuario||'').toLowerCase() === v.toLowerCase());
      }

      if (filtroCliente) ventas = ventas.filter(v => (v.cliente||'').toLowerCase().includes(filtroCliente));

      currentVentas = ventas;

      ventas.forEach((v,i)=>{
        const resumen = {};
        (v.pedido||[]).forEach(p=> resumen[p.nombre]=(resumen[p.nombre]||0)+1 );
        const productosResumen = Object.entries(resumen).map(([n,c])=>`${n}: ${c}`).join("<br>");
        cont.innerHTML += `
          <tr>
            <td class="border p-1">${v.comanda ?? (i+1)}</td>
            <td class="border p-1 whitespace-nowrap">${v.fecha||''}</td>
            <td class="border p-1">${v.usuario||''}</td>
            <td class="border p-1">${v.cliente||''}</td>
            <td class="border p-1">${v.formaPago||''}</td>
            <td class="border p-1">${v.tipoPedido||''}</td>
            <td class="border p-1">${productosResumen}</td>
            <td class="border p-1">${fmtMoney(v.total||0)}</td>
            <td class="border p-1 space-x-1">
              <button onclick="imprimirVentaCliente(${i})" class="bg-purple-500 text-white px-2 py-1 rounded text-xs">ğŸ§¾ Cliente</button>
              <button onclick="imprimirVentaCocina(${i})" class="bg-blue-500 text-white px-2 py-1 rounded text-xs">ğŸ‘¨â€ğŸ³ Cocina</button>
              ${isAdmin()? `<button onclick="editarVenta(${i})" class="bg-yellow-600 text-white px-2 py-1 rounded text-xs">ğŸ“ Editar</button>
                            <button onclick="eliminarVenta(${i})" class="bg-red-600 text-white px-2 py-1 rounded text-xs">ğŸ—‘ï¸</button>`:''}
            </td>
          </tr>`;
      });
    }

    window.eliminarVenta = async (i) => {
      if(!isAdmin()) return alert("Solo Admin.");
      const v = currentVentas[i]; if(!v?.id) return;
      await deleteDoc(doc(db,'ventas', v.id));
      // onSnapshot actualizarÃ¡ la UI automÃ¡ticamente
    };

    window.editarVenta = (i) => {
      if(!isAdmin()) return alert("Solo Admin.");
      const v = currentVentas[i]; if(!v) return;
      document.getElementById('cliente').value = v.cliente||'';
      document.getElementById('formaPago').value = v.formaPago||'';
      document.getElementById('tipoPedido').value = v.tipoPedido||'';
      document.getElementById('observaciones').value = v.observaciones||'';
      pedido = [...(v.pedido||[])]; total = v.total||0; actualizarPedidoUI();
      comandaEnEdicion = v.comanda ?? null;
      alert("Venta cargada para ediciÃ³n. Guarda para crear reemplazo con misma comanda.");
    };

    /********** EXPORTAR EXCEL (Ventas + Gastos) **********/
    async function cargarGastosHoy(){
      const snap = await getDocs(query(collection(db,'gastos'), where('businessId','==',BUSINESS_ID), orderBy('createdAt','desc')));
      const hoy = todayStr();
      return snap.docs.map(d=>({id:d.id,...d.data()})).filter(g => (g.fecha||'').includes(hoy));
    }
    window.exportarVentasExcelConEstilo = async () => {
      if(!isAdmin()) return alert("Solo Admin.");
      let ventas = [...allVentasCache];
      // aplica filtro usuario (admin)
      if (isAdmin()) {
        const sel = document.getElementById('filtroUsuario');
        if (sel && sel.value && sel.value !== '__todos__') {
          ventas = ventas.filter(x => (x.usuario||'').toLowerCase() === sel.value.toLowerCase());
        }
      }
      if(ventas.length===0) return alert("No hay ventas.");
      const gastos = await cargarGastosHoy();

      const wb = new ExcelJS.Workbook();
      const sh = wb.addWorksheet("Ventas del DÃ­a");
      const headers = ["#","Fecha","Usuario","Cliente","Forma de Pago","Tipo de Pedido","Producto","Precio (COP)","Total Venta (COP)"];
      sh.addRow(headers);
      let totalGlobal=0; const conteo={};
      ventas.forEach((v,i)=>{
        totalGlobal += v.total||0;
        (v.pedido||[]).forEach(p=>{
          sh.addRow([v.comanda ?? (i+1), v.fecha, v.usuario, v.cliente, v.formaPago, v.tipoPedido, p.nombre, p.precio, v.total||0]);
          conteo[p.nombre]=(conteo[p.nombre]||0)+1;
        });
      });
      sh.getRow(1).eachCell(c=>{ c.fill={type:"pattern",pattern:"solid",fgColor:{argb:"FF1F4E78"}}; c.font={color:{argb:"FFFFFFFF"},bold:true}; c.alignment={vertical:"middle",horizontal:"center"}; c.border={top:{style:"thin"},bottom:{style:"thin"},left:{style:"thin"},right:{style:"thin"}}; });
      for(let r=2;r<=sh.rowCount;r++){ const row=sh.getRow(r); const even=r%2===0; row.eachCell(c=>{c.fill={type:"pattern",pattern:"solid",fgColor:{argb: even?"FFF2F2F2":"FFFFFFFF"}}; c.border={top:{style:"thin"},bottom:{style:"thin"},left:{style:"thin"},right:{style:"thin"}};}); row.getCell(8).numFmt='"$"#,##0'; row.getCell(9).numFmt='"$"#,##0';}
      sh.addRow([]); sh.addRow(["","","","","","","TOTAL DEL DÃA:","",totalGlobal]).getCell(9).numFmt='"$"#,##0';
      let prodMas="",max=0; Object.entries(conteo).forEach(([n,c])=>{ if(c>max){max=c;prodMas=n;}});
      sh.addRow(["","","","","","","Producto mÃ¡s vendido:","",`${prodMas} (${max})`]);

      // â€”â€” GASTOS debajo â€”â€”
      sh.addRow([]); sh.addRow(["GASTOS (HOY)"]);
      const gHead = ["Fecha/Hora","Usuario","DescripciÃ³n","Pagado Efectivo (COP)","Total (COP)"];
      sh.addRow(gHead);
      gastos.forEach(g=>{
        const row = sh.addRow([g.fecha||"", g.usuario||"", g.descripcion||"", g.pagadoEfectivo||0, g.total||0]);
        row.getCell(4).numFmt='"$"#,##0'; row.getCell(5).numFmt='"$"#,##0';
      });
      sh.columns.forEach(c=> c.width=18);

      const buffer = await wb.xlsx.writeBuffer();
      saveAs(new Blob([buffer],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"}),
             `Ventas_y_Gastos_${todayStr()}.xlsx`);
    };

    /********** CIERRE DE CAJA **********/
    window.cierreDeCaja = async () => {
      const ventas = [...allVentasCache]; // datos en vivo
      const base = await getBaseDocToday();
      if(!base) return alert("No hay base registrada hoy.");

      const sumRec={}, sumDev={}, sumNet={}, finalCounts={};
      let montoRec=0, montoDev=0, montoNet=0, montoBase=0, montoFinal=0;
      DENOMS.forEach(d=>{sumRec[d]=0; sumDev[d]=0; sumNet[d]=0; finalCounts[d]=0;});
      ventas.forEach(v=>{
        DENOMS.forEach(d=>{
          sumRec[d]+= (v.billetesRecibidos?.[d]||0);
          sumDev[d]+= (v.billetesDevueltos?.[d]||0);
        });
      });
      DENOMS.forEach(d=>{
        sumNet[d]= sumRec[d]-sumDev[d];
        const baseCnt = base?.counts?.[d] || 0;
        finalCounts[d] = baseCnt + sumNet[d];
        montoRec  += sumRec[d]*parseInt(d,10);
        montoDev  += sumDev[d]*parseInt(d,10);
        montoNet  += sumNet[d]*parseInt(d,10);
        montoBase += baseCnt*parseInt(d,10);
        montoFinal+= finalCounts[d]*parseInt(d,10);
      });

      const html = `
      <html><head><title>Cierre de Caja</title><style>
        body{font-family:monospace;font-size:12px;width:76mm;padding:10px 12px;margin:0;}
        h2{text-align:center;font-size:18px;margin:8px 0;font-weight:bold;}
        .line{border-top:1px dashed #000;margin:8px 0;} table{width:100%;border-collapse:collapse;}
        th,td{padding:4px 2px;text-align:right;} th:first-child,td:first-child{text-align:left;}
        .totales p{margin:3px 0;font-weight:bold;} .foot{text-align:center;margin-top:10px;}
      </style></head><body>
        <h2>CIERRE DE CAJA</h2>
        <p>Fecha: ${new Date().toLocaleString()}</p>
        <div class="line"></div>
        <table>
          <thead><tr><th>Denom</th><th>Base</th><th>Rec</th><th>Dev</th><th>Neto</th><th>Final</th><th>$ Final</th></tr></thead>
          <tbody>
            ${DENOMS.map(d=>{
              const baseCnt = base?.counts?.[d] || 0;
              const rec=sumRec[d], dev=sumDev[d], net=sumNet[d], fin=finalCounts[d];
              const montoFin = fin*parseInt(d,10);
              return `<tr>
                <td>${parseInt(d,10).toLocaleString('es-CO')}</td>
                <td>${baseCnt}</td><td>${rec}</td><td>${dev}</td><td>${net}</td><td>${fin}</td><td>${fmtMoney(montoFin)}</td>
              </tr>`;
            }).join("")}
          </tbody>
        </table>
        <div class="line"></div>
        <div class="totales">
          <p>Base: ${fmtMoney(montoBase)} (${base.usuario} - ${base.hora})</p>
          <p>Recibido Ventas: ${fmtMoney(montoRec)}</p>
          <p>Devuelto: ${fmtMoney(montoDev)}</p>
          <p>Neto por Ventas: ${fmtMoney(montoNet)}</p>
          <p>Total Esperado en Caja: ${fmtMoney(montoFinal)}</p>
        </div>
        <div class="line"></div>
        <p class="foot">Gracias. â€” SeÃ±or Arepa</p>
        <script>window.print();<\/script>
      </body></html>`;
      const w = window.open("", "_blank", "width=460,height=720"); w.document.write(html); w.document.close(); w.focus();
    };

    /********** IMPRESIÃ“N **********/
    async function obtenerUltimaVenta(){
      // Para admin: Ãºltima del negocio; para cajero: Ãºltima suya
      let ventas = allVentasCache;
      if (!isAdmin()) ventas = ventas.filter(v => (v.usuario||'') === (sessionUser?.username||''));
      return ventas[0] || null; // ya estÃ¡n ordenadas desc por createdAt
    }
    window.imprimirUltimaCocinero = async () => {
      const v = await obtenerUltimaVenta();
      if(!v) return alert("No hay ventas para imprimir.");
      const resumen={}; (v.pedido||[]).forEach(p=> resumen[p.nombre]=(resumen[p.nombre]||0)+1 );
      const contenido = `
      <!DOCTYPE html><html><head><style>
        body{font-family:monospace;font-size:15px;margin:0;padding:11px;}
        h2{text-align:center;font-size:19px;margin-bottom:11px;}
        .info{margin-bottom:10px;} .info p{margin:2px 0;}
        ul{list-style:none;padding:0;margin:0;} li{padding:4px 0;border-bottom:2px dashed #000;font-size:19px;}
      </style></head><body>
        <h2>ğŸ§¾ PEDIDO A COCINA</h2>
        <div class="info">
          <p style="text-align:center;font-weight:bold;margin:6px 0;">COMANDA #${v.comanda}</p>
          <p><strong>Cliente:</strong> ${v.cliente||"Sin nombre"}</p>
          <p><strong>Hora:</strong> ${v.fecha||"Sin hora"}</p>
          <p><strong>Tipo de Pedido:</strong> ${v.tipoPedido||"-"}</p>
          ${v.observaciones? `<p><strong>Obs:</strong> ${v.observaciones}</p>`:""}
        </div>
        <ul>${Object.entries(resumen).map(([producto,cantidad])=>`<li>${producto} x${cantidad}</li>`).join("")}</ul>
        <p style="text-align:center;margin-top:10px;">ğŸ‘¨â€ğŸ³ Preparar con cuidado</p>
        <script>window.print();<\/script>
      </body></html>`;
      const w=window.open("","_blank","width=400,height=600"); w.document.write(contenido); w.document.close(); w.focus();
    };
    window.imprimirUltimaCliente = async () => {
      const v = await obtenerUltimaVenta();
      if(!v) return alert("No hay ventas para imprimir.");
      const contenido = `
      <html><head><title>Recibo Cliente</title><style>
        body{font-family:monospace;font-size:14px;width:58mm;padding:10px 12px;margin:0;line-height:1.5;}
        h2{text-align:center;font-size:19px;margin:14px 0 5px;font-weight:bold;}
        .sub-info{text-align:center;font-size:12px;margin-bottom:10px;line-height:1.3;}
        .line{border-top:1px dashed #000;margin:9px 0;} ul{list-style:none;padding:0;margin:0;} li{margin-bottom:7px;}
        .total{text-align:right;font-weight:bold;margin-top:14px;font-size:16px;} .info p{margin:6px 0;}
      </style></head><body>
        <h2>SEÃ‘OR AREPA</h2>
        <div class="sub-info">MatrÃ­cula No 289546<br>CALLE 19#25-03 ESQUINA<br>BARRIO SAN JOSÃ‰, ARMENIA</div>
        <div class="line"></div>
        <div class="info">
          <p style="text-align:center;font-weight:bold;margin:6px 0;">RECIBO #${v.comanda}</p>
          <p style="text-align:center;font-weight:bold;margin:6px 0;">COMANDA #${v.comanda}</p>
          <p><strong>Cliente:</strong> ${v.cliente||"N/A"}</p>
          <p><strong>Fecha:</strong> ${v.fecha||""}</p>
          <p><strong>Tipo de Pedido:</strong> ${v.tipoPedido||"-"}</p>
          ${v.observaciones? `<p><strong>Obs:</strong> ${v.observaciones}</p>`:""}
        </div>
        <div class="line"></div>
        <ul>${(v.pedido||[]).map(p=> `<li>${p.nombre} - ${fmtMoney(p.precio)}</li>`).join("")}</ul>
        <div class="line"></div>
        <p class="total">Total: ${fmtMoney(v.total||0)}</p>
        <div class="line"></div>
        <p style="text-align:center;margin-top:22px;font-weight:bold;font-size:15px;">Â¡Gracias por su compra!</p>
        <script>window.print();<\/script>
      </body></html>`;
      const w=window.open("","_blank","width=400,height=600"); w.document.write(contenido); w.document.close(); w.focus();
    };
    window.imprimirVentaCliente = (i) => {
      const v = currentVentas[i]; if(!v) return alert("Venta no encontrada.");
      const contenido = `
      <html><head><title>Recibo Cliente</title><style>
        body{font-family:monospace;font-size:14px;width:58mm;padding:10px 12px;margin:0;line-height:1.5;}
        h2{text-align:center;font-size:19px;margin:14px 0;font-weight:bold;}
        .line{border-top:1px dashed #000;margin:9px 0;} ul{list-style:none;padding:0;margin:0;} li{margin-bottom:7px;}
        .total{text-align:right;font-weight:bold;margin-top:14px;font-size:16px;}
      </style></head><body>
        <h2>SEÃ‘OR AREPA</h2>
        <div class="line"></div>
        <div class="info">
          <p style="text-align:center;font-weight:bold;margin:6px 0;">RECIBO #${v.comanda}</p>
          <p style="text-align:center;font-weight:bold;margin:6px 0;">COMANDA #${v.comanda}</p>
          <p><strong>Cliente:</strong> ${v.cliente||"N/A"}</p>
          <p><strong>Fecha:</strong> ${v.fecha||""}</p>
          <p><strong>Tipo de Pedido:</strong> ${v.tipoPedido||"-"}</p>
          ${v.observaciones? `<p><strong>Obs:</strong> ${v.observaciones}</p>`:""}
        </div>
        <div class="line"></div>
        <ul>${(v.pedido||[]).map(p=> `<li>${p.nombre} - ${fmtMoney(p.precio)}</li>`).join("")}</ul>
        <div class="line"></div>
        <p class="total">Total: ${fmtMoney(v.total||0)}</p>
        <div class="line"></div>
        <script>window.print();<\/script>
      </body></html>`;
      const w=window.open("","_blank","width=400,height=600"); w.document.write(contenido); w.document.close(); w.focus();
    };

    /********** RESUMEN **********/
    window.generarResumenProductos = async () => {
      if(!isAdmin()) return alert("Solo Admin.");
      const ventas = [...allVentasCache];
      const resumen={};
      ventas.forEach(v=> (v.pedido||[]).forEach(p=> resumen[p.nombre]=(resumen[p.nombre]||0)+1 ));
      const ul=document.getElementById('listaResumen');
      ul.innerHTML = Object.entries(resumen).map(([n,c])=> `<li>${n}: ${c}</li>`).join('');
      document.getElementById('resumenProductos').classList.remove('hidden');
    };

    /********** INIT **********/
    window.addEventListener('load', async ()=>{
      await ensureDefaultUsers();
      showLoginModal();
      await applyRoleUI();
    });

    // Helpers faltantes
    async function autoPromptBaseIfMissing(){
      const base = await getBaseDocToday();
      if(!base){ abrirModalBaseCaja(); }
    }
  </script>
</body>
</html>
